!function(){"use strict";const e="MessageList",t="FolderList",s="MessageView",i="Settings",r={Normal:0,FileIsTooBig:1,FilePartiallyUploaded:3,NoFileUploaded:4,MissingTempFolder:6,OnSavingFile:7,FileType:98,Unknown:99},a=-2,o=-1,n=1,l=0,c={RequestError:1,RequestAborted:2,RequestTimeout:3,InvalidToken:101,AuthError:102,ConnectionError:104,DomainNotAllowed:109,AccountNotAllowed:110,ContactsSyncError:140,CantGetMessageList:201,CantGetMessage:202,CantDeleteMessage:203,CantMoveMessage:204,CantCopyMessage:205,CantSaveMessage:301,CantSendMessage:302,InvalidRecipients:303,CantSaveFilters:351,CantGetFilters:352,CantActivateFiltersScript:353,CantDeleteFiltersScript:354,CantCreateFolder:400,CantRenameFolder:401,CantDeleteFolder:402,CantSubscribeFolder:403,CantUnsubscribeFolder:404,CantDeleteNonEmptyFolder:405,DomainAlreadyExists:601,DemoSendMessageError:750,DemoAccountError:751,AccountAlreadyExists:801,AccountDoesNotExist:802,AccountSwitchFailed:803,MailServerError:901,ClientViewError:902,InvalidInputArgument:903,JsonFalse:950,JsonParse:952,UnknownNotification:998,UnknownError:999,CantInstallPackage:701,CantDeletePackage:702,InvalidPluginPackage:703,UnsupportedPluginPackage:704,CantSavePluginSettings:705},d=Array.isArray,h=e=>d(e)&&e.length,u=e=>"function"==typeof e,p=e=>null!=e?""+e:"",m=(e,t)=>Object.values(e).forEach(t),g=(e,t)=>Object.entries(e).forEach((([e,s])=>t(e,s))),f=(e,t=0)=>(e=parseInt(e,10),isNaN(e)||!isFinite(e)?t:e),b=(e,t)=>t&&void 0!==t.disabled&&e?.classList.toggle("disabled",e.disabled=t.disabled),y=e=>btoa(unescape(encodeURIComponent(e))),v=e=>(e=>y(JSON.stringify(e)))(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),S=(e,t)=>Object.keys(e).find((s=>e[s]===t));let w="all";const E="Menu",k=document,C=k.documentElement.classList,A=e=>k.getElementById(e),T=A("rl-app"),F=rl.settings,M=F.get,L=e=>e&&!!(M("Capa")||{})[e],P=[],I=ko.observable(!1).extend({rateLimit:0}),x=ko.observable(!1),N=()=>x(!x()),D=(e,t)=>{let s=k.createElement(e);return t&&Object.entries(t).forEach((([e,t])=>s.setAttribute(e,t))),s},R=(e,t,s)=>dispatchEvent(new CustomEvent(e,{detail:t,cancelable:!!s})),O=e=>{e.preventDefault(),e.stopPropagation()},_=()=>k.activeElement?.matches("input,textarea"),U=(...e)=>shortcuts.add(...e),V=(e,t,s,i)=>U(e,t,s,(e=>!!_()||i(e))),q=(e,t,s,i)=>t.forEach((t=>e.addEventListener(t,s,i))),B=(e,t)=>Object.entries(t).forEach((([t,s])=>e.addEventListener(t,s))),H=ko.observable("all"),K=e=>{if(!e)return w;E!==e&&(w=e,I()&&(e=E)),H(e),shortcuts.setScope(e)};I.subscribe((e=>{e?K(E):E===shortcuts.getScope()&&K(w)})),x.subscribe((e=>C.toggle("rl-left-panel-disabled",e)));const G=k.location.pathname.replace(/\/+$/,"")+"/",j="#/",W=()=>rl.adminArea()&&!F.app("adminHostUse"),$=()=>G+"?"+(W()?F.app("adminPath"):""),J="&q[]=",z=(e,t)=>G+"?/Raw/"+J+"/0/"+(e?e+"/"+(t?J+"/"+t:""):""),Y=(e,t)=>z("Download",e),Z=e=>G+"?/ProxyExternal/"+btoa(e.replace(/ /g,"%20")).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),X=e=>$()+"/"+e+"/"+J+"/0/",Q=e=>F.app("webVersionPath")+"static/"+e,ee=e=>{if(e.endsWith("@nextcloud"))return e=e.slice(0,e.length-10).trim(),parent.OC.webroot+"/themes/"+encodeURI(e)+"/snappymail/preview.png";let t="webVersionPath";return e.endsWith("@custom")&&(e=e.slice(0,e.length-7).trim(),t="webPath"),F.app(t)+"themes/"+encodeURI(e)+"/images/preview.png"},te=(e="")=>"#/settings"+(e?"/"+e:""),se=(e,t,s,i,r)=>{let a=["#/mailbox"];return e&&a.push(e+(i?"~"+i:"")),r?a.push("m"+r):(1<(t=f(t,1))&&a.push("p"+t),s&&a.push(encodeURI(s))),a.join("/")},ie={language:ko.observable(""),languages:ko.observableArray(),userLanguage:ko.observable(""),hourCycle:ko.observable(""),populate:function(){const e=F.app("languages");this.languages(d(e)?e:[]),this.language(M("language")),this.userLanguage(M("userLanguage")),this.hourCycle(M("hourCycle"))}};let re={};const ae=()=>{if(rl.I18N)return re=rl.I18N,rl.I18N=null,k.documentElement.dir=re.LANG_DIR,1},oe=e=>e.replace(/([a-z])([A-Z])/g,"$1_$2").toUpperCase(),ne=e=>{let t=S(c,e);return t?re.NOTIFICATIONS[oe(t).replace("_NOTIFICATION","_ERROR")]:""},le=e=>de(Math.round((e.getTime()-Date.now())/1e3)),ce=ko.observable(!1),de=e=>{let t="second",s=[[60,"minute"],[3600,"hour"],[86400,"day"],[2628e3,"month"],[31536e3,"year"]],i=5,r=Math.abs(e);for(;i--;)if(s[i][0]<=r){e=Math.round(e/s[i][0]),t=s[i][1];break}if(Intl.RelativeTimeFormat){return new Intl.RelativeTimeFormat(k.documentElement.lang).format(e,t)}r=Math.abs(e);let a=rl.relativeTime.long[t][0>e?"past":"future"];return(a[rl.relativeTime.plural(r)]||a).replace("{0}",r)},he=(e,t,s)=>{let i=null==s?e:s,r=e.split("/");return re[r[0]]&&r[1]&&(i=re[r[0]][r[1]]||i),t&&g(t,((e,t)=>{i=i.replace("%"+e+"%",t)})),i},ue=e=>setTimeout((()=>e.querySelectorAll("[data-i18n]").forEach((e=>{const t=e.dataset.i18n;if("["===t[0])switch(t.slice(1,6)){case"html]":e.innerHTML=he(t.slice(6));break;case"place":e.placeholder=he(t.slice(13));break;case"title":e.title=he(t.slice(7))}else e.textContent=he(t)}))),1),pe=(e,t)=>{const s=Date.now(),i=0<e?Math.min(s,1e3*e):0===e?s:0;if(31536e6<i){const e=new Date(i),r=ie.hourCycle();switch(t){case"FROMNOW":return le(e);case"AUTO":{if(144e5>=s-i)return le(e);const t=new Date,a=t.setHours(0,0,0,0);return i>a-864e5?he(i>a?"MESSAGE_LIST/TODAY_AT":"MESSAGE_LIST/YESTERDAY_AT",{TIME:e.format("LT",0,r)}):e.format(t.getFullYear()===e.getFullYear()?{day:"2-digit",month:"short",hour:"numeric",minute:"numeric"}:{dateStyle:"medium",timeStyle:"short"},0,r)}case"FULL":return e.format("LLL",0,r);default:return e.format(t,0,r)}}return""},me=(e,t)=>{try{t?e.dateTime=new Date(1e3*t).toISOString():t=Date.parse(e.dateTime)/1e3;let s=e.dataset.momentFormat;s&&(e.textContent=pe(t,s),"FULL"!==s&&"FROMNOW"!==s&&(e.title=pe(t,"FULL")))}catch(e){}},ge=(e,t)=>{e?.(),e&&ce.subscribe(e),t&&ce.subscribe(t)},fe=(e,t="",s=0)=>(e=f(e),c.ClientViewError===e&&t?t:ne(e)||ne(f(s))||""),be=e=>{let t=S(r,parseInt(e,10));return he("UPLOAD/ERROR_"+(t?oe(t):"UNKNOWN"))},ye=(e,t)=>new Promise(((s,i)=>{const r=D("script");r.onload=()=>{ae()&&(ue(k),ce(!ce())),r.remove(),s()},r.onerror=()=>i(new Error("Language "+e+" failed")),r.src=G+"?/Lang/0/"+(t?"Admin":"App")+"/"+encodeURI(e)+"/"+F.app("version")+"/",k.head.append(r)})),ve=(e,t=!1)=>he("LANGS_NAMES"+(!0===t?"_EN":"")+"/"+e,null,e);ae();const Se=(e,t)=>t?setTimeout((()=>e.setAttribute("data-rainloopErrorTip",t)),100):e.removeAttribute("data-rainloopErrorTip"),we=e=>ko.computed(e,{pure:!0}),Ee=(e,t)=>g(t,((t,s)=>e[t]||(e[t]=ko.observable(s)))),ke=(e,t)=>g(t,((t,s)=>e[t]=we(s))),Ce=(e,t)=>g(t,((t,s)=>e[t].subscribe(s))),Ae=e=>u(e?.dispose)&&e.dispose(),Te=(e,t,s,i,r)=>{let a=t=>{e==t.key&&s().call(r)};t.addEventListener("keydown",a),ko.utils.domNodeDisposal.addDisposeCallback(t,(()=>t.removeEventListener("keydown",a)))},Fe=e=>((e=ko.observableArray(e)).subscribe((e=>e.forEach((e=>"deleted"===e.status&&null==e.moved&&e.value.onDestroy?.()))),e,"arrayChange"),e);Object.assign(ko.bindingHandlers,{tooltipErrorTip:{init:(e,t)=>{k.addEventListener("click",(()=>{let s=t();ko.isObservable(s)&&!ko.isComputed(s)&&s(""),Se(e)}))},update:(e,t)=>{let s=ko.unwrap(t());s=u(s)?s():s,Se(e,s)}},onEnter:{init:(e,t,s,i)=>Te("Enter",e,t,0,i)},onEsc:{init:(e,t,s,i)=>Te("Escape",e,t,0,i)},onSpace:{init:(e,t,s,i)=>Te(" ",e,t,0,i)},i18nUpdate:{update:(e,t)=>{ko.unwrap(t()),ue(e)}},title:{update:(e,t)=>e.title=ko.unwrap(t())},command:{init:(e,t,s,i,r)=>{const a=t();if(!a||!a.canExecute)throw new Error("Value should be a command");ko.bindingHandlers["FORM"==e.nodeName?"submit":"click"].init(e,t,s,i,r)},update:(e,t)=>{const s=e.classList;let i=!t().canExecute();s.toggle("disabled",i),e.matches("INPUT,TEXTAREA,BUTTON")&&(e.disabled=i)}},saveTrigger:{init:e=>{let t=e;e.matches("input,select,textarea")&&(e.classList.add("settings-save-trigger-input"),e.after(e.saveTriggerIcon=t=D("span"))),t.classList.add("settings-save-trigger")},update:(e,t)=>{const s=parseInt(ko.unwrap(t()),10);let i=(e.saveTriggerIcon||e).classList;e.saveTriggerIcon&&(i.toggle("saving",s===a),i.toggle("success",s===n),i.toggle("error",s===l)),i=e.classList,i.toggle("success",s===n),i.toggle("error",s===l)}}}),ko.extenders.toggleSubscribeProperty=(e,t)=>{const s=t[1];return s&&(e.subscribe((e=>e?.[s]?.(!1)),t[0],"beforeChange"),e.subscribe((e=>e?.[s]?.(!0)),t[0])),e},ko.extenders.falseTimeout=(e,t)=>(e.subscribe((()=>e(!1)).debounce(parseInt(t,10)||0)),e),ko.observable.fn.askDeleteHelper=function(){return this.extend({falseTimeout:3e3,toggleSubscribeProperty:[this,"askDelete"]})};const Me={Inbox:1,Sent:2,Drafts:3,Junk:4,Trash:5,Archive:6},Le="/private/vendor/kolab/folder-type",Pe="/shared/vendor/kolab/folder-type",Ie={Empty:0,Reply:1,ReplyAll:2,Forward:3,ForwardAsAttachment:4,Draft:5,EditAsNew:6},xe=0,Ne=1,De=2,Re=3;let Oe=0;const _e=matchMedia("(max-width: 799px)"),Ue={theme:ko.observable(""),themes:ko.observableArray(),userBackgroundName:ko.observable(""),userBackgroundHash:ko.observable(""),fontSansSerif:ko.observable(""),fontSerif:ko.observable(""),fontMono:ko.observable(""),isMobile:ko.observable(!1)},Ve=()=>{const e=M("Theme"),t=F.app("themes");Ue.themes(d(t)?t:[]),Ue.theme(e),qe(e),Ue.isMobile()||(Ue.userBackgroundName(M("userBackgroundName")),Ue.userBackgroundHash(M("userBackgroundHash"))),Ue.fontSansSerif(M("fontSansSerif")),Ue.fontSerif(M("fontSerif")),Ue.fontMono(M("fontMono")),x(Ue.isMobile())},qe=(e,t=(()=>0))=>{const s=A("app-theme-style"),i=()=>{Oe=setTimeout((()=>t(o)),1e3)},r=G+"?/Css/0/User/-/"+encodeURI(e)+"/-/"+Date.now()+"/Hash/-/Json/";s.dataset.name!=e&&(clearTimeout(Oe),t(a),rl.app.Remote.abort("theme").get("theme",r).then((r=>{2===h(r)&&(s.textContent=r[1],s.dataset.name=e,t(n)),i()}),i))},Be=e=>e.replace(/@[a-z]+$/,"").replace(/([A-Z])/g," $1").trim();Ce(Ue,{fontSansSerif:e=>{if(null!=e){let t=T.classList;t.forEach((e=>{e.startsWith("font")&&!/font(Serif|Mono)/.test(e)&&t.remove(e)})),e&&t.add("font"+e)}},fontSerif:e=>{if(null!=e){let t=T.classList;t.forEach((e=>e.startsWith("fontSerif")&&t.remove(e))),e&&t.add("fontSerif"+e)}},fontMono:e=>{if(null!=e){let t=T.classList;t.forEach((e=>e.startsWith("fontMono")&&t.remove(e))),e&&t.add("fontMono"+e)}},userBackgroundHash:e=>{T.classList.toggle("UserBackground",!!e),T.style.backgroundImage=e?"url("+z("UserBackground",e)+")":null}}),_e.onchange=e=>{Ue.isMobile(e.matches),C.toggle("rl-mobile",e.matches),x(e.matches)},_e.onchange(_e);const He=new class{constructor(){const e=this;e.messagesPerPage=ko.observable(25).extend({debounce:999}),e.checkMailInterval=ko.observable(15).extend({debounce:999}),e.messageReadDelay=ko.observable(5).extend({debounce:999}),Ee(e,{viewHTML:1,viewImages:0,viewImagesWhitelist:"",removeColors:0,allowStyles:0,collapseBlockquotes:1,maxBlockquotesLevel:0,listInlineAttachments:0,simpleAttachmentsList:0,useCheckboxesInList:1,listGrouped:0,showNextMessage:0,allowDraftAutosave:1,useThreads:0,replySameFolder:0,hideUnsubscribed:0,hideDeleted:1,unhideKolabFolders:0,autoLogout:0,showUnreadCount:0,requestReadReceipt:0,requestDsn:0,requireTLS:0,pgpSign:0,pgpEncrypt:0,allowSpellcheck:0,layout:1,editorDefaultType:"Html",msgDefaultAction:1}),e.init(),e.usePreviewPane=we((()=>Ue.isMobile()?0:e.layout()));const t=()=>{const t=e.usePreviewPane();C.toggle("sm-msgView-side",1===t),C.toggle("sm-msgView-bottom",2===t),R("rl-layout",t)};let s;e.layout.subscribe(t),Ue.isMobile.subscribe(t),t(),e.delayLogout=(()=>{clearTimeout(s),0<e.autoLogout()&&!M("accountSignMe")&&(s=setTimeout(rl.app.logout,6e4*e.autoLogout()))}).throttle(5e3)}init(){const e=this;e.editorDefaultType(M("EditorDefaultType")),e.layout(f(M("Layout"))),e.messagesPerPage(f(M("MessagesPerPage"))),e.checkMailInterval(f(M("CheckMailInterval"))),e.messageReadDelay(f(M("MessageReadDelay"))),e.autoLogout(f(M("AutoLogout"))),e.msgDefaultAction(M("MsgDefaultAction")),e.viewHTML(M("ViewHTML")),e.viewImages(M("ViewImages")),e.viewImagesWhitelist(M("ViewImagesWhitelist")),e.removeColors(M("RemoveColors")),e.allowStyles(M("AllowStyles")),e.collapseBlockquotes(M("CollapseBlockquotes")),e.maxBlockquotesLevel(M("MaxBlockquotesLevel")),e.listInlineAttachments(M("ListInlineAttachments")),e.simpleAttachmentsList(M("simpleAttachmentsList")),e.useCheckboxesInList(M("UseCheckboxesInList")),e.listGrouped(M("listGrouped")),e.showNextMessage(M("showNextMessage")),e.allowDraftAutosave(M("AllowDraftAutosave")),e.useThreads(M("UseThreads")),e.replySameFolder(M("ReplySameFolder")),e.hideUnsubscribed(M("HideUnsubscribed")),e.hideDeleted(M("HideDeleted")),e.showUnreadCount(M("ShowUnreadCount")),e.unhideKolabFolders(M("UnhideKolabFolders")),e.requestReadReceipt(M("requestReadReceipt")),e.requestDsn(M("requestDsn")),e.requireTLS(M("requireTLS")),e.pgpSign(M("pgpSign")),e.pgpEncrypt(M("pgpEncrypt")),e.allowSpellcheck(M("allowSpellcheck"))}},Ke=D("template"),Ge=/[&<>"']/g,je=/^(https?:)?\/\//i,We={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"},$e=["svg","script","title","link","base","meta","input","output","select","button","textarea","bgsound","keygen","source","object","embed","applet","iframe","frame","frameset","video","audio","area","map"].join(","),Je=()=>{He.collapseBlockquotes()&&[...Ke.content.querySelectorAll("blockquote")].reverse().forEach((e=>{const t=D("details",{class:"sm-bq-switcher"});t.innerHTML="<summary>•••</summary>",e.replaceWith(t),t.append(e)}))},ze=e=>e.replaceWith(...e.childNodes),Ye=/https?:\/\/[^\p{C}\p{Z}]+[^\p{C}\p{Z}.]/gu,Ze=/(^|\r|\n|\p{C}\p{Z})((?:[^"(),.:;<>@[\]\\\p{C}\p{Z}]+(?:\.[^"(),.:;<>@[\]\\\p{C}\p{Z}]+)*|"(?:\\?[^"\\\p{C}\p{Z}])*")@[^@\p{C}\p{Z}]+[^@\p{C}\p{Z}.])/giu,Xe=/(tel:(\+[0-9().-]+|[0-9*#().-]+(;phone-context=\+[0-9+().-]+)?))/g,Qe=/^(utm_|ec_|fbclid|mc_eid|mkt_tok|_hsenc|vero_id|oly_enc_id|oly_anon_id|__s|Referrer|mailing|elq|bch|trc|ref|correlation_id|pd_|pf_|email_hash)/i,et=(e,t)=>new URL(e).searchParams.get(t)||e,tt=e=>atob(e.replace(/_/g,"/").replace(/-/g,"+")),st=decodeURIComponent,it=e=>{try{let t=e.replace(/^.+\/(https%253A[^/?&]+).*$/i,((...e)=>st(st(e[1])))).replace(/tracking\.(printabout\.nl[^?]+)\?.*/i,((...e)=>e[1])).replace(/(zalando\.nl[^?]+)\?.*/i,((...e)=>e[1])).replace(/^.+(awstrack\.me|redditmail\.com)\/.+(https:%2F%2F[^/]+).*/i,((...e)=>st(e[2]))).replace(/^.+(www\.google|safelinks\.protection\.outlook\.com|mailchimp\.com).+url=.+$/i,(()=>et(e,"url"))).replace(/^.+click\.godaddy\.com.+$/i,(()=>et(e,"redir"))).replace(/^.+delivery-status\.com.+$/i,(()=>et(e,"fb"))).replace(/^.+go\.dhlparcel\.nl.+\/([A-Za-z0-9_-]+)$/i,((...e)=>tt(e[1]))).replace(/^(.+mopinion\.com.+)\?.*$/i,((...e)=>e[1])).replace(/^.+sellercentral\.amazon\.com\/nms\/redirect.+$/i,(()=>tt(et(e,"u")))).replace(/^.+amazon\.com\/gp\/r\.html.+$/i,(()=>et(e,"U"))).replace(/^.+\/track\/click\/.+\?p=.+$/i,(()=>{let t=et(e,"p");try{t=JSON.parse(tt(t)),t?.p&&(t=JSON.parse(t.p))}catch(e){}return t?.url||e})).replace(/[\s<>]+/gi,"");t=new URL(t);let s=t.searchParams;return[...s.keys()].forEach((e=>Qe.test(e)&&s.delete(e))),t.toString()}catch(e){}return e},rt=e=>e.trim().replace(/-(ms|webkit)-[^;]+(;|$)/g,"").replace(/white-space[^;]+(;|$)/g,""),at=e=>{const t=[];if(t.toString=()=>t.reduce(((e,t)=>e+t.selector+" {\n"+("media"===t.type?t.subStyles.toString():t.rules)+"}\n"),""),t.applyNamespace=e=>t.forEach((t=>{"media"===t.type?t.subStyles.applyNamespace(e):t.selector=t.selector.split(",").map((t=>(e+" .mail-body "+t.replace(/\./g,".msg-")).replace(/\sbody/gi,""))).join(",")})),e){e=e.replace(/\/\*[\s\S]*?\*\/|<!--|-->/gi,"").replace(/@import .*?;/gi,"").replace(/((@.*?keyframes [\s\S]*?){([\s\S]*?}\s*?)})/gi,"");let s,i=/((\s*?(?:\/\*[\s\S]*?\*\/)?\s*?@media[\s\S]*?){([\s\S]*?)}\s*?})|(([\s\S]*?){([\s\S]*?)})/gi;for(;s=i.exec(e),null!==s;){let e=s[void 0===s[2]?5:2].split("\r\n").join("\n").trim().replace(/\n+/,"\n").split(/\s+/g).map((e=>e.replace(/^(:root|html)$/,""))).join(" ").trim();e.includes("@media")?t.push({selector:e,type:"media",subStyles:at(s[3]+"\n}")}):e&&!e.includes("@")&&t.push({selector:e,rules:rt(s[6])})}}return t},ot=e=>(e?.toString?.()||""+e).replace(Ge,(e=>We[e])),nt=(e,t,s)=>{let i;const r=parseInt(He.maxBlockquotesLevel()),a={hasExternals:!1},o=e=>t.findByCid(e),n={link:e=>i=e,text:(e,t)=>t.style.color=e,topmargin:(e,t)=>t.style.marginTop=f(e)+"px",leftmargin:(e,t)=>t.style.marginLeft=f(e)+"px",bottommargin:(e,t)=>t.style.marginBottom=f(e)+"px",rightmargin:(e,t)=>t.style.marginRight=f(e)+"px"},l=["name","dir","lang","style","title","background","bgcolor","alt","height","width","src","href","border","bordercolor","charset","direction","download","hreflang","alink","bottommargin","leftmargin","link","rightmargin","text","topmargin","vlink","align","valign","color","face","size","noshade","hspace","sizes","srcset","vspace","low","high","optimum","value","reversed","start","cols","rows","frame","rules","summary","cellpadding","cellspacing","abbr","scope","colspan","rowspan","headers"],c=["A","B","EM","I","SPAN","STRONG"];He.allowStyles()?l.push("class"):s=0,Ke.innerHTML=e.replace(/<(\/?)body(\s[^>]*)?>/gi,'<$1div class="mail-body"$2>').replace(/<span class="preview-text"[\s\S]+?<\/span>/,"").replace(/\u2028/g," ").trim(),e="";const d=document.createNodeIterator(Ke.content,NodeFilter.SHOW_COMMENT);for(;d.nextNode();)d.referenceNode.remove();return Ke.content.querySelectorAll($e+(0<r?","+new Array(1+r).fill("blockquote").join(" "):"")).forEach((e=>e.remove())),Ke.content.querySelectorAll("form,button").forEach((e=>ze(e))),[...Ke.content.querySelectorAll("*")].forEach((e=>{const t=e.tagName,r=e.style;if("STYLE"===t){let t=s?at(e.textContent):[];return void(t.length?(t.applyNamespace(s),t=t.toString(),He.removeColors()&&(t=t.replace(/(background-)?color:[^};]+;?/g,"")),e.textContent=t):e.remove())}if("none"==r.display||"hidden"==r.visibility)return void e.remove();const d=e.className,h=t=>e.hasAttribute(t),u=(t,s)=>e.setAttribute(t,s),p=t=>{let s=(t=>h(t)?e.getAttribute(t).trim():"")(t);return e.removeAttribute(t),s};if("mail-body"===d?g(n,((t,s)=>h(t)&&s(p(t),e))):s&&d&&(e.className=d.replace(/(^|\s+)/g,"$1msg-")),e.hasAttributes()){let t=e.attributes.length;for(;t--;){let s=e.attributes[t].name.toLowerCase();l.includes(s)||p(s)}}let m;if(r.backgroundImage||"TD"!==t&&"TH"!==t&&(["width","height"].forEach((e=>{h(e)&&(m=p(e),r[e]||(r[e]=m.includes("%")?m:m+"px"))})),m=r.width,100<parseInt(m,10)&&!r.maxWidth&&(r.maxWidth=m,r.width="100%"),m=r.removeProperty("height"),m&&!r.maxHeight&&(r.maxHeight=m)),"A"===t&&(m=e.href,/^([a-z]+):/i.test(m)?(e.href=it(m),u("target","_blank")):(u("data-x-broken-href",m),p("href")),u("tabindex","-1"),i&&!e.style.color&&(e.style.color=i)),"O:P"===t||c.includes(t)&&""==e.textContent.trim())return void(("A"!==t||!e.querySelector("IMG"))&&ze(e));let b=!1;if(h("src"))if(m=it(p("src")),"IMG"===t){let t;e.loading="lazy",m.startsWith("cid:")?(m=m.slice(4),u("data-x-src-cid",m),t=o(m),t?.download&&(e.src=t.linkPreview(),e.title+=" ("+t.fileName+")",t.isInline(!0),t.isLinked(!0))):(t=(e=>{const t=o(e);return t?.contentLocation?t:0})(m))?t.download&&(e.src=t.linkPreview(),t.isLinked(!0)):r.maxHeight&&3>f(r.maxHeight)||r.maxWidth&&3>f(r.maxWidth)||["email.microsoftemail.com/open","github.com/notifications/beacon/","/track/open","google-analytics.com"].filter((e=>m.toLowerCase().includes(e))).length?(b=!0,r.display="none",u("data-x-src-hidden",m)):je.test(m)?(u("data-x-src",m),a.hasExternals=!0,e.alt||(e.alt=m.replace(/^.+\/([^/?]+).*$/,"$1").slice(-20))):m.startsWith("data:image/")?e.src=m:u("data-x-src-broken",m)}else u("data-x-src-broken",m);if(h("background")&&(r.backgroundImage='url("'+p("background")+'")'),h("bgcolor")&&(r.backgroundColor=p("bgcolor")),h("color")&&(r.color=p("color")),!b){r.removeProperty("behavior"),r.removeProperty("cursor"),r.removeProperty("min-width");const e=[],s=[];["backgroundImage","listStyleImage","content"].forEach((i=>{if(r[i]){let n=r[i],l=n.match(/url\s*\(([^)]+)\)/i);if(l){r[i]=null,l=l[1].replace(/^["'\s]+|["'\s]+$/g,"");let c=l.toLowerCase();if(c.startsWith("cid:")){const e=o(l);e?.linkPreview&&t&&(r[i]="url('"+e.linkPreview()+"')",e.isInline(!0),e.isLinked(!0))}else je.test(c)?(a.hasExternals=!0,e.push([i,l])):c.startsWith("data:image/")?r[i]=n:s.push([i,l])}}})),e.length&&u("data-x-style-url",JSON.stringify(e)),s.length&&u("data-x-style-broken-urls",JSON.stringify(s)),He.removeColors()&&(r.removeProperty("background-color"),r.removeProperty("background-image"),r.removeProperty("color")),r.cssText=rt(r.cssText)}})),Je(),a.html=Ke.innerHTML.trim(),a},lt=e=>{const t="⎯".repeat(64),s=(e,t)=>Ke.content.querySelectorAll(e).forEach(t),i=e=>{let t;for(;t=e.querySelector("blockquote");)i(t),t.replaceWith("\n"+("\n"+t.textContent.replace(/\n{3,}/g,"\n\n").trim()+"\n").replace(/^/gm,"> "))};for(e=e.replace(/<pre[^>]*>([\s\S]*?)<\/pre>/gim,((...e)=>1<e.length?e[1].toString().replace(/\n/g,"<br>"):"")).replace(/\r?\n/g,"").replace(/\s+/gm," ");/<(div|tr)[\s>]/i.test(e);)e=e.replace(/\n*<(div|tr)(\s[\s\S]*?)?>\n*/gi,"\n");for(;/<\/(div|tr)[\s>]/i.test(e);)e=e.replace(/\n*<\/(div|tr)(\s[\s\S]*?)?>\n*/gi,"\n");return Ke.innerHTML=e.replace(/<t[dh](\s[\s\S]*?)?>/gi,"\t").replace(/<\/tr(\s[\s\S]*?)?>/gi,"\n"),s("hr",(e=>e.replaceWith(`\n\n${t}\n\n`))),s("h1,h2,h3,h4,h5,h6",(e=>e.replaceWith(`\n\n${"#".repeat(e.tagName[1])} ${e.textContent}\n\n`))),s("p",(e=>{e.prepend("\n\n"),""==e.textContent.trim()?e.remove():e.after("\n\n")})),s("ol,ul",(e=>{let t="",s=e,i="OL"==e.tagName,r=0;for(;s=s?.parentNode?.closest?.("ol,ul");)t="    "+t;e.querySelectorAll(":scope > li").forEach((e=>{e.prepend("\n"+t+(i?++r+". ":" * "))})),e.prepend("\n\n"),e.after("\n\n")})),s("a",(e=>{let t=e.textContent,s=e.href;return e.replaceWith(t.trim()==s||s.includes("mailto:")?t:t+" "+s+" ")})),s("b,strong",(e=>e.replaceWith(`**${e.textContent}**`))),s("i,em",(e=>e.replaceWith(`*${e.textContent}*`))),Ke.innerHTML=Ke.innerHTML.replace(/\n{3,}/gm,"\n\n").replace(/\n<br[^>]*>/g,"\n").replace(/<br[^>]*>\n/g,"\n"),s("br",(e=>e.replaceWith("\n"))),i(Ke.content),(Ke.content.textContent||"").trim()},ct=e=>{e=e.toString().replace(/\r/g,"").replace(/^>[> ]>+/gm,(([e])=>e?e.replace(/[ ]+/g,""):e)).replace(/\u2028/g," ");let t=!1,s=!0,i=!0,r=[],a=e.split("\n");do{s=!1,r=[],a.forEach((e=>{i=">"===e.slice(0,1),i&&!t?(s=!0,t=!0,r.push("~~~blockquote~~~"),r.push(e.slice(1))):!i&&t?e?(t=!1,r.push("~~~/blockquote~~~"),r.push(e)):r.push(e):i&&t?r.push(e.slice(1)):r.push(e)})),t&&(t=!1,r.push("~~~/blockquote~~~")),a=r}while(s);return Ke.innerHTML=a.join("\n").replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(Ye,((...e)=>(e[0]=it(e[0]),`<a href="${e[0]}" target="_blank">${e[0]}</a>`))).replace(Ze,'$1<a href="mailto:$2">$2</a>').replace(Xe,'<a href="$1">$1</a>').replace(/~~~blockquote~~~\s*/g,"<blockquote>").replace(/\s*~~~\/blockquote~~~/g,"</blockquote>").replace(/\n/g,"<br>"),Je(),Ke.innerHTML.trim()},dt=ko.observableArray();dt.push(["Squire",(e,t,s)=>{let i=new SquireUI(t);setTimeout((()=>s(i)),1)}]),rl.registerWYSIWYG=(e,t)=>dt.push([e,t]);class HtmlEditor{constructor(e,t=null,s=null,i=null){if(this.blurTimer=0,this.onBlur=t,this.onModeChange=i,e){s=s?[s]:[],this.onReady=e=>s.push(e);dt.find((e=>"Squire"==e[0]))[1](this,e,(e=>{this.editor=e,e.on("blur",(()=>this.blurTrigger())),e.on("focus",(()=>clearTimeout(this.blurTimer))),e.on("mode",(()=>{this.blurTrigger(),this.onModeChange?.(!this.isPlain())})),this.onReady=e=>e(),s.forEach((e=>e()))}))}}blurTrigger(){this.onBlur&&(clearTimeout(this.blurTimer),this.blurTimer=setTimeout((()=>this.onBlur?.()),200))}isHtml(){return!!this.editor&&!this.isPlain()}isPlain(){return!!this.editor&&"plain"===this.editor.mode}clearCachedSignature(){this.onReady((()=>this.editor.execCommand("insertSignature",{clearCache:!0})))}setSignature(e,t,s=!1){this.onReady((()=>this.editor.execCommand("insertSignature",{isHtml:t,insertBefore:s,signature:e})))}getData(){let e="";if(this.editor)try{e=this.isPlain()&&this.editor.plugins.plain&&this.editor.__plain?this.editor.__plain.getRawData():this.editor.getData()}catch(e){}return e}getDataWithHtmlMark(){return(this.isHtml()?":HTML:":"")+this.getData()}modeWysiwyg(){this.onReady((()=>this.editor.setMode("wysiwyg")))}modePlain(){this.onReady((()=>this.editor.setMode("plain")))}setHtmlOrPlain(e){e.startsWith(":HTML:")?this.setHtml(e.slice(6)):this.setPlain(e)}setData(e,t){this.onReady((()=>{const s=this.editor;this.clearCachedSignature();try{s.setMode(e),this.isPlain()&&s.plugins.plain&&s.__plain?s.__plain.setRawData(t):s.setData(t)}catch(e){}}))}setHtml(e){this.setData("wysiwyg",e)}setPlain(e){this.setData("plain",e)}focus(){this.onReady((()=>this.editor.focus()))}hasFocus(){try{return!!this.editor?.focusManager.hasFocus}catch(e){return!1}}blur(){this.onReady((()=>this.editor.focusManager.blur(!0)))}clear(){this.onReady((()=>this.isPlain()?this.setPlain(""):this.setHtml("")))}}rl.Utils={htmlToPlain:lt,plainToHtml:ct};class AbstractCollectionModel extends Array{constructor(){super()}onDestroy(){this.forEach((e=>e.onDestroy?.()))}static reviveFromJson(e,t){const s=new this;return e&&("Collection/"+this.name.replace("Model","")===e["@Object"]&&(g(e,((e,t)=>"@"!==e[0]&&(s[e]=t))),e=e["@Collection"]),d(e)&&e.forEach((e=>{e&&t&&(e=t(e,s)),e&&s.push(e)}))),s}}function ht(e,t){if(null!=e)switch(typeof e){case"boolean":return 0!=t&&!!t;case"number":return isFinite(t)?parseFloat(t):0;case"string":return null!=t?""+t:"";case"object":if(e.constructor.reviveFromJson)return e.constructor.reviveFromJson(t);if(d(e)&&!d(t))return[]}return t}class AbstractModel{constructor(){this.disposables=[]}addObservables(e){Ee(this,e)}addComputables(e){ke(this,e)}addSubscribables(e){g(e,((e,t)=>this.disposables.push(this[e].subscribe(t))))}onDestroy(){this.disposables.forEach(Ae),m(this,(e=>{(ko.isObservableArray(e)?e():e)?.onDestroy?.()}))}static validJson(e){return!(!e||"Object/"+this.name.replace("Model","")!==e["@Object"])}static reviveFromJson(e){let t=this.validJson(e)?new this:null;return t?.revivePropertiesFromJson(e),t}revivePropertiesFromJson(e){const t=this.constructor.validJson(e);return t&&g(e,((e,t)=>{if("@"!==e[0])try{switch(typeof this[e]){case"function":ko.isObservable(this[e])&&this[e](ht(this[e](),t));break;case"boolean":case"number":case"object":case"string":this[e]=ht(this[e],t);break;case"undefined":this[e]=t}}catch(e){}})),t}}function ut(e){e=(e||"").toString();let t="",s={type:"text",value:""},i=!1,r=[],a=[];const o={'"':'"',"(":")","<":">",",":"",":":";",";":""},n=e=>{e.value=(e.value||"").toString().trim(),e.value.length&&r.push(e),s={type:"text",value:""},i=!1},l=()=>{r.length&&(r=function(e){let t=!1,s={},i=[],r={email:[],comment:[],group:[],text:[]};e.forEach((e=>{t=t||"group"===e.type,r[e.type].push(e.value)})),!r.text.length&&r.comment.length&&(r.text=r.comment,r.comment=[]);if(t)i=i.concat(ut(r.group.join(",")));else{if(!r.email.length&&r.text.length){for(var a=r.text.length;a--;)if(r.text[a].match(/^[^@\s]+@[^@\s]+$/)){r.email=r.text.splice(a,1);break}if(!r.email.length)for(a=r.text.length;a--&&(r.text[a]=r.text[a].replace(/\s*\b[^@\s]+@[^@\s]+\b\s*/,(e=>r.email.length?e.trim():(r.email=[e.trim()],""))),!r.email.length););}!r.text.length&&r.comment.length&&(r.text=r.comment,r.comment=[]),r.email.length>1&&(r.text=r.text.concat(r.email.splice(1))),s={email:r.email.join(" ").trim(),name:r.text.join(" ").trim()},s.email===s.name&&(s.email.includes("@")?s.name="":s.email=""),i.push(s)}return i}(r),r.length&&(a=a.concat(r))),r=[]};return[...e].forEach((e=>{i||e!==t&&(t||!(e in o))?(s.value+=e,i=!i&&"\\"===e):(n(s),","===e||";"===e?l():(t=t?"":o[e],"<"===e?s.type="email":"("===e?s.type="comment":":"===e&&(s.type="group")))})),n(s),l(),a}class EmailModel extends AbstractModel{constructor(e,t,s="none"){super(),this.email=e||"",this.name=t||"",this.dkimStatus=s,this.cleanup()}static reviveFromJson(e){const t=super.reviveFromJson(e);return t?.cleanup(),t?.valid()?t:null}valid(){return this.name||this.email}cleanup(){this.name===this.email&&(this.name="")}toLine(e,t){let s=this.name,i=this.email,r=e=>'<a href="mailto:'+ot(i)+(s?"?to="+encodeURIComponent('"'+s+'" <'+i+">"):"")+'" target="_blank" tabindex="-1">'+ot(e||i)+"</a>";return i&&(s?i=e?t?r(s):s:t?ot('"'+s+'" <')+r()+ot(">"):'"'+s+'" <'+i+">":t&&(i=r())),i||s}}class EmailCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){return super.reviveFromJson(e,(e=>EmailModel.reviveFromJson(e)))}static fromString(e){let t=new this;return t.fromString(e),t}toString(e,t){return this.map((s=>s.toLine(e,t))).join(", ")}fromString(e){if(e){let t,s={};ut(e).forEach((e=>{e=new EmailModel(e.email,e.name),t=e.email||e.name,!t||!e.name&&s[t]||(s[t]=e)})),m(s,(e=>this.push(e)))}}}const pt=()=>(k.fullscreenElement||k.webkitFullscreenElement)===T,mt=()=>pt()&&(k.exitFullscreen||k.webkitExitFullscreen).call(k),gt=ko.observable(!1),ft=()=>gt()?mt():T.requestFullscreen();if(T){let e="fullscreenchange";!T.requestFullscreen&&T.webkitRequestFullscreen&&(T.requestFullscreen=T.webkitRequestFullscreen,e="webkit"+e),T.requestFullscreen&&k.addEventListener(e,(()=>{gt(pt()),C.toggle("rl-fullscreen",pt())}))}let bt=null,yt="";const vt=new Map,St=e=>e.querySelector("[autofocus]")?.focus(),wt=new Set,Et=e=>e&&vt.get(e)||null,kt=(e,t)=>{if(e&&!e.__builded){let s=null;const i=new e(t),r=i.viewModelTemplateID,a="rl-"+i.viewType,o=Ft===i.viewType,n=k.getElementById(a);if(e.__builded=!0,e.__vm=i,n){if(s=o?D("dialog",{id:"V-"+r}):D("div",{id:"V-"+r,hidden:""}),n.append(s),i.viewModelDom=e.__dom=s,o){s.showModal||(s.className="polyfill",s.showModal=()=>{s.backdrop||s.before(s.backdrop=D("div",{class:"dialog-backdrop"})),s.setAttribute("open",""),s.open=!0,s.returnValue=null,s.backdrop.hidden=!1},s.close=e=>{s.backdrop.hidden=!0,s.returnValue=e,s.removeAttribute("open",null),s.open=!1});const e=e=>{e.target===s&&(s.classList.contains("animate")?i.afterShow?.():(s.close(),i.afterHide?.()))};i.modalVisible.subscribe((e=>{e?(ue(s),wt.add(i),s.style.zIndex=3001+2*wt.size,s.showModal(),s.backdrop&&(s.backdrop.style.zIndex=3e3+2*wt.size),i.keyScope.set(),setTimeout((()=>St(s)),1),requestAnimationFrame((()=>{s.offsetHeight,s.classList.add("animate")}))):(wt.delete(i),i.onHide?.(),i.keyScope.unset(),s.classList.remove("animate")),Lt(0<wt.size)})),s.addEventListener("transitionend",e)}R("rl-view-model.create",i),ko.applyBindingAccessorsToNode(s,{template:()=>({name:r})},i),i.onBuild?.(s),R("rl-view-model",i)}}return e?.__vm},Ct=(e,t)=>{e.viewModels.forEach((e=>{e.__vm&&e.__dom&&Ft!==e.__vm.viewType&&t(e.__vm,e.__dom)}))},At=(e,t)=>{e.onHide?.(),Ct(e,((e,s)=>{s.hidden=!0,e.onHide?.(),t&&e.viewModelDom.remove()})),Ue.isMobile()&&x(!0)},Tt=(e,t)=>{if((e=e||yt)&&R("sm-show-screen",e,1)){for(let e of wt)!1===e.onClose()||e.close();let s=Et(e);if(s||(s=Et(yt),s&&(t=e+"/"+t,e=yt)),s?.__started){let e=bt&&s===bt;s.__builded||(s.__builded=!0,s.viewModels.forEach((e=>kt(e,s))),s.onBuild?.()),setTimeout((()=>{bt&&!e&&At(bt),bt=s,e||(s.onShow?.(),Ct(s,((e,t)=>{e.beforeShow?.(),ue(t),t.hidden=!1,e.onShow?.(),St(t)}))),s.__cross?.parse(t)}),1)}}},Ft="popups",Mt=(e,t=[])=>{const s=kt(e)&&e.__dom&&e.__vm;s&&(t=t||[],s.beforeShow?.(...t),s.modalVisible(!0),s.onShow?.(...t))},Lt=ko.observable(!1),Pt=e=>{hasher.clear(),vt.forEach((e=>At(e,1))),vt.clear(),bt=null,yt="",e.forEach((e=>{const t=new e,s=t.screenName;yt||(yt=s),vt.set(s,t)})),vt.forEach((e=>{e.__started||(e.onStart(),e.__started=!0)}));const t=new Crossroads;t.addRoute(/^([^/]*)\/?(.*)$/,Tt),hasher.add(t.parse.bind(t)),hasher.init(),setTimeout((()=>C.remove("rl-started-trigger")),100);const s=A("rl-content"),i=A("rl-loading");s&&(s.hidden=!1),i?.remove()},It=(e,t)=>g(t,((t,s)=>{let i=e[t],r=(...t)=>r.canExecute()&&i.apply(e,t);r.canExecute=we((()=>s.call(e,e))),e[t]=r}));ko.decorateCommands=It;const xt={allowContacts:()=>!!M("contactsAllowed")};Ee(xt,{focusedState:"none",threadsAllowed:!1}),xt.focusedState.subscribe((e=>{["FolderList","MessageList","MessageView"].forEach((t=>{t===e&&(Lt()||K(e),Ue.isMobile()&&x("FolderList"!==e)),A("V-Mail"+t).classList.toggle("focused",t===e)}))}));const Nt=new class{constructor(){Ee(this,{message:null,error:"",loading:!1,bodiesDom:null}),Ce(this,{message:t=>{clearTimeout(this.MessageSeenTimer),A("rl-right").classList.toggle("message-selected",!!t),t?He.usePreviewPane()||xt.focusedState(s):(xt.focusedState(e),mt()),[...this.bodiesDom()?.children||[]].forEach((e=>e.hidden=!0))}}),this.purgeCache=this.purgeCache.throttle(3e4)}purgeCache(e){const t=this.bodiesDom()?.children||[];let s=Math.max(0,t.length-(e?0:15));for(;s--;)t[s].remove(),t[s].message&&(t[s].message.body=null)}};let Dt=null,Rt=null,Ot=e=>!!Rt?.canPlayType(e).replace("no",""),_t=window.AudioContext||window.webkitAudioContext,Ut=(e,t)=>{Rt&&(Rt.src=e,Rt.play(),t=t.trim(),R("audio.start",t.replace(/\.([a-z0-9]{3})$/,"")||"audio"))},Vt=()=>{try{const e=new Audio;if(e.canPlayType&&e.pause&&e.play)return e.preload="none",e.loop=!1,e.autoplay=!1,e.muted=!1,e}catch(e){}return null},qt=["click","dblclick","contextmenu","auxclick","mousedown","mouseup","pointerup","touchstart","touchend","keydown","keyup"],Bt=()=>{qt.forEach((e=>k.removeEventListener(e,Bt,!0))),_t&&_t.resume()};_t&&(_t=_t?new _t:null,_t.onstatechange=Bt),qt.forEach((e=>k.addEventListener(e,Bt,!0)));const Ht=new class{constructor(){if(Rt||(Rt=Vt()),this.supported=!!Rt,this.supportedMp3=Ot("audio/mpeg;"),this.supportedWav=Ot('audio/wav; codecs="1"'),this.supportedOgg=Ot('audio/ogg; codecs="vorbis"'),Rt){const e=()=>this.pause();q(Rt,["ended","error"],e),addEventListener("audio.api.stop",e)}Ee(this,{notifications:!1})}paused(){return!Rt||Rt.paused}stop(){this.pause()}pause(){Rt?.pause(),R("audio.stop")}playMp3(e,t){this.supportedMp3&&Ut(e,t)}playOgg(e,t){this.supportedOgg&&Ut(e,t)}playWav(e,t){this.supportedWav&&Ut(e,t)}playNotification(e,t){(e||this.notifications())&&"running"==_t.state&&(this.supportedMp3||this.supportedOgg)&&(Dt=Dt||Vt(),Dt&&(Dt.src=Q("sounds/"+M("NotificationSound")+(this.supportedMp3?".mp3":".ogg")),Dt.volume=t?.01:1,Dt.play()))}},Kt="__UNUSE__";let Gt=new Map,jt=new Map,Wt="INBOX";const $t=()=>Wt,Jt=e=>{e.etag="",Gt.set(e.fullName,e),jt.set(e.fullNameHash,e.fullName)},zt=(e,t)=>Gt.has(e)&&(Gt.get(e).etag=t),Yt=e=>Gt.get(e),Zt=e=>Gt.delete(e),Xt=["$forwarded","$mdnsent","$submitpending","$submitted","$junk","$notjunk","$phishing","sent","$encrypted","$error","$ignored","$invitation","$queued","$sent","$signed","$todo","$watched","$notphishing","junk","nonjunk","$attachment","$replied","$readreceipt","$notdelivered"],Qt=e=>"\\"!=e[0]&&!Xt.includes(e.toLowerCase()),es=new class{constructor(){const e=this;Ee(e,{displaySpecSetting:!1,quotaLimit:0,quotaUsage:0,sentFolder:"",draftsFolder:"",spamFolder:"",trashFolder:"",archiveFolder:"",folderListOptimized:!1,folderListError:"",foldersLoading:!1,foldersCreating:!1,foldersDeleting:!1,foldersRenaming:!1,foldersInboxUnreadCount:0}),e.sortMode=ko.observable(""),e.namespace="",e.folderList=ko.observableArray(),e.capabilities=ko.observableArray(),e.currentFolder=ko.observable(null).extend({toggleSubscribeProperty:[e,"selected"]}),ke(e,{draftsFolderNotEnabled:()=>!e.draftsFolder()||Kt===e.draftsFolder(),currentFolderFullName:()=>e.currentFolder()?e.currentFolder().fullName:"",currentFolderFullNameHash:()=>e.currentFolder()?e.currentFolder().fullNameHash:"",foldersChanging:()=>e.foldersLoading()|e.foldersCreating()|e.foldersDeleting()|e.foldersRenaming(),systemFoldersNames:()=>{const t=[$t()],s=[e.sentFolder(),e.draftsFolder(),e.spamFolder(),e.trashFolder(),e.archiveFolder()];return e.folderList().length&&s.forEach((e=>e&&Kt!==e&&t.push(e))),t},systemFolders:()=>e.systemFoldersNames().map((e=>Yt(e))).filter((e=>e))});const t=t=>{t.subscribe((()=>Yt(t())?.type(0)),e,"beforeChange")},s=e=>t=>Yt(t)?.type(e);t(e.sentFolder),t(e.draftsFolder),t(e.spamFolder),t(e.trashFolder),t(e.archiveFolder),Ce(e,{sentFolder:s(Me.Sent),draftsFolder:s(Me.Drafts),spamFolder:s(Me.Junk),trashFolder:s(Me.Trash),archiveFolder:s(Me.Archive)}),e.quotaPercentage=we((()=>{const t=e.quotaLimit(),s=e.quotaUsage();return 0<t?Math.ceil(s/t*100):0}))}hasCapability(e){return this.capabilities().includes(e)}allowKolab(){return es.hasCapability("METADATA")&&L("Kolab")}getNextFolderNames(e){const t=[],s=Date.now(),i=s-e,r=[],a=this.displaySpecSetting(),o=e=>{e.forEach((e=>{e?.selectable()&&e.exists&&i>e.expires&&(e.isSystemFolder()||e.isSubscribed()&&(e.checkable()||!a))&&r.push([e.expires,e.fullName]),e?.subFolders.length&&o(e.subFolders())}))};return o(this.folderList()),r.sort(((e,t)=>e[0]<t[0]?-1:e[0]>t[0]?1:0)),r.find((e=>{const i=Yt(e[1]);return i&&(i.expires=s,t.push(e[1])),10<=t.length})),t}saveSystemFolders(e){e=e||{sent:es.sentFolder(),drafts:es.draftsFolder(),junk:es.spamFolder(),trash:es.trashFolder(),archive:es.archiveFolder()},g(e,((e,t)=>F.set(e+"Folder",t))),rl.app.Remote.request("SystemFoldersUpdate",null,e)}},ts={},ss="application/",is=ss+"vnd.openxmlformats-officedocument.",rs=ss+"vnd.oasis.opendocument.",as=["B","KiB","MiB","GiB","TiB"],os=e=>e.toLowerCase().trim(),ns={eml:"message/rfc822",mime:"message/rfc822",vcard:"text/vcard",vcf:"text/vcard",htm:"text/html",html:"text/html",csv:"text/csv",ics:"text/calendar",xml:"text/xml",json:ss+"json",p10:ss+"pkcs10",p7c:ss+"pkcs7-mime",p7m:ss+"pkcs7-mime",p7s:ss+"pkcs7-signature",torrent:ss+"x-bittorrent",js:ss+"javascript",pl:"text/perl",css:"text/css",asp:"text/asp",php:ss+"x-php",jpg:"image/jpeg",ico:"image/x-icon",tif:"image/tiff",svg:"image/svg+xml",svgz:"image/svg+xml",zip:ss+"zip","7z":ss+"x-7z-compressed",rar:ss+"x-rar-compressed",cab:ss+"vnd.ms-cab-compressed",gz:ss+"x-gzip",tgz:ss+"x-gzip",bz:ss+"x-bzip",bz2:ss+"x-bzip2",deb:ss+"x-debian-package",mp3:"audio/mpeg",wav:"audio/x-wav",mp4a:"audio/mp4",weba:"audio/webm",m3u:"audio/x-mpegurl",qt:"video/quicktime",mov:"video/quicktime",wmv:"video/windows-media",avi:"video/x-msvideo","3gp":"video/3gpp","3g2":"video/3gpp2",mp4v:"video/mp4",mpg4:"video/mp4",ogv:"video/ogg",m4v:"video/x-m4v",asf:"video/x-ms-asf",asx:"video/x-ms-asf",wm:"video/x-ms-wm",wmx:"video/x-ms-wmx",wvx:"video/x-ms-wvx",movie:"video/x-sgi-movie",pdf:ss+"pdf",psd:"image/vnd.adobe.photoshop",ai:ss+"postscript",eps:ss+"postscript",ps:ss+"postscript",doc:ss+"msword",rtf:ss+"rtf",xls:ss+"vnd.ms-excel",ppt:ss+"vnd.ms-powerpoint",docx:is+"wordprocessingml.document",xlsx:is+"spreadsheetml.sheet",dotx:is+"wordprocessingml.template",pptx:is+"presentationml.presentation",odt:rs+"text",ods:rs+"spreadsheet",odp:rs+"presentation"},ls="unknown",cs="text",ds="code",hs="eml",us="word",ps="pdf",ms="image",gs="audio",fs="video",bs="spreadsheet",ys="presentation",vs="certificate",Ss="archive",ws={getExtension:e=>{const t=(e=os(e)).split(".").pop();return t===e?"":t},getContentType:e=>{if("winmail.dat"===(e=os(e)))return ss+"ms-tnef";let t=e.split(".").pop();return/^(txt|text|def|list|in|ini|log|sql|cfg|conf)$/.test(t)?"text/plain":/^(mpe?g|mpe|m1v|m2v)$/.test(t)?"video/mpeg":/^aif[cf]?$/.test(t)?"audio/aiff":/^(aac|flac|midi|ogg)$/.test(t)?"audio/"+t:/^(h26[134]|jpgv|mp4|webm)$/.test(t)?"video/"+t:/^(otf|sfnt|ttf|woff2?)$/.test(t)?"font/"+t:/^(png|jpeg|gif|tiff|webp)$/.test(t)?"image/"+t:ns[t]||ss+"octet-stream"},getType:(e,t)=>{let s=(e=os(e))+(t=os(t).replace("csv/plain","text/csv"));if(ts[s])return ts[s];let i=ls;const r=t.split("/"),a=r[1].replace("x-","").replace("-compressed",""),o=e=>t.includes(e),n=/^(zip|7z|tar|rar|gzip|bzip|bzip2)$/;switch(!0){case"image"==r[0]||["png","jpg","jpeg","gif","webp"].includes(e):i=ms;break;case"audio"==r[0]||["mp3","ogg","oga","wav"].includes(e):i=gs;break;case"video"==r[0]||"mkv"==e||"avi"==e:i=fs;break;case["php","js","css","xml","html"].includes(e)||"text/html"==t:i=ds;break;case"eml"==e||["message/delivery-status","message/rfc822"].includes(t):i=hs;break;case"text"==r[0]||"txt"==e||"log"==e:i=cs;break;case n.test(a)||n.test(e):i=Ss;break;case"pdf"==a||"pdf"==e:i=ps;break;case[ss+"pgp-signature",ss+"pgp-keys"].includes(t)||["asc","pem","ppk"].includes(e)||[ss+"pkcs7-signature"].includes(t)||"p7s"==e:i=vs;break;case o(is+".wordprocessingml")||o(rs+".text")||o("vnd.ms-word")||["rtf","msword","vnd.msword"].includes(a):i=us;break;case o(is+".spreadsheetml")||o(rs+".spreadsheet")||o("ms-excel"):i=bs;break;case o(is+".presentationml")||o(rs+".presentation")||o("ms-powerpoint"):i=ys}return ts[s]=i},getTypeIconClass:e=>{let t="icon-file";switch(e){case cs:case hs:case ps:case us:return t+"-text";case ds:case ms:case gs:case fs:case Ss:case vs:case bs:case ys:return t+"-"+e}return t},getIconClass:(e,t)=>ws.getTypeIconClass(ws.getType(e,t)),getAttachmentsIconClass:e=>{if(h(e)){let t=e.map((e=>e?ws.getIconClass(ws.getExtension(e.fileName),e.mimeType):"")).validUnique();return 1===t?.length&&"icon-file"!==t[0]?t[0]:"icon-attachment"}return""},friendlySize:e=>{e=parseInt(e,10)||0;let t=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,t)).toFixed(2>t?0:1)+" "+as[t]}};class AttachmentModel extends AbstractModel{constructor(){super(),this.checked=ko.observable(!0),this.mimeType="",this.fileName="",this.fileNameExt="",this.fileType=ls,this.cId="",this.contentLocation="",this.folder="",this.uid="",this.url="",this.mimeIndex="",this.estimatedSize=0,Ee(this,{isInline:!1,isLinked:!1})}static reviveFromJson(e){const t=super.reviveFromJson(e);return t&&(t.fileNameExt=ws.getExtension(t.fileName),t.fileType=ws.getType(t.fileNameExt,t.mimeType)),t}toggleChecked(e,t){O(t),e.checked(!e.checked())}friendlySize(){return ws.friendlySize(this.estimatedSize)+(this.isLinked()?" 🔗":"")}contentId(){return this.cId.replace(/^<+|>+$/g,"")}isImage(){return ms===this.fileType}isMp3(){return gs===this.fileType&&"mp3"===this.fileNameExt}isOgg(){return gs===this.fileType&&("oga"===this.fileNameExt||"ogg"===this.fileNameExt)}isWav(){return gs===this.fileType&&"wav"===this.fileNameExt}isText(){return cs===this.fileType||hs===this.fileType}pdfPreview(){return null!=navigator.mimeTypes["application/pdf"]&&ps===this.fileType}hasPreview(){return this.isImage()||this.pdfPreview()||this.isText()}hasPreplay(){return Ht.supportedMp3&&this.isMp3()||Ht.supportedOgg&&this.isOgg()||Ht.supportedWav&&this.isWav()}get download(){return v({folder:this.folder,uid:this.uid,mimeIndex:this.mimeIndex,mimeType:this.mimeType,fileName:this.fileName,accountHash:M("accountHash")})}linkDownload(){return this.url||Y(this.download)}linkPreview(){return this.url||z("View",this.download)}hasThumbnail(){return L("AttachmentThumbnails")&&this.isImage()&&!this.isLinked()}thumbnailStyle(){return this.hasThumbnail()?"background:url("+z("ViewThumbnail",this.download)+")":null}linkPreviewMain(){let e="";switch(!0){case this.isImage():case this.pdfPreview():e=this.linkPreview();break;case this.isText():e=z("ViewAsPlain",this.download)}return e}eventDragStart(e,t){const s=t.originalEvent||t;if(e&&s&&s.dataTransfer&&s.dataTransfer.setData){let e=this.linkDownload();e.startsWith("http")||(e=location.protocol+"//"+location.host+location.pathname+e),s.dataTransfer.setData("DownloadURL",this.mimeType+":"+this.fileName+":"+e)}return!0}iconClass(){return ws.getTypeIconClass(this.fileType)}}class AttachmentCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){return super.reviveFromJson(e,(e=>AttachmentModel.reviveFromJson(e)))}findByCid(e){return e=e.replace(/^<+|>+$/g,""),this.find((t=>e===t.contentId()))}}let Es=0;const ks=(e="")=>X("Json")+p(e),Cs=e=>{const t=e?e.ErrorCode:null;(c.InvalidToken===t||[c.AuthError,c.ConnectionError,c.DomainNotAllowed,c.AccountNotAllowed,c.MailServerError,c.UnknownNotification,c.UnknownError].includes(t)&&7<++Es)&&rl.logoutReload()},As={},Ts=(e,t,s)=>{As[e]&&(s||As[e].abort(t||"AbortError"),As[e]=null,delete As[e])},Fs=(e,t,s,i,r)=>{s&&(s instanceof FormData?s.set("Action",e):s.Action=e);const a=new AbortController,o=a.signal;return As[e]=a,i&&setTimeout((()=>Ts(e,"TimeoutError")),i),rl.fetchJSON(t,{signal:o},s).then(r).catch((e=>(e.aborted=o.aborted,e.reason=o.reason,Promise.reject(e))))};class FetchError extends Error{constructor(e,t){super(t),this.code=e||c.JsonFalse}}class AbstractFetchRemote{abort(e){return Ts(e),this}streamPerLine(e,t,s){rl.fetch(ks(t),{},s).then((e=>e.body)).then((t=>{let s="";const i=t.getReader(),r=/\r\n|\n|\r/gm,a=new TextDecoder,o=({done:t,value:n})=>{for(s+=n?a.decode(n,{stream:!0}):"";;){let a=r.exec(s);if(!a){if(t)break;return void i.read().then(o)}e(s.slice(0,a.index)),s=s.slice(a.index+1),r.lastIndex=0}s.length&&e(s)};i.read().then(o)}))}request(e,t,s,i,r){s=s||{};const a=Date.now();Fs(e,ks(r),r?null:s||{},void 0===i?3e4:f(i),(s=>{let i=0;e&&As[e]&&Ts(e,0,1),!i&&s&&(s.Result?Es=0:(Cs(s),i=s.ErrorCode||c.UnknownError)),t&&t(i,s,s?.epoch&&s.epoch<Math.floor(a/1e3)-60)})).catch((e=>{t&&t("TimeoutError"==e.reason?3:"AbortError"==e.name?2:1,e)}))}getPublicKey(e){this.request("GetPublicKey",e)}setTrigger(e,t){e&&(t=!!t,(d(e)?e:[e]).forEach((e=>{e?.(t)})))}get(e,t){return Fs(e,t)}post(e,t,s,i){return this.setTrigger(t,!0),Fs(e,ks(),s||{},f(i,3e4),(s=>(Ts(e,0,1),s?(this.setTrigger(t,!1),s.Result&&e===s.Action?s:(Cs(s),Promise.reject(new FetchError(s?s.ErrorCode:0,s?s.ErrorMessageAdditional||s.ErrorMessage:"")))):Promise.reject(new FetchError(c.JsonParse)))))}}Object.assign(AbstractFetchRemote.prototype,{SUCCESS:0,ERROR:1,ABORT:2});var Ms=new class RemoteUserFetch extends AbstractFetchRemote{messageList(e,t,s=!1){const i=Yt(t.folder),r=i?.etag||"";t=Object.assign({offset:0,limit:He.messagesPerPage(),search:"",uidNext:i?.uidNext||0,sort:es.sortMode()},t),xt.threadsAllowed()&&He.useThreads()?t.useThreads=1:t.threadUid=0;let a="";r&&(t.hash=r+"-"+M("accountHash"),a="MessageList/&q[]=/"+v(t),t={}),s||this.abort("MessageList"),this.request("MessageList",e,t,6e4,a)}message(e,t,s){return t=p(t),s=f(s),!!(Yt(t)&&0<s)&&(this.abort("Message").request("Message",e,{},null,"Message/&q[]=/"+v([t,s,xt.threadsAllowed()&&He.useThreads()?1:0,M("accountHash")])),!0)}saveSettings(e,t){this.request("SettingsUpdate",e,t)}saveSetting(e,t,s){this.saveSettings(s,{[e]:t})}};const Ls=e=>nt(e.html(),e.attachments(),"#rl-msg-"+e.hash),Ps=(e,t)=>{const s=t.toLowerCase(),i=e.flags,r=i.includes(s);Ms.request("MessageSetKeyword",(e=>{e||(r?i.remove(s):i.push(s))}),{folder:e.folder,uids:e.uid,keyword:t,setAction:r?0:1})},Is=(e,t,s)=>e.forEach((e=>t[e.email]||s.has(e.email)||s.set(e.email,e)));class MessageModel extends AbstractModel{constructor(){super(),this.folder="",this.uid=0,this.hash="",this.from=new EmailCollectionModel,this.to=new EmailCollectionModel,this.cc=new EmailCollectionModel,this.bcc=new EmailCollectionModel,this.sender=new EmailCollectionModel,this.replyTo=new EmailCollectionModel,this.deliveredTo=new EmailCollectionModel,this.body=null,this.draftInfo=[],this.dkim=[],this.spf=[],this.dmarc=[],this.messageId="",this.inReplyTo="",this.references="",this.autocrypt={},Ee(this,{subject:"",plain:"",html:"",size:0,spamScore:0,spamResult:"",isSpam:!1,hasVirus:null,dateTimestamp:0,internalTimestamp:0,priority:3,senderEmailsString:"",senderClearEmailsString:"",deleted:!1,focused:!1,selected:!1,checked:!1,isHtml:!1,hasImages:!1,hasExternals:!1,pgpSigned:null,pgpVerified:null,encrypted:!1,pgpEncrypted:null,pgpDecrypted:!1,readReceipt:"",id:""}),this.attachments=ko.observableArray(new AttachmentCollectionModel),this.threads=ko.observableArray(),this.threadUnseen=ko.observableArray(),this.unsubsribeLinks=ko.observableArray(),this.flags=ko.observableArray(),ke(this,{attachmentIconClass:()=>this.encrypted()?"icon-lock":ws.getAttachmentsIconClass(this.attachments()),threadsLen:()=>rl.app.messageList.threadUid()?0:this.threads().length,threadUnseenLen:()=>rl.app.messageList.threadUid()?0:this.threadUnseen().length,isUnseen:()=>!this.flags().includes("\\seen"),isFlagged:()=>this.flags().includes("\\flagged"),tagOptions:()=>{const e=[];return es.currentFolder().permanentFlags.forEach((t=>{if(Qt(t)){let s=t.toLowerCase();e.push({css:"msgflag-"+s,value:t,checked:this.flags().includes(s),label:he("MESSAGE_TAGS/"+s,0,t),toggle:()=>Ps(this,t)})}})),e},whitelistOptions:()=>{let e=[];if("match"===He.viewImages()){let t=this.from[0],s=He.viewImagesWhitelist(),i={};this.html().match(/src=["'][^"']+/g)?.forEach((t=>{t=t.replace(/^.+(:\/\/[^/]+).+$/,"$1"),i[t]?++i[t]:(i[t]=1,e.push(t))})),e=e.filter((e=>!s.includes(e))).sort(((e,t)=>i[e]<i[t]?1:i[e]>i[t]?-1:e.localeCompare(t))),t&&e.unshift(t.email)}return e}})}get requestHash(){return v({folder:this.folder,uid:this.uid,mimeType:"message/rfc822",fileName:(this.subject()||"message-"+this.hash)+".eml",accountHash:M("accountHash")})}toggleTag(e){Ps(this,e)}spamStatus(){let e=this.spamResult();return e?he(this.isSpam()?"GLOBAL/SPAM":"GLOBAL/NOT_SPAM")+": "+e:""}friendlySize(){return ws.friendlySize(this.size())}computeSenderEmail(){const e=this[[es.sentFolder(),es.draftsFolder()].includes(this.folder)?"to":"from"];this.senderEmailsString(e.toString(!0)),this.senderClearEmailsString(e.map((e=>e?.email)).filter((e=>e)).join(", "))}revivePropertiesFromJson(e){if(super.revivePropertiesFromJson(e))return this.computeSenderEmail(),!0}lineAsCss(e=1){let t=[];return g({deleted:this.deleted(),selected:this.selected(),checked:this.checked(),unseen:this.isUnseen(),focused:this.focused(),priorityHigh:1===this.priority(),withAttachments:!!this.attachments().length},((e,s)=>s&&t.push(e))),e&&this.flags().forEach((e=>t.push("msgflag-"+e))),t.join(" ")}indent(){return this.level?"margin-left:"+this.level+"em":null}viewRaw(){return z("ViewAsPlain",this.requestHash)}downloadLink(){return z("Download",this.requestHash)}replyEmails(e){const t=new Map,s=e||{};return Is(this.replyTo,s,t),t.size||Is(this.from,s,t),t.size?[...t.values()]:[this.to[0]]}replyAllEmails(e){const t=new Map,s=new Map,i=e||{};return Is(this.replyTo,i,t),t.size||Is(this.from,i,t),Is(this.to,i,t),Is(this.cc,i,s),[[...t.values()],[...s.values()]]}viewBody(e){const t=this.body;if(t){if(e){let e=Ls(this);this.hasExternals(e.hasExternals),this.hasImages(!!e.hasExternals),t.innerHTML=e.html,this.isSpam()||es.spamFolder()==this.folder||("always"===He.viewImages()&&this.showExternalImages(),"match"===He.viewImages()&&this.showExternalImages(1))}else t.innerHTML=ct(this.plain()?this.plain().replace(/-----BEGIN PGP (SIGNED MESSAGE-----(\r?\n[^\r\n]+)+|SIGNATURE-----[\s\S]*)/gs,"").trim():lt(t.innerHTML)),this.hasImages(!1);return t.classList.toggle("html",e),t.classList.toggle("plain",!e),this.isHtml(e),!0}}viewHtml(){return this.html()&&this.viewBody(!0)}viewPlain(){return this.viewBody(!1)}viewPopupMessage(e){const t=this.dateTimestamp()||0,s=this.cc.toString(),i=this.bcc.toString(),r=0<t?new Date(1e3*t):null,a=open("","sm-msg-"+this.requestHash),o=a.document,n=ot(this.subject()),l=this.isHtml()?"div":"pre",c=`<div>${ot(he("GLOBAL/TO"))}: ${ot(this.to)}</div>`+(s?`<div>${ot(he("GLOBAL/CC"))}: ${ot(s)}</div>`:"")+(i?`<div>${ot(he("GLOBAL/BCC"))}: ${ot(i)}</div>`:""),d=getComputedStyle(k.querySelector(".messageView")),h=e=>d.getPropertyValue(e);o.write('<html>\n<head>\n\t<meta charset="utf-8">\n\t<title></title>\n\t<style>\nhtml, body {\n\tmargin: 0;\n\tpadding: 0;\n}\n\nheader {\n\tbackground: rgba(125,128,128,0.3);\n\tborder-bottom: 1px solid #888;\n}\n\nheader h1 {\n\tfont-size: 120%;\n}\n\nheader * {\n\tmargin: 5px 0;\n}\n\nheader time {\n\tfloat: right;\n}\n\nblockquote {\n\tborder-left: 2px solid rgba(125,128,128,0.5);\n\tmargin: 0;\n\tpadding: 0 0 0 10px;\n}\n\npre {\n\twhite-space: pre-wrap;\n\tword-wrap: break-word;\n\tword-break: normal;\n}\n\nbody > * {\n\tpadding: 0.5em 1em;\n}\n\t</style>\n</head>\n<body></body>\n</html>\n'.replace("<title>","<title>"+n).replace("<body>",`<body style="background-color:${h("background-color")};color:${h("color")}"><header><h1>${n}</h1><time>${ot(r?r.format("LLL",0,ie.hourCycle()):"")}</time><div>${ot(this.from)}</div>${c}</header><${l}>${this.bodyAsHTML()}</${l}>`)),o.close(),e&&setTimeout((()=>a.print()),100)}popupMessage(){this.viewPopupMessage()}printMessage(){this.viewPopupMessage(!0)}generateUid(){return this.folder+"/"+this.uid}showExternalImages(e){const t=this.body;if(t&&this.hasImages()){e&&(e=[],He.viewImagesWhitelist().trim().split(/[\s\r\n,;]+/g).forEach((t=>{(t=t.split("+"))[0]=t[0].trim(),!t[0]||t.includes("spf")&&"pass"!==this.spf[0]?.[0]||t.includes("dkim")&&"pass"!==this.dkim[0]?.[0]||t.includes("dmarc")&&"pass"!==this.dmarc[0]?.[0]||e.push(t[0].replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&"))})),(e=e.join("|").replace(/\|+/g,"|"))&&(e=new RegExp(e),this.from[0]?.email.match(e)&&(e=null)));let s,i=!1,r=t=>{if(null==e||e&&t.match(e))return!0;i=!0},a="data-x-src",o=!!M("useLocalProxyForExternalImages");t.querySelectorAll("img["+a+"]").forEach((e=>{s=e.getAttribute(a),r(s)&&(e.src=o?Z(s):s)})),t.querySelectorAll("[data-x-style-url]").forEach((e=>{JSON.parse(e.dataset.xStyleUrl).forEach((t=>{r(t[1])&&(e.style[t[0]]="url('"+(o?Z(t[1]):t[1])+"')")}))})),this.hasImages(i)}}bodyAsHTML(){if(this.body){let e=this.body.cloneNode(!0);return e.querySelectorAll(".sm-bq-switcher").forEach((e=>e.replaceWith(e.lastElementChild))),e.innerHTML}return Ls(this).html||ct(this.plain())}}class MessageCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){let t=Nt.message();return super.reviveFromJson(e,(e=>{if(e=t&&t.hash===e.hash?t:MessageModel.reviveFromJson(e))return e.deleted(!1),e}))}}const xs=Fe();xs.loading=ko.observable(!1).extend({debounce:100}),xs.getEmailAddresses=()=>xs.map((e=>e.email)),Ee(xs,{email:"",signature:""});const Ns=window.Notification,Ds=()=>Ns?.permission||"denied",Rs=()=>"denied"===Ds(),Os=()=>"granted"===Ds(),_s=e=>{focus(),e.folder&&e.uid?R("mailbox.message.show",e):e.Url&&hasher.setHash(e.Url)};let Us=!1,Vs=navigator.serviceWorker;Vs&&(ServiceWorkerRegistration&&ServiceWorkerRegistration.prototype.showNotification?Vs.addEventListener("message",(e=>{const t=JSON.parse(e.data);"notificationclick"===t?.action&&_s(t.data)})):Vs=null);const qs=new class{constructor(){Ee(this,{enabled:!1,allowed:!Rs()}),this.enabled.subscribe((e=>{Us=!!e,e&&Ns&&!Os()&&Ns.requestPermission((()=>this.allowed(!Rs())))}))}display(e,t,s,i){if(Us&&Os()){const r={body:t,icon:i||Q("images/icon-message-notification.png"),data:s};if(s?.uid&&(r.tag=s.uid),Vs)Vs.register(Q("js/serviceworker.js"),{scope:"/"}).then((()=>Vs.ready.then((t=>t.showNotification(e,r).then((()=>t.getNotifications().then((()=>{t.active.postMessage("")})))))))).catch((e=>{Vs=null}));else{const t=new Ns(e,r);t.show?.(),t.onclick=s?()=>_s(s):null,setTimeout((()=>t.close()),7e3)}}}},Bs=e=>e.checked(),Hs=e=>{rl.route.off(),hasher.replaceHash(e),rl.route.on()},Ks=ko.observable(!1).extend({falseTimeout:500}),Gs=ko.observableArray().extend({debounce:0});Ee(Gs,{count:0,listSearch:"",listLimited:0,threadUid:0,page:1,pageBeforeThread:1,error:"",endHash:"",endThreadUid:0,loading:!1,isIncomplete:!1,selectedMessage:null,focusedMessage:null}),ke(Gs,{isLoading:()=>{const e=Gs.loading()|Gs.isIncomplete();return C.toggle("list-loading",e),e},isArchiveFolder:()=>es.archiveFolder()===Gs().folder,isDraftFolder:()=>es.draftsFolder()===Gs().folder,isSentFolder:()=>es.sentFolder()===Gs().folder,isSpamFolder:()=>es.spamFolder()===Gs().folder,isTrashFolder:()=>es.trashFolder()===Gs().folder,archiveAllowed:()=>![Kt,Gs().folder].includes(es.archiveFolder())&&!Gs.isDraftFolder(),canMarkAsSpam:()=>!(Kt===es.spamFolder()|Gs.isSentFolder()|Gs.isDraftFolder()|Gs.isSpamFolder()),pageCount:()=>Math.max(1,Math.ceil(Gs.count()/He.messagesPerPage())),mainSearch:{read:Gs.listSearch,write:e=>hasher.setHash(se(es.currentFolderFullNameHash(),1,e.toString().trim(),Gs.threadUid()))},listCheckedOrSelected:()=>{const e=Gs.selectedMessage(),t=Gs.focusedMessage(),s=Gs.filter((e=>Bs(e)));return s.length?s:e||t?[e||t]:[]},listCheckedOrSelectedUidsWithSubMails:()=>{let e=new Set;return Gs.listCheckedOrSelected().forEach((t=>{e.add(t.uid),1<t.threadsLen()&&t.threads().forEach(e.add,e)})),e}}),Gs.listChecked=we((()=>Gs.filter(Bs))).extend({rateLimit:0}),Gs.hasChecked=we((()=>!!Gs.find(Bs))).extend({rateLimit:0}),Gs.hasCheckedOrSelected=we((()=>!!Gs.selectedMessage()|!!Gs.focusedMessage()|!!Gs.find(Bs))).extend({rateLimit:50}),Gs.notifyNewMessages=(e,t)=>{if($t()===e&&h(t)){Ht.playNotification();const e=t.length;3<e?qs.display(xs.email(),he("MESSAGE_LIST/NEW_MESSAGE_NOTIFICATION",{COUNT:e}),{Url:se(t[0].folder)}):t.forEach((e=>{qs.display(EmailCollectionModel.reviveFromJson(e.from).toString(),e.subject,{folder:e.folder,uid:e.uid})}))}},Gs.canAutoSelect=()=>!/is:unseen/.test(Gs.mainSearch())&&!Ks()&&He.usePreviewPane(),Gs.reload=(e=!1,t=!1)=>{let s=(Gs.page()-1)*He.messagesPerPage();t&&zt(es.currentFolderFullName(),""),e&&(Gs.page(1),Gs.pageBeforeThread(1),s=0,Hs(se(es.currentFolderFullNameHash(),Gs.page(),Gs.listSearch(),Gs.threadUid()))),Gs.loading(!0),Ms.messageList(((e,t,s)=>{let i="";if(e)i=fe(e),c.RequestAborted!==e&&Gs([]);else{const e=MessageCollectionModel.reviveFromJson(t.Result,s);if(e){const t=e.folder,i=Yt(t.name);if(e.folder=t.name,i&&!s){i.expires=Date.now(),i.uidNext=t.uidNext,i.etag=t.etag,null!=t.totalEmails&&i.totalEmails(t.totalEmails),null!=t.unreadEmails&&i.unreadEmails(t.unreadEmails);let s=t.permanentFlags||[];if(s.includes("\\*")){let e=6;for(;--e;)s.includes("$label"+e)||s.push("$label"+e)}s.sort(((e,t)=>(e=e.toUpperCase())<(t=t.toUpperCase())?-1:e>t?1:0)),i.permanentFlags(s),Gs.notifyNewMessages(i.fullName,e.newMessages)}Gs.count(e.totalEmails),Gs.listSearch(p(e.search)),Gs.listLimited(!!e.limited),Gs.page(Math.ceil(e.offset/He.messagesPerPage()+1)),Gs.threadUid(e.threadUid),Gs.endHash(t.name+"|"+e.search+"|"+Gs.threadUid()+"|"+Gs.page()),Gs.endThreadUid(e.threadUid);const r=Nt.message();if(r&&t.name!==r.folder&&Nt.message(null),Ks(!0),e.threadUid){let t={};e.forEach((e=>{e.level=0,e.inReplyTo&&t[e.inReplyTo]&&(e.level=1+t[e.inReplyTo].level),t[e.messageId]=e}))}Gs(e),Gs.isIncomplete(!1)}else Gs.count(0),Gs([]),i=fe(c.CantGetMessageList)}Gs.error(i),Gs.loading(!1)}),{folder:es.currentFolderFullName(),offset:s,limit:He.messagesPerPage(),search:Gs.listSearch(),threadUid:Gs.threadUid()})},Gs.setAction=(e,t,s)=>{s=s||Gs.listChecked();let i,r,a=[];if(t==xe?s.forEach((e=>e.isUnseen()&&a.push(e.uid)&&e.flags.push("\\seen"))):t==Ne?s.forEach((e=>!e.isUnseen()&&a.push(e.uid)&&e.flags.remove("\\seen"))):t==De?s.forEach((e=>!e.isFlagged()&&a.push(e.uid)&&e.flags.push("\\flagged"))):t==Re&&s.forEach((e=>e.isFlagged()&&a.push(e.uid)&&e.flags.remove("\\flagged"))),a=a.validUnique(),r=a.length,e&&r)switch(t){case xe:r=-r;case Ne:i=Yt(e),i&&i.unreadEmails(Math.max(0,i.unreadEmails()+r)),Ms.request("MessageSetSeen",null,{folder:e,uids:a.join(","),setAction:t==xe?1:0});break;case De:case Re:Ms.request("MessageSetFlagged",null,{folder:e,uids:a.join(","),setAction:t==De?1:0})}},Gs.removeMessagesFromList=(e,t,s="",i=!1)=>{let r=0,a=0,o=Nt.message();const n=es.trashFolder(),l=es.spamFolder(),c=Yt(e),d=s?Yt(s):null,h=es.currentFolderFullName()===e?Gs.filter((e=>e&&t.has(e.uid))):[];if(h.forEach((e=>e?.isUnseen()&&++r)),c&&(c.etag="",i||(c.totalEmails(0<=c.totalEmails()-t.size?c.totalEmails()-t.size:0),0<r&&c.unreadEmails(Math.max(0,c.unreadEmails()-r)))),d&&(d.etag="",n!==d.fullName&&l!==d.fullName||(r=0),d.totalEmails(d.totalEmails()+t.size),0<r&&d.unreadEmails(d.unreadEmails()+r),d.actionBlink(!0)),h.length)if(i)h.forEach((e=>e.checked(!1)));else{if(Gs.isIncomplete(!0),o&&1==h.length&&He.showNextMessage()){let e=Gs.indexOf(o)+1;0<e&&(e=Gs()[e])&&(o=null,R("mailbox.message.show",{folder:e.folder,uid:e.uid}))}h.forEach((e=>{o&&o.hash===e.hash&&(o=null,Nt.message(null)),e.deleted(!0)})),setTimeout((()=>h.forEach((e=>Gs.remove(e)))),350);const e=Gs.count()-h.length,t=Gs.page();Gs.count(e),t>Gs.pageCount()&&(a=Gs.pageCount())}if(Gs.threadUid()&&Gs.length&&Gs.find((e=>e?.deleted()&&e.uid==Gs.threadUid()))){const e=Gs.find((e=>e&&!e.deleted()));e?Gs.threadUid()!=e.uid&&(Gs.threadUid(e.uid),a=Gs.page()):1<Gs.page()?a=Gs.page()-1:(Gs.threadUid(0),a=Gs.pageBeforeThread())}a&&(Gs.page(a),Hs(se(es.currentFolderFullNameHash(),a,Gs.listSearch(),Gs.threadUid())))};const js=window,Ws="rlcsc",$s="localStorage",Js=()=>{try{const e=localStorage.getItem(Ws);return e?JSON.parse(e):null}catch(e){return null}};try{js[$s].setItem($s,""),js[$s].getItem($s),js[$s].removeItem($s)}catch(e){let t=document.cookie.match(/(^|;) ?localStorage=([^;]+)/);t=t?decodeURIComponent(t[2]):null,t=t?JSON.parse(t):{},js[$s]={getItem:e=>null==t[e]?null:t[e],setItem:(e,s)=>{t[e]=""+s,document.cookie=$s+"="+encodeURIComponent(JSON.stringify(t))+";expires="+new Date(Date.now()+31536e6).toGMTString()+";path=/;samesite=strict"}}}function zs(e,t){const s=Js()||{};s["p"+e]=t;try{return localStorage.setItem(Ws,JSON.stringify(s)),!0}catch(e){return!1}}function Ys(e){try{return(Js()||{})["p"+e]}catch(e){return null}}const Zs=ko.observable(!1),Xs=(()=>I(!!P.find((e=>e.classList.contains("show"))))).debounce(50),Qs=(e,t="")=>{if(Ue.isMobile()||/firefox/i.test(navigator.userAgent))open(e,"_blank"),focus();else{const s=D("a",{href:e,target:"_blank",download:t});k.body.appendChild(s).click(),s.remove()}},ei=(e,t,s,i,r)=>{if(t.length){let a={target:"zip",filename:e,hashes:t};s||(s=()=>alert("Download failed")),r&&(a.folder=r),Ms.post("AttachmentsActions",i||null,a).then((e=>{let t=e?.Result?.fileHash;t?Qs(Y(t),t+".zip"):s()})).catch(s)}},ti=(e,t)=>()=>{const s=e(),i=t(),r=[],a=k.documentElement.lang,o=(e,t=!0,i="")=>{const o=e.toLocaleString(a),n={current:e===s,name:i||o,title:i?o:"",value:e};t?r.push(n):r.unshift(n)};let n=0,l=0,c=2;if(1<i||0<i&&i<s){for(i<s?(o(i),n=i,l=i):((3>=s||i-2<=s)&&(c+=2),o(s),n=s,l=s);0<c;)if(--n,++l,0<n&&(o(n,!1),--c),i>=l)o(l,!0),--c;else if(0>=n)break;3===n?o(2,!1):3<n&&o(Math.round((n-1)/2),!1,"…"),i-2===l?o(i-1,!0):i-2>l&&o(Math.round((i+l)/2),!0,"…"),1<n&&o(1,!1),i>l&&o(i,!0)}return r},si=e=>{if("mailto:"===e?.slice(0,7).toLowerCase()){e=e.slice(7).split("?");const t=decodeURIComponent(e[0]),s=new URLSearchParams(e[1]),i=s.get("to"),r=e=>EmailCollectionModel.fromString(e);return ii([Ie.Empty,null,r(i?t+","+i:t),r(s.get("cc")),r(s.get("bcc")),s.get("subject"),ct(s.get("body")||"")]),!0}return!1},ii=(e=[])=>{rl.app.showMessageComposer(e)},ri=(e,t,s)=>{if(e.layoutResizer&&e.layoutResizer.mode!=s&&e.removeAttribute("style"),e.observer?.disconnect(),s){const i=Ys(t+s)||M("Resizer"+t+s);if(i&&(e.style[s.toLowerCase()]=i+"px"),!e.layoutResizer){const t=D("div",{class:"resizer"}),s=(e=>Ms.saveSettings(0,e)).debounce(500),i={},r=()=>{const i="Width"==t.mode?e.offsetWidth:e.offsetHeight,r=t.key+t.mode;i==Ys(r)||zs(r,i),i==M("Resizer"+r)||s({["Resizer"+r]:i})},a=s=>{let i=getComputedStyle(e,null)[s].replace("px","");return i.includes("%")&&(i=e.parentElement["offset"+t.mode]*i.replace("%","")/100),parseFloat(i)};e.layoutResizer=t,e.append(t),t.addEventListener("mousedown",{handleEvent:function(s){if("mousedown"==s.type){const e=t.mode.toLowerCase();s.preventDefault(),i.pos="width"==e?s.pageX:s.pageY,i.min=a("min-"+e),i.max=a("max-"+e),i.org=a(e),addEventListener("mousemove",this),addEventListener("mouseup",this)}else if("mousemove"==s.type){const a=t.mode.toLowerCase(),o=i.org+(("width"==a?s.pageX:s.pageY)-i.pos);o>=i.min&&o<=i.max&&(e.style[a]=o+"px",e.observer||r())}else"mouseup"==s.type&&(removeEventListener("mousemove",this),removeEventListener("mouseup",this))}}),e.observer=window.ResizeObserver?new ResizeObserver(r):null}e.layoutResizer.mode=s,e.layoutResizer.key=t,e.observer?.observe(e,{box:"border-box"})}},ai=(e,t)=>{if(t)e.viewPopupMessage();else{Nt.error("");let t="rl-msg-"+e.hash,s=e.body||A(t);s||(s=D("div",{id:t,hidden:"",class:"b-text-part"+(e.pgpSigned()?" openpgp-signed":"")+(e.pgpEncrypted()?" openpgp-encrypted":"")}),Nt.purgeCache()),s.message=e,e.body=s,He.viewHTML()&&e.viewHtml()||e.viewPlain(),Nt.bodiesDom().append(s),Nt.loading(!1),e.body.hidden=!1,e.isUnseen()&&(Nt.MessageSeenTimer=setTimeout((()=>Gs.setAction(e.folder,xe,[e])),1e3*He.messageReadDelay()))}},oi=(e,t)=>{e&&(t||Nt.message(e),e.body?ai(e,t):(t||Nt.loading(!0),Ms.message(((s,i)=>{if(s)c.RequestAborted===s||t||(Nt.message(null),Nt.error(fe(s)));else{let s=i?.Result;s&&e.hash===s.hash&&e.revivePropertiesFromJson(s)&&ai(e,t)}t||Nt.loading(!1)}),e.folder,e.uid)))};x.subscribe((e=>e&&Zs(!1))),Zs.subscribe((e=>e&&x(!1)));const ni=e=>e?.emailaddress?.key;let li,ci;class EmailAddressesComponent{constructor(e,t){ci||(ci=D("datalist",{id:"emailaddresses-datalist"}),k.body.append(ci));const s=this,i=D("input",{type:"text",list:ci.id,autocomplete:"off",autocorrect:"off",autocapitalize:"off"}),r=()=>li?.li.parentNode!==s.ul,a=e=>r()&&e.preventDefault();s.element=e,s.options=Object.assign({focusCallback:null,autoCompleteSource:"",onChange:null},t),s._chosenValues=[],s._lastEdit="",s.ul=D("ul",{class:"emailaddresses"}),B(s.ul,{click:e=>s._focus(e),dblclick:e=>s._editTag(e),dragenter:a,dragover:a,drop:e=>{r()&&li.value&&(e.preventDefault(),li.source._removeDraggedTag(li.li),s._parseValue(li.value))}}),s.input=i,B(i,{focus:()=>{s._focusTrigger(!0),i.value||s._resetDatalist()},blur:()=>{s._parseInput(!0),s._focusTrigger(!1)},keydown:e=>{if("Backspace"===e.key||"ArrowLeft"===e.key){var t=s.inputCont.previousElementSibling;t&&(!i.value||"selectionStart"in i&&0===i.selectionStart&&0===i.selectionEnd)&&(e.preventDefault(),t.querySelector("a").focus()),s._updateDatalist()}else"Enter"==e.key&&(e.preventDefault(),s._parseInput(!0))},input:()=>{s._parseInput(),s._updateDatalist()}}),e.placeholder&&(i.placeholder=e.placeholder),s.inputCont=D("li",{class:"emailaddresses-input"}),s.inputCont.append(i),s.ul.append(s.inputCont),e.replaceWith(s.ul),e.value.trim()&&s._parseValue(e.value),s._updateDatalist=s.options.autoCompleteSource?(()=>{let e=i.value.trim();ci.inputValue!==e&&(ci.inputValue=e,e.length&&s.options.autoCompleteSource(e,(t=>{s._resetDatalist();let r=e.length;t?.forEach((e=>{ci.append(new Option(e)),r=Math.max(r,e.length)})),r*=8,i.clientWidth<r&&(i.style.width=r+"px")})))}).throttle(500):()=>0}_focusTrigger(e){this.ul.classList.toggle("emailaddresses-focused",e),this.options.focusCallback(e)}_resetDatalist(){ci.textContent=""}_parseInput(e){let t=this.input.value;(e||t.includes(",")||t.includes(";"))&&this._parseValue(t)&&(this.input.value=""),this._resizeInput()}_parseValue(e){if(e){const t=this,s=e.trim(),i=((s&&[",",";","\n"].includes(s.slice(-1))?(e=>{const t=[];let s=!1;return ut(e).forEach((e=>{const i=e.name||e.email?new EmailModel(e.email,e.name):null;i?.email&&(s=!0),t.push(i?i.toLine():e.name)})),s?t:null})(e):null)||[e]).map((e=>ut(e).map((e=>e.name||e.email?new EmailModel(e.email,e.name):null)).filter((e=>e)))).flat(1/0).map((e=>e.toLine?[e.toLine(),e]:[e,null]));if(i.length)return i.forEach((e=>{var s=e[0].trim(),i=!1,r=-1,a={key:"",obj:null,value:""};t._chosenValues.forEach(((e,a)=>{e.value===t._lastEdit&&(r=a),i|=e.value===s})),""!==s&&e[1]&&!i&&(a.key="mi_"+Math.random().toString(16).slice(2,10),a.value=s,a.obj=e[1],-1<r?t._chosenValues.splice(r,0,a):t._chosenValues.push(a),t._lastEdit="",t._renderTags())})),1===i.length&&""===i[0]&&""!==t._lastEdit&&(t._lastEdit="",t._renderTags()),t._setValue(t._buildValue()),!0}}_resizeInput(){let e=this.input;e.clientWidth<e.scrollWidth&&(e.style.width=e.scrollWidth+20+"px")}_editTag(e){var t=e.target.closest("li"),s=ni(t);if(!s)return!0;var i=this,r="",a=null,o=!1;i._chosenValues.forEach((e=>{e.key===s?(r=e.value,o=!0):o&&!a&&(a=e)})),a&&(i._lastEdit=a.value),t.after(i.inputCont),i.input.value=r,setTimeout((()=>i.input.select()),100),i._removeTag(e,t),i._resizeInput(e)}_buildValue(){return this._chosenValues.map((e=>e.value)).join(",")}_setValue(e){this.element.value!==e&&(this.element.value=e,this.options.onChange(e))}_renderTags(){let e=this;[...e.ul.children].forEach((t=>t!==e.inputCont&&t.remove())),e._chosenValues.forEach((t=>{if(t.obj){let s=D("li",{title:t.obj.toLine(),draggable:"true"}),i=D("span");i.append(t.obj.toLine(!0)),s.append(i),i=D("a",{href:"#",class:"ficon"}),i.append("✖"),B(i,{click:t=>e._removeTag(t,s),focus:()=>s.className="emailaddresses-selected",blur:()=>s.className=null,keydown:t=>{switch(t.key){case"Delete":case"Backspace":e._removeTag(t,s);break;case"e":case"Enter":e._editTag(t);break;case"ArrowLeft":var r=i.closest("li").previousElementSibling;r.matches("li")?r.querySelector("a").focus():e.focus();break;case"ArrowRight":var a=i.closest("li").nextElementSibling;a!==this.inputCont?a.querySelector("a").focus():this.focus();break;case"ArrowDown":e._focus(t)}}}),s.append(i),s.emailaddress=t,B(s,{dragstart:t=>{li={source:e,li:s,value:s.emailaddress.obj.toLine()},t.dataTransfer.setData("text/plain","snappymail/emailaddress"),t.dataTransfer.effectAllowed="move",s.style.opacity=.25},dragend:()=>{li=null,s.style.cssText=""}}),e.inputCont.before(s)}}))}_removeTag(e,t){e.preventDefault();var s=ni(t),i=this,r=i._chosenValues.findIndex((e=>s===e.key));r>-1&&i._chosenValues.splice(r,1),i._setValue(i._buildValue()),t.remove(),setTimeout((()=>i.input.focus()),100)}_removeDraggedTag(e){var t=ni(e),s=this,i=s._chosenValues.findIndex((e=>t===e.key));-1<i&&(s._chosenValues.splice(i,1),s._setValue(s._buildValue())),e.remove()}focus(){this.input.focus()}blur(){this.input.blur()}_focus(e){var t=e.target.closest("li");ni(t)?t.querySelector("a").focus():this.focus()}set value(e){var t=this;t.element.value!==e&&(t._chosenValues=[],t._renderTags(),t._parseValue(t.element.value=e))}}let di,hi=3e5;const ui=e=>{hi=6e4*Math.max(5,e),clearInterval(di),di=setInterval((()=>{const e=es.currentFolderFullName(),t=$t();gi(t),t===e||gi(e),fi()}),hi)},pi=e=>{try{let t=new Intl.Collator(void 0,{numeric:!0,sensitivity:"base"});e.sort(((e,s)=>e.isInbox()?-1:s.isInbox()?1:t.compare(e.fullName,s.fullName)))}catch(e){}},mi=(e,t,s,i,r,a=es.folderList())=>{const o=[],n=!s||!He.hideUnsubscribed(),l=t=>{t.forEach((t=>{(n||t.hasSubscriptions()||!t.exists)&&o.push({id:t.fullName,name:"   ".repeat(t.deep)+s(t),system:!1,disabled:!r&&(!t.selectable()||e.includes(t.fullName)||i(t))}),l(t.subFolders())}))};return i=i||(()=>!1),s=s||(e=>e.name()),d(e)||(e=[]),d(t)&&t.forEach((e=>o.push({id:e[0],name:e[1],system:!1,disabled:!1}))),l(a),o},gi=(e,t)=>{if(e?.trim()){let s=1;const i=[];h(t)&&(t.forEach((e=>{i.push(e.uid),e.threads.forEach((e=>i.push(e)))})),s=i.length),s&&Ms.request("FolderInformation",((e,t)=>{if(!e&&t.Result){const e=t.Result,s=Yt(e.name);if(s){const t=s.etag,i=s.unreadEmails()!==e.unreadEmails;s.expires=Date.now(),s.uidNext=e.uidNext,s.etag=e.etag,s.totalEmails(e.totalEmails),s.unreadEmails(e.unreadEmails),Gs.notifyNewMessages(s.fullName,e.newMessages),t&&!i&&e.etag===t||s.fullName===es.currentFolderFullName()&&Gs.reload()}}}),{folder:e,flagsUids:i,uidNext:Yt(e)?.uidNext||0})}},fi=(e=!1)=>{const t=es.getNextFolderNames(hi);h(t)&&Ms.request("FolderInformationMultiply",((t,s)=>{if(!t&&h(s.Result)){const t=Date.now();s.Result.forEach((e=>{const s=Yt(e.name);if(s){const i=s.etag,r=s.unreadEmails()!==e.unreadEmails;s.expires=t,s.etag=e.etag,s.totalEmails(e.totalEmails),s.unreadEmails(e.unreadEmails),i&&e.etag===i?r&&s.fullName===es.currentFolderFullName()&&Gs.length&&gi(s.fullName,Gs()):s.fullName===es.currentFolderFullName()&&Gs.reload()}})),e&&setTimeout((()=>fi(!0)),2e3)}}),{folders:t})},bi=(e,t)=>{e?(zt(es.currentFolderFullName(),""),alert(fe(e))):es.currentFolder()&&(2===h(t.Result)?zt(t.Result[0],t.Result[1]):zt(es.currentFolderFullName(),""),Gs.reload(!Gs.length))},yi=(e,t,s)=>{const i=es.spamFolder(),r=i===t,a=!r&&i===e&&$t()===t;Ms.abort("MessageList").request("MessageMove",bi,{fromFolder:e,toFolder:t,uids:[...s].join(","),markAsRead:r||es.trashFolder()===t?1:0,learning:r?"SPAM":a?"HAM":""})},vi=(e,t)=>{Ms.abort("MessageList").request("MessageDelete",bi,{folder:e,uids:[...t].join(",")})},Si=(e,t,s,i)=>{if(e!==s&&t?.size){const r=Yt(e),a=Yt(s);if(r&&a)return i?Ms.request("MessageCopy",null,{fromFolder:r.fullName,toFolder:a.fullName,uids:[...t].join(",")}):yi(r.fullName,a.fullName,t),Gs.removeMessagesFromList(r.fullName,t,a.fullName,i),!0}return!1},wi=(e,t)=>{let s=t.length;for(const i of t)if("message/rfc822"===i.type){let t=new FormData;t.append("folder",e),t.append("appendFile",i),Ms.request("FolderAppend",((t,i)=>{0==--s&&es.currentFolderFullName()==e&&Gs.reload(!0,!0)}),t)}else--s},Ei=e=>""===e||Kt===e||null!==Yt(e)?e:"",ki={Inbox:0,Sent:0,Drafts:0,Junk:0,Trash:0,Archive:0},Ci={configuration:"CONFIGURATION",event:"CALENDAR",contact:"CONTACTS",task:"TASKS",note:"NOTES",file:"FILES",journal:"JOURNAL"},Ai=(e,t)=>{switch(e){case Me.Inbox:case Me.Sent:case Me.Drafts:case Me.Trash:case Me.Archive:return he("FOLDER_LIST/"+S(Me,e).toUpperCase()+"_NAME");case Me.Junk:return he("GLOBAL/SPAM")}return t},Ti=(e,t)=>{let s=Ys(3);s=new Set(d(s)?s:[]),t?s.add(e):s.delete(e),zs(3,[...s])},Fi=ko.observable(""),Mi=e=>{Ms.abort("Folders").post("Folders",es.foldersLoading).then((t=>{Gt.clear(),jt.clear(),FolderCollectionModel.reviveFromJson(t.Result)?.storeIt(),e?.(!0)})).catch((()=>e&&setTimeout(e,1,!1)))};class FolderCollectionModel extends AbstractCollectionModel{static reviveFromJson(e){const t=Ys(3);g(ki,((e,t)=>t||(ki[e]=M(e+"Folder"))));const s=super.reviveFromJson(e,(e=>{let s=Yt(e.fullName);if(s)e.etag&&(s.etag=e.etag),null!=e.totalEmails&&s.totalEmails(e.totalEmails),null!=e.unreadEmails&&s.unreadEmails(e.unreadEmails);else{if(s=FolderModel.reviveFromJson(e),!s)return null;Jt(s)}let i=e.role;return i&&(i=i[0].toUpperCase()+i.slice(1),ki[i]||(ki[i]=e.fullName)),s.type(Me[S(ki,e.fullName)]||0),s.collapsed(!t||!d(t)||!t.includes(s.fullName)),s}));var i;s.CountRec=s.length,i=ki.Inbox,Wt=i;let r=s.length;if(r){pi(s);try{for(;r--;){let e=s[r],t=Yt(e.parentName);if(!t){let i=e.delimiter;if(i){let a=e.fullName.split(i);for(a.pop();a.length;){let e=a.join(i),t=a.pop(),o=Yt(e);o||(o=FolderModel.reviveFromJson({"@Object":"Object/Folder",name:t,fullName:e,delimiter:i,attributes:["\\nonexistent"]}),Jt(o),s.splice(r,0,o),++r)}t=Yt(e.parentName)}}t&&(t.subFolders.unshift(e),s.splice(r,1))}}catch(e){}}return s}storeIt(){es.displaySpecSetting(F.app("folderSpecLimit")<this.CountRec),M("SentFolder")+M("DraftsFolder")+M("JunkFolder")+M("TrashFolder")+M("ArchiveFolder")||es.saveSystemFolders(ki),es.folderList(this),es.namespace=this.namespace,xt.threadsAllowed(!!this.capabilities.some((e=>e.startsWith("THREAD=")))),es.quotaUsage(this.quotaUsage),es.quotaLimit(this.quotaLimit),es.capabilities(this.capabilities),es.sentFolder(Ei(ki.Sent)),es.draftsFolder(Ei(ki.Drafts)),es.spamFolder(Ei(ki.Junk)),es.trashFolder(Ei(ki.Trash)),es.archiveFolder(Ei(ki.Archive))}}class FolderModel extends AbstractModel{constructor(){super(),this.fullName="",this.delimiter="",this.deep=0,this.expires=0,this.metadata={},this.exists=!0,this.etag="",this.id=0,this.uidNext=0,Ee(this,{name:"",type:0,role:null,selectable:!1,focused:!1,selected:!1,editing:!1,isSubscribed:!0,checkable:!1,askDelete:!1,nameForEdit:"",errorMsg:"",totalEmails:0,unreadEmails:0,kolabType:null,collapsed:!0,tagsAllowed:!1}),this.attributes=ko.observableArray(),this.permanentFlags=ko.observableArray(),this.addSubscribables({kolabType:e=>this.metadata[Le]=e,permanentFlags:e=>this.tagsAllowed(e.includes("\\*")),editing:e=>e&&this.nameForEdit(this.name()),unreadEmails:e=>Me.Inbox===this.type()&&R("mailbox.inbox-unread-count",e)}),this.subFolders=ko.observableArray(new FolderCollectionModel),this.actionBlink=ko.observable(!1).extend({falseTimeout:1e3}),this.addComputables({isInbox:()=>Me.Inbox===this.type(),isFlagged:()=>es.currentFolder()===this&&Gs.listSearch().includes("flagged"),hasVisibleSubfolders:()=>!!this.subFolders().find((e=>e.visible())),hasSubscriptions:()=>this.isSubscribed()|!!this.subFolders().find((e=>{const t=e.hasSubscriptions();return!e.isSystemFolder()&&t})),canBeEdited:()=>!this.type()&&this.exists,isSystemFolder:()=>this.type()|(es.allowKolab()&&!!this.kolabType()&!He.unhideKolabFolders()),canBeSelected:()=>this.selectable()&&!this.isSystemFolder(),canBeDeleted:()=>this.canBeSelected()&&this.exists,canBeSubscribed:()=>this.selectable()&&!(this.isSystemFolder()|!He.hideUnsubscribed()),visible:()=>{const e=this.canBeSelected(),t=this.name(),s=Fi(),i=this.isSubscribed()|!He.hideUnsubscribed()&&e&&(!s||t.toLowerCase().includes(s.toLowerCase()));return this.hasVisibleSubfolders()|i},unreadCount:()=>this.unreadEmails()||null,localName:()=>{let e=this.name();return this.isSystemFolder()&&(ce(),e=Ai(this.type(),e)),e},nameInfo:()=>{if(this.isSystemFolder()){ce();let t=Ai(this.type(),(e=this.kolabType(),Ci[e]?"Kolab "+he("SETTINGS_FOLDERS/TYPE_"+Ci[e]):""));if(this.name()!==t&&"inbox"!==t.toLowerCase())return" ("+t+")"}var e;return""},detailedName:()=>this.name()+" "+this.nameInfo(),hasSubscribedUnreadMessagesSubfolders:()=>!!this.subFolders().find((e=>e.unreadCount()|e.hasSubscribedUnreadMessagesSubfolders()))})}edit(){this.canBeEdited()&&this.editing(!0)}unedit(){this.editing(!1)}rename(){const e=this,t=e.nameForEdit().trim();t&&e.name()!==t&&Ms.abort("Folders").post("FolderRename",es.foldersRenaming,{folder:e.fullName,newFolderName:t,subscribe:e.isSubscribed()?1:0}).then((s=>{if(e.name(t),e.subFolders.length)Ms.setTrigger(es.foldersLoading,!0),setTimeout(Mi,500);else{Zt(e.fullName),e.fullName=s.Result.fullName,Jt(e);const t=Yt(e.parentName);pi(t?t.subFolders:es.folderList)}})).catch((e=>{es.folderListError(fe(e.code,"",c.CantRenameFolder)+".\n"+e.message)})),e.editing(!1)}get fullNameHash(){return this.fullName.replace(/[^a-z0-9._-]+/giu,v)}static reviveFromJson(e){const t=super.reviveFromJson(e);if(t){const e=t.fullName.split(t.delimiter),s=e=>t.attributes.includes(e),i=(t.metadata[Le]||t.metadata[Pe]||"").split(".")[0];t.deep=e.length-1,e.pop(),t.parentName=e.join(t.delimiter),t.isSubscribed(s("\\subscribed")),t.exists=!s("\\nonexistent"),t.selectable(t.exists&&!s("\\noselect")),i&&"mail"!=i&&t.kolabType(i)}return t}collapsedCss(){return"e-collapsed-sign "+(this.hasVisibleSubfolders()?this.collapsed()?"icon-right-mini":"icon-down-mini":"icon-none")}}const Li=()=>"messages"===Oi?.action,Pi=()=>"sortable"===Oi?.action,Ii=(e,t,s,i,r)=>{Oi={action:t,data:i},e.dataTransfer.setData("text/plain","snappymail/action/"+t),e.dataTransfer.setDragImage(r,0,0),e.dataTransfer.effectAllowed=s},xi={id:0},Ni=(e,t)=>{e.preventDefault(),t?.classList.remove("droppableHover"),xi.node==t&&(xi.node=null,clearTimeout(xi.id))},Di=(e,t)=>me(e,ko.unwrap(t()));let Ri,Oi;Object.assign(ko.bindingHandlers,{editor:{init:(e,t)=>{let s=null;const i=t(),r=()=>i.__editor?.setHtmlOrPlain(i()),a=()=>i.__editor&&i(i.__editor.getDataWithHtmlMark()),o=()=>{i.__editor=s,r()};ko.isObservable(i)&&(s=new HtmlEditor(e,a,o,a),i.__fetchEditorValue=a,i.subscribe(r))}},moment:{init:Di,update:Di},emailsTags:{init:(e,t,s)=>{const i=t(),r=i.focused;e.addresses=new EmailAddressesComponent(e,{focusCallback:e=>r?.(!!e),autoCompleteSource:s.get("autoCompleteSource"),onChange:e=>i(e)}),r?.subscribe((t=>e.addresses[t?"focus":"blur"]()))},update:(e,t)=>{e.addresses.value=ko.unwrap(t())}},dragmessages:{init:e=>{e.addEventListener("dragstart",(e=>{if(Ri||(Ri=A("messagesDragImage")),Ri&&!Ue.isMobile()){ko.dataFor(k.elementFromPoint(e.clientX,e.clientY))?.checked?.(!0);const t=Gs.listCheckedOrSelectedUidsWithSubMails();Ri.querySelector(".text").textContent=t.size,Ri.style.left=e.clientX+"px",Ri.style.top=e.clientY+"px",Ri.style.right="auto",Ii(e,"messages","copyMove",t,Ri),Ri.style.cssText="",x(!1)}else e.preventDefault()}),!1),e.addEventListener("dragend",(()=>Oi=null))}},dropmessages:{init:(e,t)=>{const s=t();s&&B(e,{dragenter:t=>((e,t,s)=>{let i=!1;for(const t of e.dataTransfer.items)i|="file"===t.kind&&"message/rfc822"===t.type;(i||Li())&&(e.stopPropagation(),Ni(e,xi.node),e.dataTransfer.dropEffect=i||e.ctrlKey?"copy":"move",t.classList.add("droppableHover"),s.collapsed()&&(xi.node=t,xi.id=setTimeout((()=>{s.collapsed(!1),Ti(s.fullName,!0)}),500)))})(t,e,s),dragover:e=>e.preventDefault(),dragleave:t=>Ni(t,e),drop:t=>((e,t,s,i)=>{Ni(e,t),Li()&&"copyMove"==e.dataTransfer.effectAllowed?Si(es.currentFolderFullName(),i.data,s.fullName,e.ctrlKey):e.dataTransfer.types.includes("Files")&&wi(s.fullName,e.dataTransfer.files)})(t,e,s,Oi)})}},sortableItem:{init:(e,t)=>{let s=ko.unwrap(t())||{},i=e.parentNode,r=e=>{if(Pi()){e.preventDefault();let t=(e.target.closest?e.target:e.target.parentNode).closest("[draggable]");if(t&&t!==Oi.data&&i.contains(t)){let s=t.getBoundingClientRect();s.top+s.height/2<=e.clientY?t.nextElementSibling!==Oi.data&&t.after(Oi.data):t.previousElementSibling!==Oi.data&&t.before(Oi.data)}}};B(e,{dragstart:t=>{Oi={action:"sortable",element:e},Ii(t,"sortable","move",e,e),e.style.opacity=.25},dragend:()=>{if(e.style.opacity=null,Pi()){Oi.data.style.cssText="";let t=i.rows[s.list.indexOf(ko.dataFor(e))];t!=Oi.data&&t.before(Oi.data),Oi=null}}}),i.sortable||(i.sortable=!0,B(i,{dragenter:r,dragover:r,drop:e=>{if(Pi()){e.preventDefault();let t=ko.dataFor(Oi.data),r=s.list.indexOf(t),a=[...i.children].indexOf(Oi.data);if(r!=a){let e=s.list();e.splice(a,0,...e.splice(r,1)),s.list(e)}Oi=null,s.afterMove?.()}}}))}},initDom:{init:(e,t)=>t()(e)},registerBootstrapDropdown:{init:e=>{P.push(e),e.ddBtn=new BSN.Dropdown(e.querySelector(".dropdown-toggle"))}},openDropdownTrigger:{update:(e,t)=>{if(ko.unwrap(t())){const s=e.ddBtn;s.open||s.toggle(),Xs(),t()(!1)}}}});const _i=Fe();_i.loading=ko.observable(!1).extend({debounce:200}),_i.importing=ko.observable(!1).extend({debounce:200}),_i.syncing=ko.observable(!1).extend({debounce:200}),Ee(_i,{allowSync:!1,syncMode:0,syncUrl:"",syncUser:"",syncPass:""}),_i.hasChecked=we((()=>!!_i.find((e=>e.checked())))),_i.sync=e=>{!_i.syncMode()||_i.importing()||_i.syncing()||(_i.syncing(!0),Ms.streamPerLine((t=>{try{"ContactsSync"===(t=JSON.parse(t)).Action&&(_i.syncing(!1),e?.(t.ErrorCode,t))}catch(t){_i.syncing(!1),e?.(c.UnknownError)}}),"ContactsSync"))},_i.init=()=>{let e=M("ContactsSync");_i.allowSync(!!e),e&&(_i.syncMode(e.Mode),_i.syncUrl(e.Url),_i.syncUser(e.User),_i.syncPass(e.Password),setTimeout(_i.sync,1e4),setInterval(_i.sync,6e4*e.Interval+5e3))};const Ui=Fe();Ui.loading=ko.observable(!1).extend({debounce:100});class AbstractView{constructor(e,t){this.viewModelTemplateID=e||this.constructor.name.replace("UserView",""),this.viewType=t,this.viewModelDom=null,this.keyScope={scope:"none",previous:"none",set:function(){this.previous=K(),K(this.scope)},unset:function(){K(this.previous)}}}querySelector(e){return this.viewModelDom.querySelector(e)}addObservables(e){Ee(this,e)}addComputables(e){ke(this,e)}addSubscribables(e){Ce(this,e)}}class AbstractViewPopup extends AbstractView{constructor(e){super("Popups"+e,Ft),this.keyScope.scope=e,this.modalVisible=ko.observable(!1).extend({rateLimit:0}),this.close=()=>this.modalVisible(!1),U("escape,close","",e,(()=>(this.modalVisible()&&!1!==this.onClose()&&this.close(),!1)))}onClose(){}}AbstractViewPopup.showModal=function(e=[]){Mt(this,e)},AbstractViewPopup.hidden=function(){return!this.__vm||!this.__vm.modalVisible()};class AbstractViewLeft extends AbstractView{constructor(e){super(e,"left"),this.leftPanelDisabled=x,this.toggleLeftPanel=N}}class AbstractViewRight extends AbstractView{constructor(e){super(e,"right")}}class AbstractViewSettings{addSetting(e,t){let s=e[0].toLowerCase()+e.slice(1),i=s+"Trigger";Ee(this,{[s]:M(e),[i]:o}),Ce(this,{[s]:(s=>{this[i](a),t?.(s),rl.app.Remote.saveSetting(e,s,(e=>{this[i](e?l:n),setTimeout((()=>this[i](o)),1e3)}))}).debounce(999)})}addSettings(e){e.forEach((e=>{let t=e[0].toLowerCase()+e.slice(1);this[t]||(this[t]=ko.observable(M(e))),this[t].subscribe((t=>rl.app.Remote.saveSetting(e,t)))}))}}class AbstractViewLogin extends AbstractView{constructor(e){super(e,"content"),this.formError=ko.observable(!1).extend({falseTimeout:500})}onBuild(e){e.classList.add("LoginView")}onShow(){A("rl-left").hidden=!0,A("rl-right").hidden=!0,rl.route.off()}onHide(){A("rl-left").hidden=!1,A("rl-right").hidden=!1}submitForm(){}}class OpenPgpKeyPopupView extends AbstractViewPopup{constructor(){super("OpenPgpKey"),Ee(this,{key:"",keyDom:null})}selectKey(){const e=this.keyDom();if(e){let t=getSelection(),s=k.createRange();t.removeAllRanges(),s.selectNodeContents(e),t.addRange(s)}navigator.clipboard&&navigator.clipboard.writeText(this.key()).then((()=>{}),(e=>{}))}onShow(e){this.key(e?e.armor:"")}onBuild(){U("a","meta","OpenPgpKey",(()=>(this.selectKey(),!1)))}}class AskPopupView extends AbstractViewPopup{constructor(){super("Ask"),Ee(this,{askDesc:"",yesButton:"",noButton:"",username:"",askUsername:!1,passphrase:"",askPass:!1,remember:!0,askRemeber:!1}),this.fYesAction=null,this.fNoAction=null,this.focusOnShow=!0}yesClick(){this.close(),u(this.fYesAction)&&this.fYesAction(this)}noClick(){this.close(),u(this.fNoAction)&&this.fNoAction(this)}onShow(e,t=null,s=null,i=!0,r=0,a=""){this.askDesc(e||""),this.askUsername(2&r),this.askPass(1&r),this.askRemeber(4&r),this.username(""),this.passphrase(""),this.remember(!0),this.yesButton(he(a||"GLOBAL/YES")),this.noButton(he(r?"GLOBAL/CANCEL":"GLOBAL/NO")),this.fYesAction=t,this.fNoAction=s,this.focusOnShow=i?r?'input[type="'+(2&r?"text":"password")+'"]':".buttonYes":""}afterShow(){this.focusOnShow&&this.querySelector(this.focusOnShow).focus()}onClose(){return this.noClick(),!1}onBuild(){shortcuts.add("tab,arrowright,arrowleft","","Ask",(()=>{let e=this.querySelector(".buttonYes"),t=this.querySelector(".buttonNo");return e.matches(":focus")?(t.focus(),!1):t.matches(":focus")?(e.focus(),!1):void 0}))}}AskPopupView.password=function(e,t){return new Promise((s=>{this.showModal([e,e=>s({password:e.passphrase(),remember:e.remember()}),()=>s(null),!0,5,t])}))},AskPopupView.credentials=function(e,t){return new Promise((s=>{this.showModal([e,e=>s({username:e.username(),password:e.passphrase(),remember:e.remember()}),()=>s(null),!0,3,t])}))};const Vi=new Map,qi=async(e,t="LABEL_SIGN")=>{const s=e.id,i=Vi.has(s)?{password:Vi.get(s),remember:!1}:await AskPopupView.password("GnuPG key<br>"+s+" "+e.emails[0],"OPENPGP/"+t);return i&&i.remember&&Vi.set(s,i.password),i.password},Bi=(e,t)=>e.find((e=>(e.can_sign||e.can_decrypt)&&(e.emails.includes(t)||e.subkeys.find((e=>t==e.keyid||t==e.fingerprint))))),Hi=new class{constructor(){this.keyring,this.publicKeys=ko.observableArray(),this.privateKeys=ko.observableArray()}loadKeyrings(){this.keyring=null,this.publicKeys([]),this.privateKeys([]),Ms.request("GnupgGetKeys",((e,t)=>{if(t?.Result){this.keyring=t.Result;const e=(e,t)=>{const s=[];return e.id=e.subkeys[0].keyid,e.fingerprint=e.subkeys[0].fingerprint,e.uids.forEach((e=>e.email&&s.push(e.email))),e.emails=s,e.askDelete=ko.observable(!1),e.openForDeletion=ko.observable(null).askDeleteHelper(),e.remove=()=>{e.askDelete()&&Ms.request("GnupgDeleteKey",((s,i)=>{i&&(s?alert(i.ErrorMessage):i.Result&&(t?this.privateKeys.remove(e):this.publicKeys.remove(e)))}),{keyId:e.id,isPrivate:t})},e.view=()=>{const s=s=>Ms.request("GnupgExportKey",((t,s)=>{s?.Result?(e.armor=s.Result,Mt(OpenPgpKeyPopupView,[e])):Vi.delete(e.id)}),{keyId:e.id,isPrivate:t,passphrase:s});t?qi(e,"POPUP_VIEW_TITLE").then((e=>{null!==e&&s(e)})):s("")},e};this.publicKeys(t.Result.public.map((t=>e(t,0)))),this.privateKeys(t.Result.private.map((t=>e(t,1))))}}))}isSupported(){return L("GnuPG")}importKey(e,t){Ms.request("GnupgImportKey",((e,s)=>{s?.Result&&this.loadKeyrings(),t?.(e,s)}),{key:e})}storeKeyPair(e,t){Ms.request("PgpStoreKeyPair",((e,s)=>{s?.Result,t?.(e,s)}),e)}hasPublicKeyForEmails(e){const t=e.length,s=t?e.filter((e=>this.publicKeys.find((t=>t.emails.includes(e))))).length:0;return s&&s===t}getPublicKeyFingerprints(e){const t=[];return e.forEach((e=>{t.push(this.publicKeys.find((t=>t.emails.includes(e))).fingerprint)})),t}getPrivateKeyFor(e,t){return Bi(this.privateKeys,e)}async decrypt(e){const t=e.pgpEncrypted();if(t){let s,i=[e.to[0].email].concat(t.keyIds),r=i.length;for(;r--&&(s=Bi(this.privateKeys,i[r]),!s););if(s){let i={folder:e.folder,uid:e.uid,partId:t.partId,keyId:s.id,passphrase:await qi(s,"BUTTON_DECRYPT"),data:""};if(null!==i.passphrase){const e=await Ms.post("GnupgDecrypt",null,i);if(e?.Result&&!1!==e.Result.data)return e.Result;Vi.delete(s.id)}}}}async verify(e){let t=e.pgpSigned();if(t){t={...t},t.folder=e.folder,t.uid=e.uid,t.bodyPart&&(t.bodyPart=t.bodyPart.raw,t.sigPart=t.sigPart.body);let s=await Ms.post("MessagePgpVerify",null,t);if(s?.Result)return{fingerprint:s.Result.fingerprint,success:0==s.Result.status}}}async sign(e){return await qi(e)}},Ki=(e,t)=>e.find((e=>e.emails.includes(t)||t==e.id||t==e.fingerprint)),Gi=async(e,t="LABEL_SIGN")=>{if(e.key.isDecrypted())return e.key;const s=e.id,i=Vi.has(s)?{password:Vi.get(s),remember:!1}:await AskPopupView.password("OpenPGP.js key<br>"+s+" "+e.emails[0],"OPENPGP/"+t);if(i){const t=i.password,r=await openpgp.decryptKey({privateKey:e.key,passphrase:t});return r&&i.remember&&Vi.set(s,t),r}},ji="openpgp-public-keys",Wi="openpgp-private-keys",$i=window.localStorage,Ji=async e=>{let t,s=[],i=JSON.parse($i.getItem(e)),r=h(i);for(;r--;)t=await openpgp.readKey({armoredKey:i[r]}),t.err||s.push(new OpenPgpKeyModel(i[r],t));return s},zi=(e,t)=>{let s=e.map((e=>e.armor));s.length?$i.setItem(t,JSON.stringify(s)):$i.removeItem(t)};class OpenPgpKeyModel{constructor(e,t){this.key=t;const s=[];t.users&&t.users.forEach((e=>e.userID.email&&s.push(e.userID.email))),this.id=t.getKeyID().toHex().toUpperCase(),this.fingerprint=t.getFingerprint(),this.can_encrypt=!!t.getEncryptionKey(),this.can_sign=!!t.getSigningKey(),this.emails=s,this.armor=e,this.askDelete=ko.observable(!1),this.openForDeletion=ko.observable(null).askDeleteHelper()}view(){Mt(OpenPgpKeyPopupView,[this])}remove(){this.askDelete()&&(this.key.isPrivate()?(Yi.privateKeys.remove(this),zi(Yi.privateKeys,Wi)):(Yi.publicKeys.remove(this),zi(Yi.publicKeys,ji)))}}const Yi=new class{constructor(){this.publicKeys=ko.observableArray(),this.privateKeys=ko.observableArray()}loadKeyrings(){window.openpgp&&(Ji(ji).then((e=>{this.publicKeys(e||[])})),Ji(Wi).then((e=>{this.privateKeys(e||[])})))}isSupported(){return!!window.openpgp}importKey(e){window.openpgp&&openpgp.readKey({armoredKey:e}).then((t=>{t.err||(t.isPrivate()?(this.privateKeys.push(new OpenPgpKeyModel(e,t)),zi(this.privateKeys,Wi)):(this.publicKeys.push(new OpenPgpKeyModel(e,t)),zi(this.publicKeys,ji)))}))}storeKeyPair(e){window.openpgp&&(openpgp.readKey({armoredKey:e.publicKey}).then((t=>{this.publicKeys.push(new OpenPgpKeyModel(e.publicKey,t)),zi(this.publicKeys,ji)})),openpgp.readKey({armoredKey:e.privateKey}).then((t=>{this.privateKeys.push(new OpenPgpKeyModel(e.privateKey,t)),zi(this.privateKeys,Wi)})))}hasPublicKeyForEmails(e){const t=e.length,s=t?e.filter((e=>this.publicKeys().find((t=>t.emails.includes(e))))).length:0;return s&&s===t}getPrivateKeyFor(e){return Ki(this.privateKeys,e)}async decrypt(e,t){const s=await openpgp.readMessage({armoredMessage:e}),i=this.privateKeys(),r=s.getEncryptionKeyIDs().map((e=>e.bytes));let a,o=i.length;for(;o--;)if((await i[o].key.getDecryptionKeys()).find((e=>r.includes(e.getKeyID().bytes)))){a=i[o];break}if(a)try{const e=await Gi(a,"BUTTON_DECRYPT");if(e){const i=Ki(this.publicKeys,t);return await openpgp.decrypt({message:s,verificationKeys:i?.key,decryptionKeys:e})}}catch(e){alert(e)}}async verify(e){const t=e.pgpSigned(),s=this.publicKeys().find((t=>t.emails.includes(e.from[0].email)));if(t&&s){let i;if(t.folder=e.folder,t.uid=e.uid,t.tryGnuPG=0,i=t.sigPartId?await Ms.post("MessagePgpVerify",null,t):t.bodyPart?{Result:{text:t.bodyPart.raw,signature:t.sigPart.body}}:{Result:{text:e.plain(),signature:null}},i){const e=i.Result.signature?await openpgp.readSignature({armoredSignature:i.Result.signature}):null,t=e?await openpgp.createMessage({text:i.Result.text}):await openpgp.readCleartextMessage({cleartextMessage:i.Result.text});let r=await openpgp.verify({message:t,verificationKeys:s.key,signature:e});return{fingerprint:s.fingerprint,success:r&&!!r.signatures.length}}}}async sign(e,t,s){const i=await Gi(t);if(i){const t=s?await openpgp.createMessage({text:e}):await openpgp.createCleartextMessage({text:e});return await openpgp.sign({message:t,signingKeys:i,detached:!!s})}throw"Sign cancelled"}async encrypt(e,t,s){const i=t.length;if(t=t.map((e=>this.publicKeys().find((t=>t.emails.includes(e))))).filter((e=>e)),i===t.length){if(s&&!(s=await Gi(s)))return;return await openpgp.encrypt({message:await openpgp.createMessage({text:e}),encryptionKeys:t.map((e=>e.key)),signingKeys:s})}throw"Encrypt failed"}};let Zi=null;const Xi="-----BEGIN PGP MESSAGE-----",Qi=new class{init(){L("OpenPGP")&&window.crypto&&crypto.getRandomValues?rl.loadScript(M("StaticLibsJs").replace("/libs.","/openpgp.")).then((()=>this.loadKeyrings())).catch((e=>{this.loadKeyrings()})):this.loadKeyrings()}loadKeyrings(e){if(e=e||M("Email"),window.mailvelope){const t=e=>{Zi=e};mailvelope.getKeyring().then(t,(s=>{e&&mailvelope.createKeyring(e).then(t,(e=>{}))})),addEventListener("mailvelope-disconnect",(e=>{alert("Mailvelope is updated to version "+e.detail.version+". Reload page")}),!1)}else addEventListener("mailvelope",(()=>this.loadKeyrings(e)));Yi.loadKeyrings(),L("GnuPG")&&Hi.loadKeyrings()}isSupported(){return!!(Yi.isSupported()||Hi.isSupported()||window.mailvelope)}isEncrypted(e){return 0===e.trim().indexOf(Xi)}async mailvelopeHasPublicKeyForEmails(e){const t=Zi&&await Zi.validKeyForAddress(e),s=t&&Object.entries(t);return s&&s.filter((e=>e[1])).length===e.length}async hasPublicKeyForEmails(e){if(e.length){if(Hi.hasPublicKeyForEmails(e))return"gnupg";if(Yi.hasPublicKeyForEmails(e))return"openpgp"}return!1}async getMailvelopePrivateKeyFor(e){return!(!Zi||!await Zi.hasPrivateKey({email:e}))&&["mailvelope",e]}async getKeyForSigning(e){let t=Yi.getPrivateKeyFor(e,1);return t?["openpgp",t]:(t=Hi.getPrivateKeyFor(e,1),t?["gnupg",t]:void 0)}async decrypt(e){const t=e.from[0].email,s=e.plain();if(!this.isEncrypted(s))throw Error("Not armored text");if(Yi.isSupported()){let e=await Yi.decrypt(s,t);if(e)return e}if(Zi)try{let i=[...e.from,...e.to,...e.cc].validUnique(),r=i.length;for(;r--;)if(await this.getMailvelopePrivateKeyFor(i[r].email)){const i=e.body;i.textContent="";let r=await mailvelope.createDisplayContainer("#"+i.id,s,Zi,{senderAddress:t});if(r){if(!r.error?.message)return i.classList.add("mailvelope"),!0;"PWD_DIALOG_CANCEL"!==r.error.code&&alert(r.error.code+": "+r.error.message)}break}}catch(e){}return Hi.decrypt(e)}async verify(e){const t=e.pgpSigned();if(t){const s=e.from[0].email,i=Hi.hasPublicKeyForEmails([s]),r=Yi.hasPublicKeyForEmails([s]);if(i&&t.sigPartId)return Hi.verify(e);if(r)return Yi.verify(e);if(i)return Hi.verify(e)}}};class AccountModel extends AbstractModel{constructor(e,t,s=!0){super(),this.name=t,this.email=e,this.displayName=t?t+" <"+e+">":e,Ee(this,{unreadEmails:null,askDelete:!1,isAdditional:s}),He.showUnreadCount()&&s&&setTimeout((()=>this.fetchUnread()),3e3*Math.ceil(10*Math.random()))}fetchUnread(){Ms.request("AccountUnread",((e,t)=>{e||this.unreadEmails(t?.Result?.unreadEmails||null)}),{email:this.email})}}class IdentityModel extends AbstractModel{constructor(){super(),Ee(this,{id:"",email:"",name:"",replyTo:"",bcc:"",signature:"",signatureInsertBefore:!1,askDelete:!1})}formattedName(){const e=this.name(),t=this.email();return e?e+" <"+t+">":t}}class AbstractScreen{constructor(e,t=[]){this.__cross=null,this.screenName=e,this.viewModels=d(t)?t:[]}routes(){return null}onStart(){const e=this.routes();if(h(e)){let t=new Crossroads,s=(this.onRoute||(()=>0)).bind(this);e.forEach((e=>e&&(t.addRoute(e[0],s).rules=e[1]))),this.__cross=t}}}class LanguagesPopupView extends AbstractViewPopup{constructor(){super("Languages"),this.fLang=null,this.languages=ko.observableArray()}onShow(e,t,s){this.fLang=e,this.languages(t.map((t=>({key:t,user:s===t,selected:e?.()===t,fullName:ve(t),title:ve(t,!0)}))))}changeLanguage(e){this.fLang?.(e),this.close()}}class LoginUserView extends AbstractViewLogin{constructor(){super(),Ee(this,{loadingDesc:M("loadingDescription"),email:M("DevEmail"),password:M("DevPassword"),signMe:!1,emailError:!1,passwordError:!1,submitRequest:!1,submitError:"",submitErrorAdditional:"",langRequest:!1,signMeType:2}),this.allowLanguagesOnLogin=!!M("allowLanguagesOnLogin"),this.language=ie.language,this.languages=ie.languages,this.bSendLanguage=!1,ke(this,{languageFullName:()=>ve(this.language()),signMeVisibility:()=>2!==this.signMeType()}),Ce(this,{email:()=>this.emailError(!1),password:()=>this.passwordError(!1),submitError:e=>e||this.submitErrorAdditional(""),signMeType:e=>this.signMe(1===e),language:e=>{this.langRequest(!0),ye(e).then((()=>{this.langRequest(!1),this.bSendLanguage=!0}),(()=>this.langRequest(!1)))}}),M("AdditionalLoginError")&&!this.submitError()&&this.submitError(M("AdditionalLoginError")),It(this,{submitCommand:e=>!e.submitRequest()})}hideError(){this.submitError("")}toggleSignMe(){this.signMe(!this.signMe())}submitCommand(e,t){const s=this.email().trim();this.email(s);let i=t.target.form,r=new FormData(i),a=i.reportValidity()&&R("sm-user-login",r,1);return this.emailError(!s),this.passwordError(!this.password()),this.formError(!a),a&&(this.submitRequest(!0),r.set("language",this.bSendLanguage?this.language():""),r.set("signMe",this.signMe()?1:0),Ms.request("Login",((e,t)=>{R("sm-user-login-response",{error:e,data:t}),e?(this.submitRequest(!1),c.InvalidInputArgument==e&&(e=c.AuthError),this.submitError(fe(e,t?.ErrorMessage,c.UnknownNotification)),this.submitErrorAdditional(t?.ErrorMessageAdditional)):rl.setData(t.Result)}),r),zs(7,this.signMe()?"-1-":"-0-")),a}onBuild(e){super.onBuild(e);const t=(M("signMe")||"").toLowerCase();switch(t){case"defaultoff":case"defaulton":switch(this.signMeType("defaulton"===t?1:0),Ys(7)){case"-1-":this.signMeType(1);break;case"-0-":this.signMeType(0)}break;default:this.signMeType(2)}}selectLanguage(){Mt(LanguagesPopupView,[this.language,this.languages(),ie.userLanguage()])}}class LoginUserScreen extends AbstractScreen{constructor(){super("login",[LoginUserView])}onShow(){rl.setTitle()}}class KeyboardShortcutsHelpPopupView extends AbstractViewPopup{constructor(){super("KeyboardShortcutsHelp"),this.metaKey=shortcuts.getMetaKey()}onBuild(e){const t=e.querySelectorAll(".tabs input"),s=t.length-1;U("tab,arrowleft,arrowright","","KeyboardShortcutsHelp",(e=>{let i=0;return t.forEach(((t,r)=>{t.matches(":checked")&&(i=["Tab","ArrowRight"].includes(e.key)?r<s?r+1:0:r?r-1:s)})),t[i].checked=!0,!1}))}}class AccountPopupView extends AbstractViewPopup{constructor(){super("Account"),Ee(this,{isNew:!0,name:"",email:"",password:"",submitRequest:!1,submitError:"",submitErrorAdditional:""})}hideError(){this.submitError("")}submitForm(e){if(!this.submitRequest()&&e.reportValidity()){const t=new FormData(e);t.set("new",this.isNew()?1:0),this.submitRequest(!0),Ms.request("AccountSetup",((e,t)=>{this.submitRequest(!1),e?(this.submitError(fe(e)),this.submitErrorAdditional(t?.ErrorMessageAdditional)):(rl.app.accountsAndIdentities(),this.close())}),t)}}onHide(){this.password(""),this.submitRequest(!1),this.submitError(""),this.submitErrorAdditional("")}onShow(e){let t=e?.isAdditional();this.isNew(!t),this.name(t?e.name:""),this.email(t?e.email:"")}}let er;class Selector{constructor(e,t,s,i,r,a){s=(s||ko.observable(null)).extend({toggleSubscribeProperty:[this,"focused"]}),t=(t||ko.observable(null)).extend({toggleSubscribeProperty:[null,"selected"]}),this.list=e,this.listChecked=we((()=>e.filter((e=>e.checked())))).extend({rateLimit:0}),this.focusedItem=s,this.selectedItem=t,this.iSelectNextHelper=0,this.iFocusedNextHelper=0,this.sItemSelector=i,this.sItemCheckedSelector=r,this.sItemFocusedSelector=a,this.sLastUid="",this.oCallbacks={};const o=t=>{e.hasChecked()?t||this.oCallbacks.ItemSelect?.(null):t&&this.oCallbacks.ItemSelect?.(t)},n=(e=>o(e)).debounce(300);this.listChecked.subscribe((e=>{e.length?t()?t(null):t.valueHasMutated?.():this.autoSelect()&&t(s())}));let l=!0;t.subscribe((t=>{t?(e.forEach((e=>e.checked(!1))),l&&n(t)):l&&o()})),s.subscribe((e=>e&&(this.sLastUid=this.getItemUid(e))));let c=[],h=null,u=null;e.subscribe((e=>{d(e)&&e.forEach((e=>{const t=this.getItemUid(e);t&&(e.checked()&&c.push(t),!h&&e.focused()&&(h=t),!u&&e.selected()&&(u=t))}))}),this,"beforeChange"),e.subscribe((e=>{if(l=!1,this.unselect(),d(e)){let i,r;e.forEach((e=>{const i=this.getItemUid(e);i&&(h===i&&(s(e),h=null),c.includes(i)&&(e.checked(!0),r=!0),r||u!==i||(t(e),u=null))})),l=!0,(this.iSelectNextHelper||this.iFocusedNextHelper)&&e.length&&!s()&&(i=null,this.iFocusedNextHelper&&(i=e[-1===this.iFocusedNextHelper?e.length-1:0]),!i&&this.iSelectNextHelper&&(i=e[-1===this.iSelectNextHelper?e.length-1:0]),i&&(this.iSelectNextHelper&&t(i),s(i),this.scrollToFocused(),setTimeout(this.scrollToFocused,100)),this.iSelectNextHelper=0,this.iFocusedNextHelper=0),!this.autoSelect()||r||t()||t(s())}c=[],h=null,u=null,l=!0}))}unselect(){this.selectedItem(null),this.focusedItem(null)}init(e,t="all"){if(this.oContentScrollable=e,e){let s=t=>{let s=event.target.closestWithin(t,e);return s?ko.dataFor(s):null};B(e,{click:t=>{let i=t.target.closestWithin(this.sItemSelector,e);i&&this.actionClick(ko.dataFor(i),t);const r=s(this.sItemCheckedSelector);r&&(t.shiftKey?this.actionClick(r,t):(this.focusedItem(r),r.checked(!r.checked())))},auxclick:e=>{if(1==e.button){const e=s(this.sItemSelector);e&&(this.focusedItem(e),this.oCallbacks.MiddleClick?.(e))}}}),V("enter,open","",t,(()=>{const e=this.focusedItem();if(e&&!e.selected())return this.actionClick(e),!1})),U("arrowup,arrowdown","meta",t,(()=>!1)),U("arrowup,arrowdown","shift",t,(e=>(this.newSelectPosition(e.key,!0),!1))),V("arrowup,arrowdown,home,end,pageup,pagedown,space","",t,(e=>(this.newSelectPosition(e.key,!1),!1)))}}autoSelect(){return(this.oCallbacks.AutoSelect||(()=>1))()&&this.focusedItem()}getItemUid(e){return e&&this.oCallbacks.ItemGetUid?.(e)?.toString()||""}newSelectPosition(e,t,s){let i,r="ArrowUp"===e||"ArrowDown"===e;const a=this.list(),o=a.length,n=this.focusedItem();if(t||(er=-1)," "===e)n?.checked(!n.checked());else if(o){if(n){if(r){let s=a.indexOf(n),r="ArrowUp"==e;t&&(er=-1<er?er:s,er==s?n.checked(!0):(r?er<s:er>s)&&n.checked(!1)),r?s>0&&(i=a[--s]):++s<o&&(i=a[s]),t&&i?.checked(!0),i||this.oCallbacks.UpOrDown?.(r)}else if("Home"===e)i=a[0];else if("End"===e)i=a[a.length-1];else if("PageDown"===e){let e=a.indexOf(n);e<o-1&&(i=a[Math.min(e+10,o-1)])}else if("PageUp"===e){let e=a.indexOf(n);e>0&&(i=a[Math.max(0,e-10)])}}else"Home"==e||"PageUp"==e?i=a[0]:"End"!==e&&"PageDown"!==e||(i=a[a.length-1]);i&&(this.focusedItem(i),!this.autoSelect()&&!s||this.list.hasChecked()||this.selectedItem(i),this.scrollToFocused())}}scrollToFocused(){const e=this.oContentScrollable;if(e){let t=e.querySelector(this.sItemFocusedSelector);if(t){const s=t.getBoundingClientRect(),i=e.getBoundingClientRect();s.top<i.top?t.scrollIntoView(!0):s.bottom>i.bottom&&t.scrollIntoView(!1)}else e.scrollTop=0}}scrollToTop(){this.oContentScrollable&&(this.oContentScrollable.scrollTop=0)}actionClick(e,t){if(e){let s=!0;if(t&&!t.altKey){if(t.shiftKey&&!t.ctrlKey&&!t.metaKey){const t=this.getItemUid(e);if(t&&this.sLastUid&&t!==this.sLastUid){let s=!1,i=!1,r=!e.checked(),a="";this.list().forEach((e=>{a=this.getItemUid(e),s=a===this.sLastUid||a===t,(i||s)&&(s&&(i=!i),e.checked(r))}))}return this.sLastUid=t,void this.focusedItem(e)}if(!t.shiftKey&&(t.ctrlKey||t.metaKey)){s=!1,this.focusedItem(e);const t=this.selectedItem();t&&e!==t&&t.checked(!0)}}s?this.selectMessageItem(e):e.checked(!e.checked())}}on(e,t){this.oCallbacks[e]=t}selectMessageItem(e){this.focusedItem(e),this.selectedItem(e),this.scrollToFocused()}}class VCardProperty{constructor(e,t,s,i="text"){if(this.field="",this.value="",this.type="",this.params={},void 0!==t&&"string"==typeof e)this.field=e,this.value=t,this.params=s||{},this.type=i;else{if(void 0!==t||void 0!==s||"object"!=typeof e)throw new Error("invalid Property constructor");this.parseFromJCardProperty(e)}}parseFromJCardProperty(e){e=JSON.parse(JSON.stringify(e)),this.field=e[0].toLowerCase(),this.params=e[1],this.type=e[2],this.value=e[3]}addParam(e,t){Array.isArray(this.params[e])?this.params[e].push(t):null!=this.params[e]?this.params[e]=[this.params[e],t]:this.params[e]=t}getValue(){return""+this.value}pref(){return this.params.pref||100}tags(){return this.params.type||[]}isEmpty(){return!(null!=this.value&&/[^;]+/.test(this.value)||Object.keys(this.params).length)}notEmpty(){return!this.isEmpty()}getField(){return""+this.field}toString(){return JSON.stringify(this)}toJSON(){return[this.field,this.params,this.type||"text",this.value]}}class JCard{constructor(e){if(this.props=new Map,this.version="4.0",e){if("object"!=typeof e)throw new Error("error reading vcard");this.parseFromJCard(e)}}parseFromJCard(e){if(e=JSON.parse(JSON.stringify(e)),!/vcard/i.test(e[0]))throw new SyntaxError("Incorrect jCard format");e[1].forEach((e=>this.add(new VCardProperty(e))))}get(e,t){if(t){let s=this.props.get(e);return s?s.filter((e=>{let s=e.type;return(Array.isArray(s)?s:[s]).includes(t)})):[]}return this.props.get(e)||[]}getOne(e,t){return this.get(e,t||"pref")[0]||this.get(e)[0]}set(e,t,s,i){if("string"==typeof e&&(e=new VCardProperty(String(e),t,s,i)),!(e instanceof VCardProperty))throw new Error("invalid argument of VCard.set(), expects string arguments or a VCardProperty");let r=e.getField();return this.props.set(r,[e]),e}add(e,t,s,i){if("string"==typeof e&&(e=new VCardProperty(String(e),t,s,i)),!(e instanceof VCardProperty))throw new Error("invalid argument of VCard.add(), expects string arguments or a VCardProperty");let r=e.getField();return this.props.get(r)?this.props.get(r)?.push(e):this.props.set(r,[e]),e}remove(e){if("string"==typeof e)this.props.delete(e);else{if(!(e instanceof VCardProperty))throw new Error("invalid argument of VCard.remove(), expects string and optional param filter or a VCardProperty");{let t=this.props.get(e.getField());if(!(null==t?void 0:t.includes(e)))throw new Error("Attempted to remove VCardProperty VCard does not have: ".concat(e));t.splice(t.indexOf(e),1),0===t.length&&this.props.delete(e.getField())}}}has(e){return!!this.props.get(e)&&this.props.get(e).length>0}toString(){return JSON.stringify(this)}toJSON(){let e=[["version",{},"text","4.0"]];for(const[t,s]of this.props.entries())if("version"!==t)for(const t of s)t.isEmpty()||e.push(t.toJSON());return["vcard",e]}parseFullName(e){let t=this.getOne("n");if(void 0===t)throw new Error("'fn' VCardProperty not present in card, cannot parse full name");let s="";[3,1,2,0,4].forEach((e=>{let i=t.value[e];i&&(s+=" "+i.replace(","," "))})),s=s.trim();let i=new VCardProperty("fn",s);return e?.set&&(e.append?this.add(i):this.set(i)),i}}const tr=["surName","givenName","middleName","namePrefix","nameSuffix"];class ContactModel extends AbstractModel{constructor(){super(),this.jCard=["vcard",[]],Ee(this,{focused:!1,selected:!1,checked:!1,deleted:!1,readOnly:!1,id:0,givenName:"",surName:"",middleName:"",namePrefix:"",nameSuffix:"",nickname:null,note:null,org:"",department:"",title:"",encryptpref:"",signpref:""}),this.email=ko.observableArray(),this.tel=ko.observableArray(),this.url=ko.observableArray(),this.adr=ko.observableArray(),ke(this,{fullName:()=>[this.namePrefix(),this.givenName(),this.middleName(),this.surName()].join(" ").trim(),display:()=>{let e=this.fullName(),t=this.email()[0]?.value(),s=this.nickname();return e||t||s}})}getNameAndEmailHelper(){let e=(this.givenName()+" "+this.surName()).trim(),t=this.email()[0]?.value();return t?[t,e]:null}static reviveFromJson(e){const t=super.reviveFromJson(e);if(t){let s=new JCard(e.jCard),i=s.getOne("n")?.value;i&&i.forEach(((e,s)=>e&&t[tr[s]](e))),["nickname","note","title"].forEach((e=>{i=s.getOne(e),i&&t[e](i.value)})),(i=s.getOne("org")?.value)&&(t.org(i[0]),t.department(i[1]||"")),["email","tel","url"].forEach((e=>{i=s.get(e),i&&i.forEach((s=>{t[e].push({value:ko.observable(s.value)})}))})),i=s.get("adr"),i&&i.forEach((e=>{t.adr.push({street:ko.observable(e.value[2]),street_ext:ko.observable(e.value[1]),locality:ko.observable(e.value[3]),region:ko.observable(e.value[4]),postcode:ko.observable(e.value[5]),pobox:ko.observable(e.value[0]),country:ko.observable(e.value[6]),preferred:ko.observable(e.params.pref),type:ko.observable(e.params.type)})})),i=s.getOne("x-crypto"),t.signpref(i?.params.signpref||"Ask"),t.encryptpref(i?.params.encryptpref||"Ask"),t.jCard=e.jCard}return t}generateUid(){return""+this.id}addEmail(){this.email.push({value:ko.observable("")})}addTel(){this.tel.push({value:ko.observable("")})}addUrl(){this.url.push({value:ko.observable("")})}addNickname(){this.nickname()||this.nickname("")}addNote(){this.note()||this.note("")}hasChanges(){return this.email().filter((e=>e.length)).length&&this.toJSON().jCard!=JSON.stringify(this.jCard)}toJSON(){let e=new JCard(this.jCard);if(e.set("n",[this.surName(),this.givenName(),this.middleName(),this.namePrefix(),this.nameSuffix()]),["nickname","note","title"].forEach((t=>this[t]()?e.set(t,this[t]()):e.remove(t))),this.org()){let t=[this.org()];this.department()&&t.push(this.department());let s=e.getOne("org");s?s.value=t:e.set("org",t)}else e.remove("");return["email","tel","url"].forEach((t=>{let s=this[t].map((e=>e.value()));e.get(t).forEach((t=>{let i=s.indexOf(t.value);0>i||!t.value?e.remove(t):s.splice(i,1)})),s.forEach((s=>s&&e.add(t,s)))})),e.set("x-crypto","",{allowed:"PGP/INLINE,PGP/MIME,S/MIME,S/MIMEOpaque",signpref:this.signpref(),encryptpref:this.encryptpref()},"x-crypto"),{uid:this.id,jCard:JSON.stringify(e)}}lineAsCss(){return(this.selected()?"selected":"")+(this.deleted()?" deleted":"")+(this.checked()?" checked":"")+(this.focused()?" focused":"")}}const sr="Contacts";let ir,rr=!1,ar="";class ContactsPopupView extends AbstractViewPopup{constructor(){super("Contacts"),Ee(this,{search:"",contactsCount:0,selectorContact:null,importButton:null,contactsPage:1,isSaving:!1,contact:null}),this.contacts=_i,this.useCheckboxesInList=He.useCheckboxesInList,this.selector=new Selector(_i,this.selectorContact,null,".e-contact-item .actionHandle",".e-contact-item .checkboxItem",".e-contact-item.focused"),this.selector.on("ItemSelect",(e=>this.populateViewContact(e))),this.selector.on("ItemGetUid",(e=>e?e.generateUid():"")),ke(this,{contactsPaginator:ti(this.contactsPage,(()=>Math.max(1,Math.ceil(this.contactsCount()/50)))),contactsCheckedOrSelected:()=>{const e=_i.filter((e=>e.checked())),t=this.selectorContact();return e.length?e:t?[t]:[]},contactsSyncEnabled:()=>_i.allowSync()&&_i.syncMode(),isBusy:()=>_i.syncing()|_i.importing()|_i.loading()|this.isSaving()}),this.search.subscribe((()=>this.reloadContactList())),this.saveCommand=this.saveCommand.bind(this),It(this,{deleteCommand:e=>!e.isBusy()&&0<e.contactsCheckedOrSelected().length,newMessageCommand:e=>!e.isBusy()&&0<e.contactsCheckedOrSelected().length,saveCommand:e=>!e.isBusy(),syncCommand:e=>!e.isBusy()})}newContact(){this.populateViewContact(new ContactModel),this.selectorContact(null)}deleteCommand(){const e=this.contactsCheckedOrSelected();if(e.length){let t=this.selectorContact(),s=[],i=0;e.forEach((e=>{s.push(e.id()),t&&t.id()===e.id()&&this.selectorContact(t=null),e.deleted(!0),++i})),Ms.request("ContactsDelete",((e,t)=>{if(e)alert(t?.ErrorMessage||fe(e));else{const e=this.contactsPage();e>Math.max(1,Math.ceil((this.contactsCount()-i)/50))&&this.contactsPage(e-1)}this.reloadContactList()}),{uids:s.join(",")})}}newMessageCommand(){let e=[],t={to:null,cc:null,bcc:null};this.contactsCheckedOrSelected().forEach((t=>{const s=t?.getNameAndEmailHelper(),i=s?new EmailModel(s[0],s[1]):null;i?.valid()&&e.push(i)})),h(e)&&(rr=!1,this.close(),t[ar]=e,ii([Ie.Empty,null,t.to,t.cc,t.bcc]))}clearSearch(){this.search("")}saveCommand(){this.saveContact(this.contact())}saveContact(e){const t=e.toJSON();t.jCard!=JSON.stringify(e.jCard)&&(this.isSaving(!0),Ms.request("ContactSave",((s,i)=>{s?alert(i?.ErrorMessage||fe(s)):i.Result.ResultID&&(e.id()?(e.id(i.Result.ResultID),e.jCard=JSON.parse(t.jCard)):this.reloadContactList()),this.isSaving(!1)}),t))}syncCommand(){_i.sync((e=>{e&&alert(fe(e)),this.reloadContactList(!0)}))}exportVcf(){Qs(z("ContactsVcf"),"contacts.vcf")}exportCsv(){Qs(z("ContactsCsv"),"contacts.csv")}populateViewContact(e){const t=this.contact(),s=()=>this.contact(e);t?.hasChanges()?AskPopupView.showModal([he("GLOBAL/SAVE_CHANGES"),()=>this.saveContact(t)|s(),s]):s()}reloadContactList(e=!1){let t=50*(this.contactsPage()-1);e&&(this.contactsPage(1),t=0),_i.loading(!0),Ms.abort("Contacts").request("Contacts",((e,t)=>{let s=0,i=[];e?alert(t?.ErrorMessage||fe(e)):h(t.Result.List)&&(t.Result.List.forEach((e=>{(e=ContactModel.reviveFromJson(e))&&i.push(e)})),s=f(t.Result.Count)),this.contactsCount(0<s?s:0),_i(i),_i.loading(!1)}),{Offset:t,Limit:50,Search:this.search()})}onBuild(e){this.selector.init(e.querySelector(".b-list-content"),sr),V("delete","",sr,(()=>(this.deleteCommand(),!1))),V("c,w","",sr,(()=>(this.newMessageCommand(),!1)));const t=this;if(e.addEventListener("click",(s=>{let i=s.target.closestWithin(".e-paginator a",e);i&&(i=f(ko.dataFor(i)?.value))&&(t.contactsPage(i),t.reloadContactList())})),this.importButton()){const e=new Jua({action:X("UploadContacts"),limit:1,clickElement:this.importButton()});e&&e.on("onStart",(()=>{_i.importing(!0)})).on("onComplete",((e,t,s)=>{_i.importing(!1),this.reloadContactList(),e&&t&&s&&s.Result||alert(he("CONTACTS/ERROR_IMPORT_FILE"))}))}}tryToClose(){!1===this.onClose()||this.close()}onClose(){const e=this.contact();if(AskPopupView.hidden()&&e?.hasChanges())return AskPopupView.showModal([he("GLOBAL/SAVE_CHANGES"),()=>this.close()|this.saveContact(e),()=>this.close()]),!1}onShow(e,t){rr=!!e,ar=["to","cc","bcc"].includes(t)?t:"to",this.reloadContactList(!0)}onHide(){this.contact(null),this.selectorContact(null),this.search(""),this.contactsCount(0),_i([]),rr&&ii()}}class SystemDropDownUserView extends AbstractViewRight{constructor(){super(),this.allowAccounts=L("AdditionalAccounts"),this.accountEmail=xs.email,this.accounts=xs,this.accountsLoading=xs.loading,Ee(this,{currentAudio:"",accountMenuDropdownTrigger:!1}),this.allowContacts=xt.allowContacts(),addEventListener("audio.stop",(()=>this.currentAudio(""))),addEventListener("audio.start",(e=>this.currentAudio(e.detail)))}stopPlay(){R("audio.api.stop")}accountClick(e,t){let s=e?.email;return s&&0===t.button&&xs.email()!=s&&(xs.loading(!0),O(t),Ms.request("AccountSwitch",(t=>{t?(xs.loading(!1),alert(fe(t).replace("%EMAIL%",s)),e.isAdditional()&&Mt(AccountPopupView,[e])):rl.route.reload()}),{Email:s})),!0}accountName(){let e=xs.email(),t=xs.find((t=>t.email==e));return t?.name||e}settingsClick(){hasher.setHash(te())}settingsHelp(){Mt(KeyboardShortcutsHelpPopupView)}addAccountClick(){this.allowAccounts&&Mt(AccountPopupView)}contactsClick(){this.allowContacts&&Mt(ContactsPopupView)}logoutClick(){rl.app.logout()}onBuild(){V("m","",[e,s,i],(()=>{if(!this.viewModelDom.hidden)return this.accountMenuDropdownTrigger(!0),!1})),V("?,f1,help","",[e,s,i],(()=>{if(!this.viewModelDom.hidden)return Mt(KeyboardShortcutsHelpPopupView),!1}))}}class FolderCreatePopupView extends AbstractViewPopup{constructor(){super("FolderCreate"),Ee(this,{name:"",subscribe:!0,parentFolder:""}),this.parentFolderSelectList=we((()=>mi([],[["",""]],(e=>e?e.detailedName():""),es.namespace?e=>!e.fullName.startsWith(es.namespace):null,!0))),this.defaultOptionsAfterRender=b}submitForm(e){if(e.reportValidity()){const t=new FormData(e);let s=this.parentFolder();!s&&1<es.namespace.length&&t.set("parent",es.namespace.slice(0,es.namespace.length-1)),Ms.abort("Folders").post("FolderCreate",es.foldersCreating,t).then((e=>{const t=Yt(s),i=FolderModel.reviveFromJson(e.Result),r=t?t.subFolders:es.folderList;Jt(i),r.push(i),pi(r)}),(e=>{es.folderListError(fe(e.code,"",c.CantCreateFolder)+".\n"+e.message)})),this.close()}}onShow(){this.name(""),this.subscribe(!0),this.parentFolder("")}}class ComposeAttachmentModel extends AbstractModel{constructor(e,t,s=null,i=!1,r=!1,a="",o=""){super(),this.id=e,this.isInline=!!i,this.isLinked=!!r,this.cId=a,this.contentLocation=o,this.fromMessage=!1,Ee(this,{fileName:t,size:s,tempName:"",type:"",progress:0,error:"",waiting:!0,uploading:!1,enabled:!0,complete:!1}),ke(this,{progressText:()=>{const e=this.progress();return 1>e?"":(100<e?100:e)+"%"},progressStyle:()=>{const e=this.progress();return 1>e?"":"width:"+(100<e?100:e)+"%"},title:()=>this.error()||this.fileName(),friendlySize:()=>{const e=this.size();return null===e?"":ws.friendlySize(e)},mimeType:()=>this.type()||ws.getContentType(this.fileName()),fileExt:()=>ws.getExtension(this.fileName()),iconClass:()=>ws.getIconClass(this.fileExt(),this.mimeType())})}}class FolderSystemPopupView extends AbstractViewPopup{constructor(){super("FolderSystem"),this.notification=ko.observable(""),this.folderSelectList=we((()=>mi(es.systemFoldersNames(),[["",he("POPUPS_SYSTEM_FOLDERS/SELECT_CHOOSE_ONE")],[Kt,he("POPUPS_SYSTEM_FOLDERS/SELECT_UNUSE_NAME")]]))),this.sentFolder=es.sentFolder,this.draftsFolder=es.draftsFolder,this.spamFolder=es.spamFolder,this.trashFolder=es.trashFolder,this.archiveFolder=es.archiveFolder;const e=(()=>es.saveSystemFolders()).debounce(1e3);Ce(es,{sentFolder:e,draftsFolder:e,spamFolder:e,trashFolder:e,archiveFolder:e}),this.defaultOptionsAfterRender=b}onShow(e=0){let t="",s="POPUPS_SYSTEM_FOLDERS/NOTIFICATION_";switch(e){case Me.Sent:t=he(s+"SENT");break;case Me.Drafts:t=he(s+"DRAFTS");break;case Me.Junk:t=he(s+"SPAM");break;case Me.Trash:t=he(s+"TRASH");break;case Me.Archive:t=he(s+"ARCHIVE")}this.notification(t)}}const or="Compose",nr=D("template"),lr=e=>y(e).match(/.{1,76}/g).join("\r\n"),cr=e=>ut(e)[0]?.email||!1,dr=(e,t)=>e.filter((e=>e.email)).map((e=>e.toLine(t))).join(", "),hr=()=>{const e=es.draftsFolder();e&&Kt!==e&&(zt(e,""),es.currentFolderFullName()===e?Gs.reload(!0):gi(e))},ur=e=>(e=e.map((e=>e.email)),Ui.find((t=>e.includes(t.email())))),pr=(e,t)=>{if(h(t)){const s=e().trim();e(s+(s?", ":"")+t.map((e=>e?e.toLine():null)).validUnique().join(", ").trim())}},mr=()=>"Plain"===He.editorDefaultType(),gr=(e,t)=>{e=e.toUpperCase().trim(),t=t.replace(/\s+/g," ").trim();let s=!1,i="RE"===e,r="FWD"===e;const a=[],o=!r;return t&&t.split(":").forEach((e=>{const t=e.trim();s||!/^(RE|FWD)$/i.test(t)&&!/^(RE|FWD)[[(][\d]+[\])]$/i.test(t)?(a.push(e),s=!0):(i||(i=!!/^RE/i.test(t)),r||(r=!!/^FWD/i.test(t)))})),o?i=!1:r=!1,((o?"Re: ":"Fwd: ")+(i?"Re: ":"")+(r?"Fwd: ":"")+a.join(":").trim()).trim()};ko.extenders.toggleSubscribe=(e,t)=>(e.subscribe(t[1],t[0],"beforeChange"),e.subscribe(t[2],t[0]),e);class MimePart{constructor(){this.headers={},this.body="",this.boundary="",this.children=[]}toString(){const e=this.children.length,t=this.boundary||(this.boundary="part"+Jua.randomId()),s=this.headers;e&&!s["Content-Type"].includes(t)&&(s["Content-Type"]+=`; boundary="${t}"`);let i=Object.entries(s).map((([e,t])=>`${e}: ${t}`)).join("\r\n")+"\r\n";return this.body&&(i+="\r\n"+this.body.replace(/\r?\n/g,"\r\n")),e&&(this.children.forEach((e=>i+="\r\n--"+t+"\r\n"+e)),i+="\r\n--"+t+"--\r\n"),i}}class ComposePopupView extends AbstractViewPopup{constructor(){super("Compose");const e=(e,t,s,i)=>{const r=e&&t?.[s]();if(r&&(i||e[s]())){let t=e[s]().trim().split(",");t=t.filter((e=>(e=e.trim())&&r.trim()!==e)),i&&t.push(r),e[s](t.join(","))}};this.oEditor=null,this.sLastFocusedField="to",this.allowContacts=xt.allowContacts(),this.allowIdentities=L("Identities"),this.allowSpellcheck=He.allowSpellcheck,Ee(this,{identitiesDropdownTrigger:!1,from:"",to:"",cc:"",bcc:"",replyTo:"",subject:"",isHtml:!1,requestDsn:!1,requestReadReceipt:!1,requireTLS:!1,markAsImportant:!1,sendError:!1,sendSuccessButSaveError:!1,savedError:!1,sendErrorDesc:"",savedErrorDesc:"",savedTime:0,emptyToError:!1,attachmentsInProcessError:!1,attachmentsInErrorError:!1,showCc:!1,showBcc:!1,showReplyTo:!1,pgpSign:!1,canPgpSign:!1,pgpEncrypt:!1,canPgpEncrypt:!1,canMailvelope:!1,draftsFolder:"",draftUid:0,sending:!1,saving:!1,viewArea:"body",attacheMultipleAllowed:!1,addAttachmentEnabled:!1,editorArea:null,currentIdentity:Ui()[0]}),["to","cc","bcc"].forEach((e=>{this[e].focused=ko.observable(!1),this[e].focused.subscribe((t=>t&&(this.sLastFocusedField=e)))})),this.attachments=Fe(),this.dragAndDropOver=ko.observable(!1).extend({debounce:1}),this.dragAndDropVisible=ko.observable(!1).extend({debounce:1}),this.currentIdentity.extend({toggleSubscribe:[this,t=>{e(this,t,"bcc"),e(this,t,"replyTo")},t=>{e(this,t,"bcc",!0),e(this,t,"replyTo",!0)}]}),this.tryToClose=this.tryToClose.debounce(200),this.iTimer=0,ke(this,{sendButtonSuccess:()=>!this.sendError()&&!this.sendSuccessButSaveError(),savedTimeText:()=>this.savedTime()?he("COMPOSE/SAVED_TIME",{TIME:this.savedTime().format("LT")}):"",emptyToErrorTooltip:()=>this.emptyToError()?he("COMPOSE/EMPTY_TO_ERROR_DESC"):"",attachmentsErrorTooltip:()=>{let e="";switch(!0){case this.attachmentsInProcessError():e=he("COMPOSE/ATTACHMENTS_UPLOAD_ERROR_DESC");break;case this.attachmentsInErrorError():e=he("COMPOSE/ATTACHMENTS_ERROR_DESC")}return e},attachmentsInProcess:()=>this.attachments.filter((e=>e&&!e.complete())),attachmentsInError:()=>this.attachments.filter((e=>e?.error())),attachmentsCount:()=>this.attachments().length,attachmentsInErrorCount:()=>this.attachmentsInError.length,attachmentsInProcessCount:()=>this.attachmentsInProcess.length,isDraft:()=>this.draftsFolder()&&this.draftUid(),identitiesOptions:()=>Ui.map((e=>({item:e,optValue:e.id(),optText:e.formattedName()}))),canBeSentOrSaved:()=>!this.sending()&&!this.saving()}),Ce(this,{sendError:e=>!e&&this.sendErrorDesc(""),savedError:e=>!e&&this.savedErrorDesc(""),sendSuccessButSaveError:e=>!e&&this.savedErrorDesc(""),currentIdentity:e=>e&&this.from(e.formattedName()),from:e=>{this.canPgpSign(!1),(e=cr(e))&&Qi.getKeyForSigning(e).then((e=>{this.canPgpSign(e)}))},cc:e=>{!1===this.showCc()&&e.length&&this.showCc(!0),this.initPgpEncrypt()},bcc:e=>{!1===this.showBcc()&&e.length&&this.showBcc(!0),this.initPgpEncrypt()},replyTo:e=>{!1===this.showReplyTo()&&e.length&&this.showReplyTo(!0)},attachmentsInErrorCount:e=>{0===e&&this.attachmentsInErrorError(!1)},to:e=>{this.emptyToError()&&e.length&&this.emptyToError(!1),this.initPgpEncrypt()},attachmentsInProcess:e=>{this.attachmentsInProcessError()&&h(e)&&this.attachmentsInProcessError(!1)},viewArea:e=>{if(!this.mailvelope&&"mailvelope"==e){let e=ir&&ir.body.classList.contains("mailvelope")?ir.plain():this.oEditor.getData(),t=this.isDraft(),s=Qi.isEncrypted(e),i=M("phpUploadSizes").post_max_size,r=f(i);switch(i.slice(-1)){case"G":r*=1024;case"M":r*=1024;case"K":r*=1024}mailvelope.createEditorContainer("#mailvelope-editor",Qi.mailvelopeKeyring,{quota:Math.max(2048,r/1024)-48,armoredDraft:s&&t?e:"",predefinedText:s?"":this.oEditor.isHtml()?lt(e):e,quotedMail:s&&!t?e:""}).then((e=>this.mailvelope=e))}}}),It(this,{sendCommand:e=>e.canBeSentOrSaved(),saveCommand:e=>e.canBeSentOrSaved(),deleteCommand:e=>e.isDraft(),skipCommand:e=>e.canBeSentOrSaved(),contactsCommand:e=>e.allowContacts}),this.from(Ui()[0].formattedName())}sendCommand(){let e=es.sentFolder();if(this.attachmentsInProcessError(!1),this.attachmentsInErrorError(!1),this.emptyToError(!1),this.attachmentsInProcess().length?(this.attachmentsInProcessError(!0),this.attachmentsArea()):this.attachmentsInError().length&&(this.attachmentsInErrorError(!0),this.attachmentsArea()),this.to().trim()||this.cc().trim()||this.bcc().trim()||this.emptyToError(!0),!this.emptyToError()&&!this.attachmentsInErrorError()&&!this.attachmentsInProcessError())if(He.replySameFolder()&&3===h(this.aDraftInfo)&&null!=this.aDraftInfo[2]&&this.aDraftInfo[2].length&&(e=this.aDraftInfo[2]),e)try{this.sendError(!1),this.sending(!0),e=Kt===e?"":e,this.getMessageRequestParams(e).then((t=>{Ms.request("SendMessage",((t,s)=>{if(this.sending(!1),t?c.CantSaveMessage===t?(this.sendSuccessButSaveError(!0),this.savedErrorDesc(he("COMPOSE/SAVED_ERROR_ON_SEND").trim())):(this.sendError(!0),this.sendErrorDesc(fe(t,s?.ErrorMessage)||fe(c.CantSendMessage))):this.close(),zt(this.draftsFolder(),""),zt(e,""),3===h(this.aDraftInfo)){const e=this.aDraftInfo[2];zt(e,"")}hr()}),t,3e4)})).catch((e=>{this.sendError(!0),this.sendErrorDesc(e),this.sending(!1)}))}catch(e){this.sendError(!0),this.sendErrorDesc(e),this.sending(!1)}else Mt(FolderSystemPopupView,[Me.Sent])}saveCommand(){this.saving()||this.sending()||(es.draftsFolderNotEnabled()?Mt(FolderSystemPopupView,[Me.Drafts]):(this.savedError(!1),this.saving(!0),this.autosaveStart(),this.getMessageRequestParams(es.draftsFolder(),1).then((e=>{Ms.request("SaveMessage",((e,t)=>{let s=!1;if(this.saving(!1),!e&&t.Result.folder&&t.Result.uid){if(s=!0,this.bFromDraft){const e=Nt.message();e&&this.draftsFolder()===e.folder&&this.draftUid()==e.uid&&Nt.message(null)}this.draftsFolder(t.Result.folder),this.draftUid(t.Result.uid),this.savedTime(new Date),this.bFromDraft&&zt(this.draftsFolder(),""),zt(es.draftsFolder(),"")}s||(this.savedError(!0),this.savedErrorDesc(fe(c.CantSaveMessage))),hr()}),e,2e5)})).catch((e=>{this.saving(!1),this.savedError(!0),this.savedErrorDesc(fe(c.CantSaveMessage)+": "+e)}))))}deleteCommand(){AskPopupView.hidden()&&Mt(AskPopupView,[he("POPUPS_ASK/DESC_WANT_DELETE_MESSAGES"),()=>{const e=this.draftsFolder(),t=new Set([this.draftUid()]);vi(e,t),Gs.removeMessagesFromList(e,t),this.close()}])}onClose(){return this.skipCommand(),!1}skipCommand(){ComposePopupView.inEdit(!0),!es.draftsFolderNotEnabled()&&He.allowDraftAutosave()&&this.saveCommand(),this.tryToClose()}contactsCommand(){this.allowContacts&&(this.skipCommand(),setTimeout((()=>{Mt(ContactsPopupView,[!0,this.sLastFocusedField])}),200))}autosaveStart(){clearTimeout(this.iTimer),this.iTimer=setTimeout((()=>{!this.modalVisible()||es.draftsFolderNotEnabled()||!He.allowDraftAutosave()||this.isEmptyForm(!1)||this.savedError()||this.saveCommand(),this.autosaveStart()}),6e4)}emailsSource(e,t){Ms.abort("Suggestions").request("Suggestions",((e,s)=>{!e&&d(s.Result)?t(s.Result.map((e=>e?.[0]?new EmailModel(e[0],e[1]).toLine():null)).filter((e=>e))):c.RequestAborted!==e&&t([])}),{Query:e})}selectIdentity(e){e=e?.item,e&&(this.currentIdentity(e),this.setSignature(e))}onHide(){clearTimeout(this.iTimer),ComposePopupView.inEdit()||this.reset(),this.to.focused(!1)}dropMailvelope(){this.mailvelope&&(A("mailvelope-editor").textContent="",this.mailvelope=null)}editor(e){e&&this.editorArea()&&(this.oEditor?e(this.oEditor):this.oEditor=new HtmlEditor(this.editorArea(),null,(()=>e(this.oEditor)),(e=>this.isHtml(!!e))))}setSignature(e,t){e&&Ie.Draft!==t&&Ie.EditAsNew!==t&&this.editor((t=>{let s=e.signature()||"",i=s.startsWith(":HTML:"),r=ir?dr(ir.from,!0):"";r&&(s=s.replace(/{{FROM-FULL}}/g,r),!r.includes(" ")&&0<r.indexOf("@")&&(r=r.replace(/@\S+/,"")),s=s.replace(/{{FROM}}/g,r)),s=(i?s.slice(6):s).replace(/\r/g,"").replace(/\s{1,2}?{{FROM}}/g,"").replace(/\s{1,2}?{{FROM-FULL}}/g,"").replace(/{{DATE}}/g,(new Date).format({dateStyle:"full",timeStyle:"short"})).replace(/{{TIME}}/g,(new Date).format("LT")).replace(/{{MOMENT:[^}]+}}/g,""),s.length&&t.setSignature(s,i,!!e.signatureInsertBefore())}))}onShow(e,t,s,i,r,a,o){this.autosaveStart(),this.viewModelDom.dataset.wysiwyg=He.editorDefaultType();let n={mode:e||Ie.Empty,to:s,cc:i,bcc:r,subject:a,text:o};1<h(t)?n.messages=t:n.message=d(t)?t[0]:t,ComposePopupView.inEdit()?Ie.Empty!==n.mode?Mt(AskPopupView,[he("COMPOSE/DISCARD_UNSAVED_DATA"),()=>this.initOnShow(n),null,!1]):(pr(this.to,s),pr(this.cc,i),pr(this.bcc,r),a&&!this.subject()&&this.subject(a)):this.initOnShow(n),ComposePopupView.inEdit(!1)}initOnShow(e){const t={},s=xs.email();ir=e.message,s&&(t[s]=!0),this.reset();let i=null;if(ir)switch(e.mode){case Ie.Reply:case Ie.ReplyAll:case Ie.Forward:case Ie.ForwardAsAttachment:i=ur(ir.to.concat(ir.cc,ir.bcc));break;case Ie.Draft:i=ur(ir.from.concat(ir.replyTo))}if(i=i||Ui()[0],i&&(t[i.email()]=!0),h(e.to)&&this.to(dr(e.to)),h(e.cc)&&this.cc(dr(e.cc)),h(e.bcc)&&this.bcc(dr(e.bcc)),e.mode&&ir){let s,r="",a=pe(ir.dateTimestamp(),"FULL"),o=ir.subject(),n="",l=ir.draftInfo;switch(e.mode){case Ie.Reply:case Ie.ReplyAll:if(Ie.Reply===e.mode)this.to(dr(ir.replyEmails(t)));else{let e=ir.replyAllEmails(t);this.to(dr(e[0])),this.cc(dr(e[1]))}this.subject(gr("Re",o)),this.prepareMessageAttachments(ir,e.mode),this.aDraftInfo=["reply",ir.uid,ir.folder],this.sInReplyTo=ir.messageId,this.sReferences=(ir.messageId+" "+ir.references).trim();break;case Ie.Forward:case Ie.ForwardAsAttachment:this.subject(gr("Fwd",o)),this.prepareMessageAttachments(ir,e.mode),this.aDraftInfo=["forward",ir.uid,ir.folder],this.sInReplyTo=ir.messageId,this.sReferences=(ir.messageId+" "+ir.references).trim();break;case Ie.Draft:this.bFromDraft=!0,this.draftsFolder(ir.folder),this.draftUid(ir.uid);case Ie.EditAsNew:this.to(dr(ir.to)),this.cc(dr(ir.cc)),this.bcc(dr(ir.bcc)),this.replyTo(dr(ir.replyTo)),this.subject(o),this.prepareMessageAttachments(ir,e.mode),this.aDraftInfo=3===h(l)?l:null,this.sInReplyTo=ir.inReplyTo,this.sReferences=ir.references}switch(nr.innerHTML=ir.bodyAsHTML(),nr.content.querySelectorAll("img").forEach((e=>{e.src||e.dataset.xSrcCid||e.dataset.xSrc||e.replaceWith(e.alt||e.title)})),n=nr.innerHTML.trim(),e.mode){case Ie.Reply:case Ie.ReplyAll:n="<br><br><p>"+he("COMPOSE/REPLY_MESSAGE_TITLE",{DATETIME:a,EMAIL:ir.from.toString(!1,!0)})+":</p><blockquote>"+n.trim()+"</blockquote>";break;case Ie.Forward:r=ir.cc.toString(!1,!0),n="<br><br><p>"+he("COMPOSE/FORWARD_MESSAGE_TOP_TITLE")+"</p><div>"+he("GLOBAL/FROM")+": "+ir.from.toString(!1,!0)+"<br>"+he("GLOBAL/TO")+": "+ir.to.toString(!1,!0)+(r.length?"<br>"+he("GLOBAL/CC")+": "+r:"")+"<br>"+he("COMPOSE/FORWARD_MESSAGE_TOP_SENT")+": "+ot(a)+"<br>"+he("GLOBAL/SUBJECT")+": "+ot(o)+"<br><br>"+n.trim()+"</div>";break;case Ie.ForwardAsAttachment:n="";break;default:s=Qi.isEncrypted(n),s&&(n=ir.plain())}this.editor((t=>{s||t.setHtml(n),(s||mr())&&t.modePlain(),s&&t.setPlain(n),this.setSignature(i,e.mode),this.setFocusInPopup()}))}else Ie.Empty===e.mode?(this.subject(null!=e.subject?""+e.subject:""),this.editor((t=>{t.setHtml(e.text?""+e.text:""),mr()&&t.modePlain(),this.setSignature(i),this.setFocusInPopup()}))):e.messages?(e.messages.forEach((e=>this.addMessageAsAttachment(e))),this.editor((t=>{mr()?t.setPlain(""):t.setHtml(""),this.setSignature(i,e.mode),this.setFocusInPopup()}))):this.setFocusInPopup();const a=this.attachments.filter((e=>e&&!e.tempName())).map((e=>e.id));h(a)&&Ms.request("MessageUploadAttachments",((e,t)=>{const s=t?.Result;a.forEach(((t,i)=>{const a=this.getAttachmentById(t);a&&(a.waiting(!1).uploading(!1).complete(!0),e||!s?.[i]?a.error(be(r.NoFileUploaded)):(a.tempName(s[i].tempName),a.type(s[i].mimeType)))}))}),{attachments:a},999e3),this.currentIdentity(i)}setFocusInPopup(){setTimeout((()=>{this.to()?this.subject()?this.oEditor?.focus():this.viewModelDom.querySelector('input[name="subject"]').focus():this.to.focused(!0)}),100)}tryToClose(){AskPopupView.hidden()&&(ComposePopupView.inEdit()||this.isEmptyForm()&&!this.draftUid()?this.close():Mt(AskPopupView,[he("POPUPS_ASK/DESC_WANT_CLOSE_THIS_WINDOW"),()=>this.close()]))}onBuild(e){const t=new Jua({action:X("Upload"),clickElement:e.querySelector("#composeUploadButton"),dragAndDropElement:e.querySelector(".b-attachment-place")}),s=f(M("attachmentLimit"));t.on("onDragEnter",(()=>{this.dragAndDropOver(!0)})).on("onDragLeave",(()=>{this.dragAndDropOver(!1)})).on("onBodyDragEnter",(()=>{this.attachmentsArea(),this.dragAndDropVisible(!0)})).on("onBodyDragLeave",(()=>{this.dragAndDropVisible(!1)})).on("onProgress",((e,t,s)=>{let i=this.getAttachmentById(e);i&&i.progress(Math.floor(t/s*100))})).on("onSelect",((e,i)=>{this.dragAndDropOver(!1);const r=f(i.size,null),a=new ComposeAttachmentModel(e,i.fileName?i.fileName.toString():"",r);return this.addAttachment(a,1,t),!(0<r&&0<s&&s<r)||(a.waiting(!1).uploading(!0).complete(!0).error(he("UPLOAD/ERROR_FILE_IS_TOO_BIG")),!1)})).on("onStart",(e=>{let t=this.getAttachmentById(e);t&&t.waiting(!1).uploading(!0).complete(!1)})).on("onComplete",((e,t,s)=>{const i=this.getAttachmentById(e),r=s?.Result||{},a=r.ErrorCode,o=t&&r.Attachment;let n="";null!=a?n=be(a):o||(n=he("UPLOAD/ERROR_UNKNOWN")),i&&(n?i.waiting(!1).uploading(!1).complete(!0).error(n+"\n"+r.ErrorMessage):o&&(i.waiting(!1).uploading(!1).complete(!0),i.fileName(o.name),i.size(o.size?f(o.size):0),i.tempName(o.tempName?o.tempName:""),i.isInline=!1,i.type(o.mimeType)))})),this.addAttachmentEnabled(!0),U("q","meta",or,(()=>!1)),U("w","meta",or,(()=>!1)),U("m","meta",or,(()=>(this.identitiesDropdownTrigger(!0),!1))),U("arrowdown","meta",or,(()=>(this.skipCommand(),!1))),U("s","meta",or,(()=>(this.saveCommand(),!1))),U("save","",or,(()=>(this.saveCommand(),!1))),U("enter","meta",or,(()=>(this.sendCommand(),!1))),U("mailsend","",or,(()=>(this.sendCommand(),!1))),U("escape,close","shift",or,(()=>(this.tryToClose(),!1))),this.editor((e=>e[mr()?"modePlain":"modeWysiwyg"]()))}getAttachmentById(e){return this.attachments.find((t=>t&&e===t.id))}addMessageAsAttachment(e){if(e){let t=e.subject();t=".eml"===t.slice(-4).toLowerCase()?t:t+".eml";const s=new ComposeAttachmentModel(e.requestHash,t,e.size());s.fromMessage=!0,s.complete(!0),this.addAttachment(s)}}addAttachment(e,t,s){s||e.waiting(!1).uploading(!0),e.cancel=()=>{this.attachments.remove(e),s?.cancel(e.id)},this.attachments.push(e),t&&this.attachmentsArea()}addAttachmentHelper(e,t,s){const i=new ComposeAttachmentModel(e,t,s);return this.addAttachment(i,1),i}prepareMessageAttachments(e,t){if(e){let s=[Ie.Reply,Ie.ReplyAll].includes(t);s||[Ie.Forward,Ie.Draft,Ie.EditAsNew].includes(t)?e.attachments.forEach((e=>{if(!s||e.isLinked()){const t=new ComposeAttachmentModel(e.download,e.fileName,e.estimatedSize,e.isInline(),e.isLinked(),e.cId,e.contentLocation);t.fromMessage=!0,t.type(e.mimeType),this.addAttachment(t)}})):Ie.ForwardAsAttachment===t&&this.addMessageAsAttachment(e)}}isEmptyForm(e=!0){const t=e?!this.attachments.length:!this.attachments.some((e=>e?.complete()));return!this.to.length&&!this.cc.length&&!this.bcc.length&&!this.replyTo.length&&!this.subject.length&&t&&(!this.oEditor||!this.oEditor.getData())}reset(){this.to(""),this.cc(""),this.bcc(""),this.replyTo(""),this.subject(""),this.requestDsn(He.requestDsn()),this.requestReadReceipt(He.requestReadReceipt()),this.requireTLS(He.requireTLS()),this.markAsImportant(!1),this.bodyArea(),this.aDraftInfo=null,this.sInReplyTo="",this.bFromDraft=!1,this.sReferences="",this.sendError(!1),this.sendSuccessButSaveError(!1),this.savedError(!1),this.savedTime(0),this.emptyToError(!1),this.attachmentsInProcessError(!1),this.showCc(!1),this.showBcc(!1),this.showReplyTo(!1),this.pgpSign(He.pgpSign()),this.pgpEncrypt(He.pgpEncrypt()),this.attachments([]),this.dragAndDropOver(!1),this.dragAndDropVisible(!1),this.draftsFolder(""),this.draftUid(0),this.sending(!1),this.saving(!1),this.oEditor?.clear(),this.dropMailvelope()}attachmentsArea(){this.viewArea("attachments")}bodyArea(){this.viewArea("body")}allRecipients(){return[this.from(),this.to(),this.cc(),this.bcc()].join(",").split(",").map((e=>cr(e.trim()))).validUnique()}initPgpEncrypt(){const e=this.allRecipients();Qi.hasPublicKeyForEmails(e).then((e=>{this.canPgpEncrypt(e)})),Qi.mailvelopeHasPublicKeyForEmails(e).then((e=>{this.canMailvelope(e),e||"mailvelope"===this.viewArea()&&this.bodyArea()}))}togglePgpSign(){this.pgpSign(!this.pgpSign())}togglePgpEncrypt(){this.pgpEncrypt(!this.pgpEncrypt())}async getMessageRequestParams(e,t){let s,i=this.oEditor.getData().trim(),r=0;const a={};this.attachments.forEach((e=>{e?.complete()&&e?.tempName()&&e?.enabled()&&(++r,a[e.tempName()]={name:e.fileName(),inline:e.isInline,cId:e.cId,location:e.contentLocation,type:e.mimeType()})}));const o=this.currentIdentity(),n={identityID:o.id(),messageFolder:this.draftsFolder(),messageUid:this.draftUid(),saveFolder:e,from:this.from(),to:this.to(),cc:this.cc(),bcc:this.bcc(),replyTo:this.replyTo(),subject:this.subject(),draftInfo:this.aDraftInfo,inReplyTo:this.sInReplyTo,references:this.sReferences,markAsImportant:this.markAsImportant()?1:0,attachments:a,dsn:this.requestDsn()?1:0,requireTLS:this.requireTLS()?1:0,readReceiptRequest:this.requestReadReceipt()?1:0},l=t?[o.email()]:this.allRecipients(),c=!t&&this.pgpSign()&&this.canPgpSign(),d=this.pgpEncrypt()&&this.canPgpEncrypt(),h=this.oEditor.isHtml();if(h){do{s=i.length,i=i.replace(/(<[^>]+[;"'])\s*mso-[a-z-]+\s*:[^;"']+/gi,"$1").replace(/(<[^>]+)\s+data-hs-[a-z-]+=("[^"]+"|'[^']+')/gi,"$1")}while(s!=i.length);n.html=i,n.plain=lt(i)}else n.plain=i;if(this.mailvelope&&"mailvelope"===this.viewArea())n.encrypted=t?await this.mailvelope.createDraft():await this.mailvelope.encrypt(l);else if(c||d){if(!t&&!r&&!i.length)throw he("COMPOSE/ERROR_EMPTY_BODY");let e=new MimePart;if(e.headers["Content-Type"]="text/"+(h?"html":"plain")+'; charset="utf-8"',e.headers["Content-Transfer-Encoding"]="base64",e.body=lr(i),h){const t=new MimePart,s=new MimePart;t.headers["Content-Type"]="multipart/alternative",s.headers["Content-Type"]='text/plain; charset="utf-8"',s.headers["Content-Transfer-Encoding"]="base64",s.body=lr(n.plain),t.children.push(s),t.children.push(e),e=t}if(!t&&c?.[1])if("openpgp"==c[0]){n.html=n.plain="";let t=new MimePart;t.headers["Content-Type"]='multipart/signed; micalg="pgp-sha256"; protocol="application/pgp-signature"',t.headers["Content-Transfer-Encoding"]="7Bit",t.children.push(e);let s=new MimePart;s.headers["Content-Type"]='application/pgp-signature; name="signature.asc"',s.headers["Content-Transfer-Encoding"]="7Bit",s.body=await Yi.sign(e.toString(),c[1],1),t.children.push(s),n.signed=t.toString(),n.boundary=t.boundary,e=t}else{if("gnupg"!=c[0])throw"Signing with "+c[0]+" not yet implemented";n.signFingerprint=c[1].fingerprint,n.signPassphrase=await Hi.sign(c[1])}if(d)if("openpgp"==d)n.encrypted=await Yi.encrypt(e.toString(),l),n.signed="";else{if("gnupg"!=d)throw"Encryption with "+d+" not yet implemented";n.encryptFingerprints=JSON.stringify(Hi.getPublicKeyFingerprints(l))}}return n}}ComposePopupView.inEdit=ko.observable(!1);class MailFolderList extends AbstractViewLeft{constructor(){super(),this.composeInEdit=ComposePopupView.inEdit,this.systemFolders=es.systemFolders,this.moveAction=Zs,this.foldersListWithSingleInboxRootFolder=ko.observable(!1),this.allowContacts=xt.allowContacts(),this.foldersFilter=Fi,ke(this,{foldersFilterVisible:()=>20<es.folderList().CountRec,folderListVisible:()=>{let e,t,s=!1,i=es.folderList().filter((i=>(i.isInbox()&&(e=i),t=i.visible(),s|=t&&!i.isInbox(),t)));return e&&!s&&e.collapsed(!1),this.foldersListWithSingleInboxRootFolder(!s),i}})}onBuild(s){const i=e=>s.querySelector(e),r=(e,t)=>e.target.closestWithin(t,s);this.oContentScrollable=i(".b-content"),s.addEventListener("click",(t=>{let s=r(t,".e-collapsed-sign");if(s){const e=ko.dataFor(s);if(e){const s=e.collapsed();return Ti(e.fullName,s),e.collapsed(!s),void O(t)}}if(s=r(t,"a"),s?.matches(".selectable")){t.preventDefault();const i=ko.dataFor(s);if(i){if(Zs())Zs(!1),Si(es.currentFolderFullName(),Gs.listCheckedOrSelectedUidsWithSubMails(),i.fullName,t.ctrlKey);else{He.usePreviewPane()||Nt.message(null);let e="";t.target.matches(".flag-icon")&&!i.isFlagged()?e="flagged":i.unreadCount()&&t.clientX>s.getBoundingClientRect().right-25&&(e="unseen"),hasher.setHash(se(i.fullNameHash,1,e))}xt.focusedState(e)}}})),U("arrowup,arrowdown","",t,(e=>{let t=[],i=0;return s.querySelectorAll("li a").forEach((e=>{(e.offsetHeight||e.getClientRects().length)&&(t.push(e),e.matches(".focused")&&(e.classList.remove("focused"),i=t.length-1))})),t.length&&("ArrowUp"===e.key?i&&--i:i<t.length-1&&++i,t[i].classList.add("focused"),this.scrollToFocused()),!1})),U("enter,open","",t,(()=>{const t=i("li a.focused");return t&&(xt.focusedState(e),t.click()),!1})),U("space","",t,(()=>{const e=i("li a.focused"),t=e&&ko.dataFor(e);if(t){const e=t.collapsed();Ti(t.fullName,e),t.collapsed(!e)}return!1})),U("escape,tab,arrowright","",t,(()=>(xt.focusedState(e),Zs(!1),!1)))}scrollToFocused(){const e=this.oContentScrollable;if(e){let t,s=e.querySelector("li a.focused");if(s){const i=s.getBoundingClientRect(),r=e.getBoundingClientRect();i.top<r.top?t="start":i.bottom>r.bottom&&(t="end"),t&&s.scrollIntoView("start"===t)}}}composeClick(){ii()}clearFolderSearch(){Fi("")}createFolder(){Mt(FolderCreatePopupView)}configureFolders(){hasher.setHash(te("folders"))}contactsClick(){this.allowContacts&&Mt(ContactsPopupView)}}class FolderClearPopupView extends AbstractViewPopup{constructor(){super("FolderClear"),Ee(this,{folder:null,clearing:!1}),ke(this,{dangerDescHtml:()=>he("POPUPS_CLEAR_FOLDER/DANGER_DESC_HTML_1",{FOLDER:this.folder()?.localName()})}),It(this,{clearCommand:e=>!e.clearing()})}clearCommand(){const e=this.folder();e&&(this.clearing(!0),Ms.request("FolderClear",(t=>{e.totalEmails(0),e.unreadEmails(0),Nt.message(null),Gs.reload(!0,!0),this.clearing(!1),t?alert(fe(t)):this.close()}),{folder:e.fullName}))}onShow(e){this.clearing(!1),this.folder(e)}}class AdvancedSearchPopupView extends AbstractViewPopup{constructor(){super("AdvancedSearch"),Ee(this,{from:"",to:"",subject:"",text:"",keyword:"",repliedValue:-1,selectedDateValue:-1,selectedTreeValue:"",hasAttachment:!1,starred:!1,unseen:!1}),ke(this,{showMultisearch:()=>es.hasCapability("MULTISEARCH"),keywords:()=>{const e=[{value:"",label:""}];return es.currentFolder().permanentFlags.forEach((t=>{if(Qt(t)){let s=t.toLowerCase();e.push({value:t,label:he("MESSAGE_TAGS/"+s,0,s)})}})),e},showKeywords:()=>es.currentFolder().permanentFlags().some(Qt),repliedOptions:()=>(ce(),[{id:-1,name:""},{id:1,name:he("GLOBAL/YES")},{id:0,name:he("GLOBAL/NO")}]),selectedDates:()=>{ce();let e="SEARCH/DATE_";return[{id:-1,name:he(e+"ALL")},{id:3,name:he(e+"3_DAYS")},{id:7,name:he(e+"7_DAYS")},{id:30,name:he(e+"MONTH")},{id:90,name:he(e+"3_MONTHS")},{id:180,name:he(e+"6_MONTHS")},{id:365,name:he(e+"YEAR")}]},selectedTree:()=>{ce();let e="SEARCH/SUBFOLDERS_";return[{id:"",name:he(e+"NONE")},{id:"subtree-one",name:he(e+"SUBTREE_ONE")},{id:"subtree",name:he(e+"SUBTREE")}]}})}submitForm(){const e=this.buildSearchString();e&&Gs.mainSearch(e),this.close()}buildSearchString(){const e=this,t=new FormData,s=(e,s)=>s.length&&t.append(e,s);if(s("from",e.from().trim()),s("to",e.to().trim()),s("subject",e.subject().trim()),s("text",e.text().trim()),s("keyword",e.keyword()),s("in",e.selectedTreeValue()),-1<e.selectedDateValue()){let t=new Date;t.setDate(t.getDate()-e.selectedDateValue()),s("since",t.toISOString().split("T")[0])}let i=decodeURIComponent(new URLSearchParams(t).toString());return e.hasAttachment()&&(i+="&attachment"),e.unseen()&&(i+="&unseen"),e.starred()&&(i+="&flagged"),1==e.repliedValue()&&(i+="&answered"),0==e.repliedValue()&&(i+="&unanswered"),i.replace(/^&+/,"")}onShow(e){const t=this,s=new URLSearchParams("?"+e);t.from(p(s.get("from"))),t.to(p(s.get("to"))),t.subject(p(s.get("subject"))),t.text(p(s.get("text"))),t.keyword(p(s.get("keyword"))),t.selectedTreeValue(p(s.get("in"))),t.selectedDateValue(-1),t.hasAttachment(s.has("attachment")),t.starred(s.has("flagged")),t.unseen(s.has("unseen")),s.has("answered")?t.repliedValue(1):s.has("unanswered")&&t.repliedValue(0)}}const fr=()=>Gs.hasCheckedOrSelected(),br=(...e)=>Gs.setAction(...e),yr=(e,t)=>rl.app.moveMessagesToFolderType(e,es.currentFolderFullName(),Gs.listCheckedOrSelectedUidsWithSubMails(),t),vr=e=>10>e?"0"+e:""+e,Sr=e=>e.getFullYear()+vr(1+e.getMonth())+vr(e.getDate());let wr=0,Er="";class MailMessageList extends AbstractViewRight{constructor(){super(),this.allowDangerousActions=L("DangerousActions"),this.messageList=Gs,this.archiveAllowed=Gs.archiveAllowed,this.canMarkAsSpam=Gs.canMarkAsSpam,this.isSpamFolder=Gs.isSpamFolder,this.composeInEdit=ComposePopupView.inEdit,this.isMobile=Ue.isMobile,this.leftPanelDisabled=x,this.toggleLeftPanel=N,this.popupVisibility=Lt,this.useCheckboxesInList=He.useCheckboxesInList,this.userUsageProc=es.quotaPercentage,Ee(this,{moreDropdownTrigger:!1,sortDropdownTrigger:!1,focusSearch:!1}),this.dragOver=ko.observable(!1).extend({throttle:1}),this.dragOverEnter=ko.observable(!1).extend({throttle:1});const e=F.app("attachmentsActions");this.attachmentsActions=ko.observableArray(h(e)?e:[]),ke(this,{sortSupported:()=>es.hasCapability("SORT")|es.hasCapability("ESORT")&&!Gs.threadUid(),messageListSearchDesc:()=>{const e=Gs().search;return e?he("MESSAGE_LIST/SEARCH_RESULT_FOR",{SEARCH:e}):""},messageListPaginator:ti(Gs.page,Gs.pageCount),checkAll:{read:()=>Gs.hasChecked(),write:e=>{e=!!e,Gs.forEach((t=>t.checked(e)))}},inputSearch:{read:Gs.mainSearch,write:e=>Er=e},isIncompleteChecked:()=>{const e=Gs.listChecked().length;return e&&Gs().length>e},listGrouped:()=>{let e=Gs.threadUid(),t=es.sortMode()||"DATE";return He.listGrouped()&&(t.includes("DATE")||t.includes("FROM"))&&!e},timeFormat:()=>(es.sortMode()||"").includes("FROM")?"AUTO":"LT",groupedList:()=>{let e,t=[],s=es.sortMode()||"DATE";if(s.includes("FROM"))Gs.forEach((s=>{let i=s.from[0].email;e&&i==e.id||(e={id:i,label:s.from[0].toLine(),search:"from="+i,messages:[]},t.push(e)),e.messages.push(s)}));else if(s.includes("DATE")){let s=Sr(new Date),i=Intl.RelativeTimeFormat?new Intl.RelativeTimeFormat(k.documentElement.lang,{numeric:"auto"}):0;Gs.forEach((r=>{let a,o=new Date(1e3*r.dateTimestamp()),n=Sr(o);e&&n==e.id||(a=i&&s==n?i.format(0,"day"):i&&s-1==n?i.format(-1,"day"):o.format({dateStyle:"full"},0,ie.hourCycle()),e={id:n,label:a,search:"on="+o.getFullYear()+"-"+vr(1+o.getMonth())+"-"+vr(o.getDate()),messages:[]},t.push(e)),e.messages.push(r)}))}return t},sortText:()=>{let e=es.sortMode(),t=""===e||e.includes("REVERSE");return e=e.split(/\s+/),e.includes("FROM")?"@"+(t?"⬆":"⬇"):e.includes("SUBJECT")?"𝐒"+(t?"⬆":"⬇"):(e.includes("SIZE")?"✉":"📅")+(t?"⬇":"⬆")},downloadAsZipAllowed:()=>this.attachmentsActions.includes("zip")}),this.selector=new Selector(Gs,Gs.selectedMessage,Gs.focusedMessage,".messageListItem .actionHandle",".messageListItem .messageCheckbox",".messageListItem.focused"),this.selector.on("ItemSelect",(e=>{e?oi(e):Nt.message(null)})),this.selector.on("MiddleClick",(e=>oi(e,!0))),this.selector.on("ItemGetUid",(e=>e?e.generateUid():"")),this.selector.on("AutoSelect",(()=>Gs.canAutoSelect())),this.selector.on("UpOrDown",(e=>!Gs.hasChecked()&&(clearTimeout(wr),wr=setTimeout((()=>{let t,s,i,r;this.messageListPaginator().find((e=>{if(e){if(r&&(s=e),e.current&&(r=e,t=i),s)return!0;i=e}return!1})),(e?t:s)&&(He.usePreviewPane()||Nt.message()?this.selector.iSelectNextHelper=e?-1:1:this.selector.iFocusedNextHelper=e?-1:1,this.selector.unselect(),this.gotoPage(e?t:s))}),350),!0))),addEventListener("mailbox.message-list.selector.go-down",(e=>this.selector.newSelectPosition("ArrowDown",!1,e.detail))),addEventListener("mailbox.message-list.selector.go-up",(e=>this.selector.newSelectPosition("ArrowUp",!1,e.detail))),addEventListener("mailbox.message.show",(e=>{const t=e.detail.folder,s=e.detail.uid,i=Gs.find((e=>t===e?.folder&&s==e?.uid));if("INBOX"===t&&hasher.setHash(se(t)),i)this.selector.selectMessageItem(i);else if("INBOX"!==t&&hasher.setHash(se(t)),t&&s){let e=new MessageModel;e.folder=t,e.uid=s,oi(e)}else Nt.message(null)})),Gs.endHash.subscribe((()=>this.selector.scrollToFocused()).throttle(50)),It(this,{downloadAttachCommand:fr,downloadZipCommand:fr,forwardCommand:fr,deleteWithoutMoveCommand:fr,deleteCommand:fr,archiveCommand:fr,spamCommand:fr,notSpamCommand:fr,moveCommand:fr})}changeSort(e,t){es.sortMode(t.target.closest("li").dataset.sort),this.reload()}clearListIsVisible(){return!this.messageListSearchDesc()&&!Gs.error()&&!Gs.endThreadUid()&&Gs().length&&(Gs.isSpamFolder()||Gs.isTrashFolder())&&L("DangerousActions")}clear(){L("DangerousActions")&&Mt(FolderClearPopupView,[es.currentFolder()])}reload(){Gs.isLoading()||Gs.reload(!1,!0)}forwardCommand(){ii([Ie.ForwardAsAttachment,Gs.listCheckedOrSelected()])}downloadZipCommand(){let e=[];Gs.forEach((t=>t.checked()&&e.push(t.requestHash))),ei(null,e,null,null,Gs().folder)}downloadAttachCommand(){let e=[];Gs.forEach((t=>{t.checked()&&t.attachments.forEach((t=>{!t.isLinked()&&t.download&&e.push(t.download)}))})),ei(null,e)}deleteWithoutMoveCommand(){L("DangerousActions")&&yr(Me.Trash,!0)}deleteCommand(){yr(Me.Trash)}archiveCommand(){yr(Me.Archive)}spamCommand(){yr(Me.Junk)}notSpamCommand(){yr(Me.Inbox)}moveCommand(s,i){if(Gs.hasChecked()){s&&i?.preventDefault&&O(i);let r=Zs();xt.focusedState(r?e:t),Zs(!r)}}composeClick(){ii()}cancelSearch(){Gs.mainSearch(""),this.focusSearch(!1)}cancelThreadUid(){hasher.setHash(se(es.currentFolderFullNameHash(),Gs.pageBeforeThread(),Gs.listSearch()))}listSetSeen(){br(es.currentFolderFullName(),xe,Gs.listCheckedOrSelected())}listSetAllSeen(){let e=es.currentFolderFullName(),t=Gs.endThreadUid();if(e){let s=0;const i=[];let r=Yt(e);r&&(Gs.forEach((e=>{e.isUnseen()&&++s,e.flags.push("\\seen"),t&&i.push(e.uid)})),t?r.unreadEmails(Math.max(0,r.unreadEmails()-s)):r.unreadEmails(0),Ms.request("MessageSetSeenToAll",null,{folder:e,setAction:1,threadUids:i.join(",")}))}}listUnsetSeen(){br(es.currentFolderFullName(),Ne,Gs.listCheckedOrSelected())}listSetFlags(){br(es.currentFolderFullName(),De,Gs.listCheckedOrSelected())}listUnsetFlags(){br(es.currentFolderFullName(),Re,Gs.listCheckedOrSelected())}seenMessagesFast(e){const t=Gs.listCheckedOrSelected();t.length&&br(t[0].folder,e?xe:Ne,t)}gotoPage(e){e&&hasher.setHash(se(es.currentFolderFullNameHash(),e.value,Gs.listSearch(),Gs.threadUid()))}gotoThread(e){e?.threadsLen()&&(Gs.pageBeforeThread(Gs.page()),hasher.setHash(se(es.currentFolderFullNameHash(),1,Gs.listSearch(),e.uid)))}listEmptyMessage(){return this.dragOver()||Gs().length||Gs.isLoading()||Gs.error()?"":he("MESSAGE_LIST/EMPTY_"+(Gs.listSearch()?"SEARCH_":"")+"LIST")}onBuild(i){const r=i.querySelector(".b-content"),a=(e,t)=>e.target.closestWithin(t,i);if(setTimeout((()=>{const e=i.querySelector(".messageList"),t=()=>{let t=He.usePreviewPane();ri(e,5,t?1===t?"Width":"Height":0)};e&&(t(),addEventListener("rl-layout",t))}),1),this.selector.init(r,e),B(i,{click:t=>{Ue.isMobile()&&!a(t,".toggleLeft")&&x(!0),a(t,".messageList")&&s===xt.focusedState()&&xt.focusedState(e);let i=a(t,".e-paginator a");i&&this.gotoPage(ko.dataFor(i)),a(t,".checkboxCheckAll")&&this.checkAll(!this.checkAll()),i=a(t,".flagParent");let r=i&&ko.dataFor(i);if(r){const e=Gs.listCheckedOrSelected();br(r.folder,r.isFlagged()?Re:De,e.find((e=>e.uid==r.uid))?e:[r])}i=a(t,".threads-len"),i&&this.gotoThread(ko.dataFor(i))},dblclick:e=>{let t=a(e,".actionHandle");t&&this.gotoThread(ko.dataFor(t))}}),F.app("allowAppendMessage")){const e=i.querySelector(".listDragOver"),t=e=>{for(const t of e.dataTransfer.items)if("file"===t.kind&&"message/rfc822"===t.type)return!0};B(e,{dragover:e=>{t(e)&&(e.dataTransfer.dropEffect="copy",e.preventDefault())}}),B(r,{dragenter:s=>{t(s)&&(r.contains(s.target)&&this.dragOver(!0),s.target==e&&(s.dataTransfer.dropEffect="copy",this.dragOverEnter(!0)))},dragleave:t=>{t.target==e&&this.dragOverEnter(!1);let s=t.relatedTarget;s&&r.contains(s)||this.dragOver(!1)},drop:s=>{s.preventDefault(),s.target==e&&t(s)&&(Gs.loading(!0),wi(es.currentFolderFullName(),s.dataTransfer.files)),this.dragOverEnter(!1),this.dragOver(!1)}})}U("enter,open","",e,(()=>_()?(Gs.mainSearch(Er),!1):Nt.message()&&Gs.canAutoSelect()?(gt()||ft(),!1):void 0)),V("z","",[e,s],(()=>(this.archiveCommand(),!1))),V("delete","shift",e,(()=>(Gs.listCheckedOrSelected().length&&this.deleteWithoutMoveCommand(),!1))),V("delete","",e,(()=>(Gs.listCheckedOrSelected().length&&this.deleteCommand(),!1))),U("r","meta",[t,e,s],(()=>(this.reload(),!1))),V("a","meta",e,(()=>(this.checkAll(!(this.checkAll()&&!this.isIncompleteChecked())),!1))),V("w,c,new","",[e,s],(()=>(ii(),!1))),V("i","",[e,s],(()=>{const e=Gs.listCheckedOrSelected();return e.length&&br(e[0].folder,e.every((e=>e.isFlagged()))?Re:De,e),!1})),V("t","",[e],(()=>{let e=Gs.selectedMessage()||Gs.focusedMessage();return 0<e?.threadsLen()&&this.gotoThread(e),!1})),V("insert","",e,(()=>(this.moveCommand(),!1))),V("q","",[e,s],(()=>(this.seenMessagesFast(!0),!1))),V("u","",[e,s],(()=>(this.seenMessagesFast(!1),!1))),V("f,mailforward","shift",[e,s],(()=>(this.forwardCommand(),!1))),L("Search")&&U("/","",[e,s],(()=>(this.focusSearch(!0),!1))),U("escape","",e,(()=>this.messageListSearchDesc()?(this.cancelSearch(),!1):Gs.endThreadUid()?(this.cancelThreadUid(),!1):void 0)),U("tab","shift",e,(()=>(xt.focusedState(t),!1))),U("arrowleft","",e,(()=>(xt.focusedState(t),!1))),U("tab,arrowright","",e,(()=>{if(Nt.message())return xt.focusedState(s),!1})),U("arrowleft","meta",s,(()=>!1)),U("arrowright","meta",s,(()=>!1)),U("f","meta",e,this.advancedSearchClick)}advancedSearchClick(){Mt(AdvancedSearchPopupView,[Gs.mainSearch()])}groupSearch(e){e.search&&Gs.mainSearch(e.search)}groupCheck(e){e.messages.forEach((e=>e.checked(!e.checked())))}quotaTooltip(){return he("MESSAGE_LIST/QUOTA_SIZE",{SIZE:ws.friendlySize(es.quotaUsage()),PROC:es.quotaPercentage(),LIMIT:ws.friendlySize(es.quotaLimit())}).replace(/<[^>]+>/g,"")}}const kr=[/=([0-9A-F]{2})/g,(...e)=>String.fromCharCode(parseInt(e[1],16))],Cr=e=>e.replace(/=\r?\n/g,"").replace(...kr),Ar=(e,t)=>{try{return new TextDecoder(e).decode(Uint8Array.from(t,(e=>e.charCodeAt(0))))}catch(e){}};function Tr(e,t){let s;const i=function(e){class MimePart{header(e){return this.headers?.[e]}headerValue(e){return this.header(e)?.value}get raw(){return e.slice(this.start,this.end)}get bodyRaw(){return e.slice(this.bodyStart,this.bodyEnd)}get body(){let e=this.bodyRaw,t=this.header("content-type")?.params.charset,s=this.headerValue("content-transfer-encoding");return"quoted-printable"==s?e=Cr(e):"base64"==s&&(e=atob(e.replace(/\r?\n/g,""))),Ar(t,e)}get dataUrl(){let e=this.bodyRaw,t=this.headerValue("content-transfer-encoding");return"base64"==t?e=e.replace(/\r?\n/g,""):("quoted-printable"==t&&(e=Cr(e)),e=btoa(e)),"data:"+this.headerValue("content-type")+";base64,"+e}forEach(e){e(this),this.parts.forEach((t=>t.forEach(e)))}getByContentType(e){if(e==this.headerValue("content-type"))return this;let t,s=0,i=this.parts;for(;s<i.length;++s)if(t=i[s].getByContentType(e))return t}}const t=(e,s=0,i="")=>{let r=new MimePart,a=e.match(/^[\s\S]+?\r?\n\r?\n/)?.[0],o={};if(i&&(r.id=i,r.start=s,r.end=s+e.length),r.parts=[],a){a.replace(/\r?\n\s+/g," ").split(/\r?\n/).forEach((e=>{let t=e.match(/^([^:]+):\s*([^;]+)/),s={};t&&([...e.matchAll(/;\s*([^;=]+)=\s*"?([^;"]+)"?/g)].forEach((e=>s[e[1].trim().toLowerCase()]=e[2].trim())),t[2]=t[2].trim().replace(/=\?([^?]+)\?(B|Q)\?(.+?)\?=/g,((e,t,s,i)=>Ar(t,"B"==s?atob(i):Cr(i)))),o[t[1].trim().toLowerCase()]={value:t[2],params:s})})),r.bodyStart=s+a.length,r.bodyEnd=s+e.length;let n=o["content-type"]?.params.boundary;if(n){r.boundary=n;let s=new RegExp("(?:^|\r?\n)--"+n+"(?:--)?(?:\r?\n|$)","g"),o=e.slice(a.length),l=o.split(s),c=r.bodyStart;[...o.matchAll(s)].forEach((([e],s)=>{s||(r.bodyText=l[0]),"--"!=e.trim().slice(-2)&&(c+=l[s].length+e.length,r.parts.push(t(l[1+s],c,(i?i+".":"")+(1+s))))}))}r.headers=o}return r};return t(e)}(e);if(i.headers){let e=i.getByContentType("text/html"),r=i.headerValue("subject");e=e?e.body:"",r&&t.subject(r),["from","to"].forEach((e=>t[e].fromString(i.headerValue(e)))),i.forEach((i=>{let r=i.header("content-disposition"),a=i.header("content-id"),o=i.header("content-type");if(a||r){let s=new AttachmentModel;if(s.mimeType=o.value,s.fileName=o.name||r&&r.params.filename||"",s.fileNameExt=s.fileName.replace(/^.+(\.[a-z]+)$/,"$1"),s.fileType=ws.getType("",o.value),s.url=i.dataUrl,s.estimatedSize=i.body.length,s.cId=a?a.value:"",a&&e){let t="cid:"+s.contentId(),i=e.includes(t);s.isInline(i),s.isLinked(i),i&&(e=e.replace('src="'+t+'"','src="'+s.url+'"').replace("src='"+t+"'","src='"+s.url+"'"))}else t.attachments.push(s)}else"multipart/signed"===o.value&&"application/pgp-signature"===o.params.protocol&&(s={micAlg:o.micalg,bodyPart:i.parts[0],sigPart:i.parts[1]})}));const a=i.getByContentType("text/plain");t.plain(a?a.body:""),t.html(e)}else t.plain(e);!s&&t.plain().includes(Xi)&&(s=!0),t.pgpSigned(s)}class OpenPgpImportPopupView extends AbstractViewPopup{constructor(){super("OpenPgpImport"),Ee(this,{key:"",keyError:!1,keyErrorMessage:"",saveGnuPG:!0,saveServer:!1}),this.canGnuPG=Hi.isSupported(),this.key.subscribe((()=>{this.keyError(!1),this.keyErrorMessage("")}))}submitForm(){let e=this.key().trim();if(/\n/.test(e)&&(e=e.replace(/\r+/g,"").replace(/\n{2,}/g,"\n\n")),this.keyError(!e),this.keyErrorMessage(""),!e)return;let t=null,s=30,i=!1;const r=/[-]{3,6}BEGIN[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[-]{3,6}[\s\S]+?[-]{3,6}END[\s]PGP[\s](PRIVATE|PUBLIC)[\s]KEY[\s]BLOCK[-]{3,6}/gi;do{t=r.exec(e),t&&0<s?(t[0]&&t[1]&&t[2]&&t[1]===t[2]&&(this.saveGnuPG()&&Hi.isSupported()&&Hi.importKey(this.key(),((e,t)=>{e&&alert(t.ErrorMessage)})),Yi.isSupported()&&Yi.importKey(this.key())),--s,i=!1):i=!0}while(!i);this.keyError()||this.close()}onShow(e){this.key(e||""),this.keyError(!1),this.keyErrorMessage("")}}const Fr=()=>A("messageItem")||{},Mr=Nt.message,Lr=e=>{const t=Mr();t&&Gs.setAction(t.folder,e,[t])},Pr=e=>rl.fetch(e).then((e=>e.ok&&e.text()));class MailMessageView extends AbstractViewRight{constructor(){super();const e=(e,t)=>{let s=()=>(t()&&e.call(null),!1);return s.canExecute=t,s},t=t=>e((()=>this.replyOrforward(t)),this.canBeRepliedOrForwarded),s=(t,s)=>e((()=>{const e=Mr();e&&(Mr(null),rl.app.moveMessagesToFolderType(t,e.folder,[e.uid],s))}),this.messageVisibility);this.msgDefaultAction=He.msgDefaultAction,this.simpleAttachmentsList=He.simpleAttachmentsList,Ee(this,{showAttachmentControls:!!Ys(10),downloadAsZipLoading:!1,showFullInfo:"1"===Ys(9),moreDropdownTrigger:!1,viewFromShort:"",dkimData:["none","",""]}),this.moveAction=Zs;const i=F.app("attachmentsActions");this.attachmentsActions=ko.observableArray(h(i)?i:[]),this.hasCheckedMessages=Gs.hasChecked,this.archiveAllowed=Gs.archiveAllowed,this.canMarkAsSpam=Gs.canMarkAsSpam,this.isDraftFolder=Gs.isDraftFolder,this.isSpamFolder=Gs.isSpamFolder,this.message=Mr,this.messageLoadingThrottle=Nt.loading,this.messageError=Nt.error,this.fullScreenMode=gt,this.toggleFullScreen=ft,this.downloadAsZipError=ko.observable(!1).extend({falseTimeout:7e3}),this.messageDomFocused=ko.observable(!1).extend({rateLimit:0}),this.viewHash="",ke(this,{allowAttachmentControls:()=>h(i)&&L("AttachmentsActions"),downloadAsZipAllowed:()=>this.attachmentsActions.includes("zip")&&(Mr()?.attachments||[]).filter((e=>e?.download&&e?.checked())).length,tagsAllowed:()=>es.currentFolder()?.tagsAllowed(),messageVisibility:()=>!Nt.loading()&&!!Mr(),tagsToHTML:()=>Mr()?.flags().map((e=>Qt(e)?'<span class="focused msgflag-'+e+'">'+he("MESSAGE_TAGS/"+e,0,e)+"</span>":"")).join(" "),askReadReceipt:()=>(Gs.isDraftFolder()||Gs.isSentFolder())&&Mr()?.readReceipt()&&Mr()?.flags().includes("$mdnsent"),listAttachments:()=>Mr()?.attachments().filter((e=>He.listInlineAttachments()||!e.isLinked())),hasAttachments:()=>this.listAttachments()?.length,canBeRepliedOrForwarded:()=>!Gs.isDraftFolder()&&this.messageVisibility(),viewDkimIcon:()=>"none"!==this.dkimData()[0],dkimIconClass:()=>{switch(this.dkimData()[0]){case"none":return"";case"pass":return"icon-ok iconcolor-green";default:return"icon-cross iconcolor-red"}},dkimTitle:()=>{const e=this.dkimData();return e[0]?e[2]||"DKIM: "+e[0]:""},showWhitelistOptions:()=>"match"===He.viewImages(),firstUnsubsribeLink:()=>Mr()?.unsubsribeLinks()[0]||"",pgpSupported:()=>Mr()&&Qi.isSupported(),messageListOrViewLoading:()=>Gs.isLoading()|Nt.loading()}),Ce(this,{message:e=>{e?(this.viewHash!==e.hash&&this.scrollMessageToTop(),this.viewHash=e.hash,this.viewFromShort(e.from.toString(!1,!0)),this.dkimData(e.dkim[0]||["none","",""])):(Gs.selectedMessage(null),this.viewHash="",this.scrollMessageToTop())},showFullInfo:e=>zs(9,e?"1":"0")}),this.replyCommand=t(Ie.Reply),this.replyAllCommand=t(Ie.ReplyAll),this.forwardCommand=t(Ie.Forward),this.forwardAsAttachmentCommand=t(Ie.ForwardAsAttachment),this.editAsNewCommand=t(Ie.EditAsNew),this.deleteCommand=s(Me.Trash),this.deleteWithoutMoveCommand=s(Me.Trash,!0),this.archiveCommand=s(Me.Archive),this.spamCommand=s(Me.Junk),this.notSpamCommand=s(Me.Inbox),It(this,{editCommand:e=>e.messageVisibility(),goUpCommand:e=>!e.messageListOrViewLoading(),goDownCommand:e=>!e.messageListOrViewLoading()})}toggleFullInfo(){this.showFullInfo(!this.showFullInfo())}closeMessage(){Mr(null)}editCommand(){Mr()&&ii([Ie.Draft,Mr()])}setUnseen(){Lr(Ne),Mr(null)}goUpCommand(){R("mailbox.message-list.selector.go-up",!!Mr())}goDownCommand(){R("mailbox.message-list.selector.go-down",!!Mr())}replyOrforward(e){ii([e,Mr()])}onBuild(t){const i=(e,s)=>e.target.closestWithin(s,t);t.addEventListener("click",(e=>{let t=i(e,"a");if(t&&0===e.button&&si(t.href))O(e);else if(!i(e,".attachmentsPlace .showPreview"))if(t=i(e,".attachmentsPlace .showPreplay"),t){O(e);const s=ko.dataFor(t);if(s&&Ht.supported)switch(!0){case Ht.supportedMp3&&s.isMp3():Ht.playMp3(s.linkDownload(),s.fileName);break;case Ht.supportedOgg&&s.isOgg():Ht.playOgg(s.linkDownload(),s.fileName);break;case Ht.supportedWav&&s.isWav():Ht.playWav(s.linkDownload(),s.fileName)}}else{if(t=i(e,".attachmentItem"),t){const e=ko.dataFor(t),s=e?.linkDownload();s&&("application/pgp-keys"==e.mimeType&&(Yi.isSupported()||Hi.isSupported())?Pr(s).then((e=>Mt(OpenPgpImportPopupView,[e]))):"message/rfc822"==e.mimeType?Pr(s).then((e=>{const t=new MessageModel;Tr(e,t),t.viewPopupMessage()})):Qs(s,e.fileName))}i(e,".messageItemHeader .subjectParent .flagParent")&&Lr(Mr()?.isFlagged()?Re:De)}})),H.subscribe((e=>this.messageDomFocused(s===e))),U("escape","",s,(()=>{if(!this.viewModelDom.hidden&&Mr()){const t=He.usePreviewPane();return gt()?(mt(),t&&xt.focusedState(e)):t?xt.focusedState(e):Mr(null),!1}})),U("enter,open","",s,(()=>(gt()||ft(),!1))),V("r,mailreply","",[e,s],(()=>!Mr()||(this.replyCommand(),!1))),V("a","",[e,s],(()=>{if(Mr())return this.replyAllCommand(),!1})),V("mailreply","shift",[e,s],(()=>{if(Mr())return this.replyAllCommand(),!1})),V("f,mailforward","",[e,s],(()=>{if(Mr())return this.forwardCommand(),!1})),V("i","meta",[e,s],(()=>(Mr()&&this.toggleFullInfo(),!1))),V("b","",[e,s],(()=>{const e=Mr();if(e?.body)return e.body.querySelectorAll("details").forEach((e=>e.open=!e.open)),!1})),U("arrowup,arrowleft","meta",[e,s],(()=>(this.goUpCommand(),!1))),U("arrowdown,arrowright","meta",[e,s],(()=>(this.goDownCommand(),!1))),U("delete","",s,(()=>(this.deleteCommand(),!1))),U("delete","shift",s,(()=>(this.deleteWithoutMoveCommand(),!1))),U("arrowleft","",s,(()=>{if(!gt()&&Mr()&&He.usePreviewPane()&&!Fr().scrollLeft)return xt.focusedState(e),!1})),U("tab","shift",s,(()=>(!gt()&&Mr()&&He.usePreviewPane()&&xt.focusedState(e),!1))),Nt.bodiesDom(t.querySelector(".bodyText"))}scrollMessageToTop(){Fr().scrollTop=0}scrollMessageToLeft(){Fr().scrollLeft=0}toggleAttachmentControls(){const e=!this.showAttachmentControls();this.showAttachmentControls(e),zs(10,e)}downloadAsZip(){const e=(Mr()?.attachments||[]).map((e=>e?.checked()?e.download:"")).filter((e=>e));ei(Mr().subject(),e,(()=>this.downloadAsZipError(!0)),this.downloadAsZipLoading)}showImages(){Mr().showExternalImages()}whitelistText(e){let t=(He.viewImagesWhitelist().trim()+"\n"+e).trim();He.viewImagesWhitelist(t),Ms.saveSetting("ViewImagesWhitelist",t),Mr().showExternalImages(1)}printableCheckedMessageCount(){const e=Gs.listCheckedOrSelectedUidsWithSubMails().size;return 0<e?100>e?e:"99+":""}readReceipt(){let e=Mr();e.readReceipt()&&Ms.request("SendReadReceiptMessage",(t=>{t||e.flags.push("$mdnsent")}),{messageFolder:e.folder,messageUid:e.uid,readReceipt:e.readReceipt(),subject:he("READ_RECEIPT/SUBJECT",{SUBJECT:e.subject()}),plain:he("READ_RECEIPT/BODY",{"READ-RECEIPT":xs.email()})})}newTag(){let e=Mr();if(e){let t=prompt(he("MESSAGE/NEW_TAG"),"")?.replace(/[\s\\]+/g,"");t.length&&Qt(t)&&(e.toggleTag(t),es.currentFolder().permanentFlags.push(t))}}pgpDecrypt(){const e=Mr();Qi.decrypt(e).then((t=>{t?(e.pgpDecrypted(!0),t.data&&(Tr(t.data,e),e.html()?e.viewHtml():e.viewPlain(),t.signatures?.length&&(e.pgpSigned(!0),e.pgpVerified({signatures:t.signatures,success:!!t.signatures.length})))):alert("Decryption failed, canceled or not possible")})).catch((e=>{}))}pgpVerify(){const e=Mr();Qi.verify(e).then((t=>{t?e.pgpVerified(t):alert("Verification failed or no valid public key found")}))}}class MailBoxUserScreen extends AbstractScreen{constructor(){var e=D("style");k.head.appendChild(e),ge((()=>e.innerText='.subjectParent:empty::after,.subjectParent .subject:empty::after{content:"'+he("MESSAGE/EMPTY_SUBJECT_TEXT")+'"}')),super("mailbox",[SystemDropDownUserView,MailFolderList,MailMessageList,MailMessageView])}updateWindowTitle(){const e=F.app("listPermanentFiltered")?0:es.foldersInboxUnreadCount(),t=xs.email();rl.setTitle((t?(0<e?"("+e+") ":" ")+t+" - ":"")+he("TITLES/MAILBOX"))}onShow(){this.updateWindowTitle(),xt.focusedState("none"),xt.focusedState(e)}onRoute(e,t,s,i){const r=(a=e.replace(/~([\d]+)$/,""),Yt(jt.get(a)));var a;if(r){if(es.currentFolder(r),Gs.page(1>t?1:t),Gs.listSearch(s),i){let t=new MessageModel;t.folder=e,t.uid=i,oi(t)}else{let t=e.replace(/^.+~(\d+)$/,"$1");Gs.threadUid(e===t?0:f(t))}Gs.reload()}}onStart(){super.onStart(),addEventListener("mailbox.inbox-unread-count",(e=>{es.foldersInboxUnreadCount(e.detail),this.updateWindowTitle()}))}onBuild(){k.addEventListener("click",(e=>e.target.closest("#rl-right")&&Zs(!1)))}routes(){const e=(e,t)=>e?p(t[0]):$t(),t=(t,s)=>[e(t,s),t?f(s[1]):1,decodeURI(p(s[2]))];return[[/^([^/]*)$/,{normalize_:t}],[/^([a-zA-Z0-9.~_-]+)\/(.+)\/?$/,{normalize_:(t,s)=>[e(t,s),1,decodeURI(p(s[1]))]}],[/^([a-zA-Z0-9.~_-]+)\/m([1-9][0-9]*)(?:\/(.+))?$/,{normalize_:(t,s)=>[e(t,s),1,p(s[2]),p(s[1])]}],[/^([a-zA-Z0-9.~_-]+)\/p([1-9][0-9]*)(?:\/(.+))?$/,{normalize_:t}]]}}const Ir=[];class AbstractSettingsScreen extends AbstractScreen{constructor(e){super("settings",e),this.menu=ko.observableArray(),this.oCurrentSubScreen=null}onRoute(e){let t=null,s=null,i=Ir.find((t=>e===t.route));if(i){const e=this.viewModels[1].__dom,r=i.vmc;r.__vm?(t=r.__vm,s=t.viewModelDom):e&&(s=D("div",{id:"V-Settings-"+r.name.replace(/(User|Admin)Settings/,""),hidden:""}),e.append(s),t=new r,t.viewModelDom=s,t.viewModelTemplateID=i.template,r.__dom=s,r.__vm=t,R("rl-view-model.create",t),ko.applyBindingAccessorsToNode(s,{template:()=>({name:i.template})},t),t.onBuild?.(s),R("rl-view-model",t)),t&&setTimeout((()=>{this.onHide(),this.oCurrentSubScreen=t,t.beforeShow?.(),ue(s),s.hidden=!1,t.onShow?.(),this.menu.forEach((e=>{e.selected(e.route===i.route)})),(e||{}).scrollTop=0}),1)}else hasher.replaceHash(te())}onHide(){let e=this.oCurrentSubScreen;e&&(e.onHide?.(),e.viewModelDom.hidden=!0)}onBuild(){Ir.forEach((e=>this.menu.push(e)))}routes(){const e=Ir.find((e=>e.isDefault)),t=e?.route||"general",s={subname:/^(.*)$/,normalize_:(e,s)=>(s.subname=null==s.subname?t:p(s.subname),[s.subname])};return[["{subname}/",s],["{subname}",s],["",s]]}}function xr(e,t,s,i,r=!1){let a=e.name.replace(/(User|Admin)Settings/,"");Ir.push({vmc:e,label:s||"SETTINGS_LABELS/"+a.toUpperCase(),route:i||a.toLowerCase(),selected:ko.observable(!1),template:t||e.name,isDefault:!!r})}const Nr=[],Dr=[];rl.pluginRemoteRequest=(e,t,s,i)=>{rl.app.Remote.request("Plugin"+t,e,s,i)},rl.addSettingsViewModel=(e,t,s,i)=>{Nr.push([e,t,s,i])},rl.addSettingsViewModelForAdmin=(e,t,s,i)=>{Dr.push([e,t,s,i])},rl.pluginSettingsGet=(e,t)=>M("Plugins")?.[e]?.[t],rl.pluginPopupView=AbstractViewPopup;class IdentityPopupView extends AbstractViewPopup{constructor(){super("Identity"),Ee(this,{id:"",edit:!1,email:"",emailFocused:!1,name:"",nameFocused:!1,replyTo:"",showReplyTo:!1,bcc:"",showBcc:!1,signature:"",signatureInsertBefore:!1,submitRequest:!1,submitError:""})}submitForm(e){if(!this.submitRequest()&&e.reportValidity()){this.signature?.__fetchEditorValue?.(),this.submitRequest(!0);const t=new FormData(e);t.set("Id",this.id()),t.set("Signature",this.signature()),Ms.request("IdentityUpdate",(e=>{this.submitRequest(!1),e?this.submitError(fe(e)):(rl.app.accountsAndIdentities(),this.close())}),t)}}onShow(e){this.showBcc(!1),this.showReplyTo(!1),this.submitRequest(!1),this.submitError(""),e?this.edit(!0):(this.edit(!1),(e=new IdentityModel).id(Jua.randomId())),this.id(e.id()||""),this.name(e.name()),this.email(e.email()),this.replyTo(e.replyTo()),this.showReplyTo(0<e.replyTo().length),this.bcc(e.bcc()),this.showBcc(0<e.bcc().length),this.signature(e.signature()),this.signatureInsertBefore(e.signatureInsertBefore())}afterShow(){this.id()?this.emailFocused(!0):this.nameFocused(!0)}}class UserSettingsGeneral extends AbstractViewSettings{constructor(){super(),this.language=ie.language,this.languages=ie.languages,this.hourCycle=ie.hourCycle,this.soundNotification=Ht.notifications,this.notificationSound=ko.observable(M("NotificationSound")),this.notificationSounds=ko.observableArray(M("newMailSounds")),this.desktopNotifications=qs.enabled,this.isDesktopNotificationAllowed=qs.allowed,this.threadsAllowed=xt.threadsAllowed,["layout","messageReadDelay","messagesPerPage","checkMailInterval","editorDefaultType","requestReadReceipt","requestDsn","requireTLS","pgpSign","pgpEncrypt","viewHTML","viewImages","viewImagesWhitelist","removeColors","allowStyles","allowDraftAutosave","hideDeleted","listInlineAttachments","simpleAttachmentsList","collapseBlockquotes","maxBlockquotesLevel","useCheckboxesInList","listGrouped","useThreads","replySameFolder","msgDefaultAction","allowSpellcheck","showNextMessage"].forEach((e=>this[e]=He[e])),this.allowLanguagesOnSettings=!!M("allowLanguagesOnSettings"),this.languageTrigger=ko.observable(o),this.identities=Ui,ke(this,{languageFullName:()=>ve(this.language()),identityMain:()=>{const e=this.identities();return d(e)?e.find((e=>e&&!e.id())):null},identityMainDesc:()=>{const e=this.identityMain();return e?e.formattedName():"---"},editorDefaultTypes:()=>(ce(),[{id:"Html",name:he("SETTINGS_GENERAL/EDITOR_HTML")},{id:"Plain",name:he("SETTINGS_GENERAL/EDITOR_PLAIN")}]),msgDefaultActions:()=>(ce(),[{id:1,name:he("MESSAGE/BUTTON_REPLY")},{id:2,name:he("MESSAGE/BUTTON_REPLY_ALL")}]),layoutTypes:()=>(ce(),[{id:0,name:he("SETTINGS_GENERAL/LAYOUT_NO_SPLIT")},{id:1,name:he("SETTINGS_GENERAL/LAYOUT_VERTICAL_SPLIT")},{id:2,name:he("SETTINGS_GENERAL/LAYOUT_HORIZONTAL_SPLIT")}])}),this.addSetting("EditorDefaultType"),this.addSetting("MsgDefaultAction"),this.addSetting("MessageReadDelay"),this.addSetting("MessagesPerPage"),this.addSetting("CheckMailInterval"),this.addSetting("Layout"),this.addSetting("MaxBlockquotesLevel"),this.addSettings(["ViewHTML","ViewImages","ViewImagesWhitelist","HideDeleted","RemoveColors","AllowStyles","ListInlineAttachments","simpleAttachmentsList","UseCheckboxesInList","listGrouped","ReplySameFolder","requestReadReceipt","requestDsn","requireTLS","pgpSign","pgpEncrypt","allowSpellcheck","DesktopNotifications","SoundNotification","CollapseBlockquotes","AllowDraftAutosave","showNextMessage"]);const e=e=>()=>{this.languageTrigger(e),setTimeout((()=>this.languageTrigger(o)),1e3)};Ce(this,{language:t=>{this.languageTrigger(a),ye(t).then(e(n),e(l)).then((()=>Ms.saveSetting("language",t)))},hourCycle:e=>Ms.saveSetting("hourCycle",e),notificationSound:e=>{Ms.saveSetting("NotificationSound",e),F.set("NotificationSound",e)},useThreads:e=>{Gs([]),Ms.saveSetting("UseThreads",e)},checkMailInterval:()=>{ui(He.checkMailInterval())}})}editMainIdentity(){const e=this.identityMain();e&&Mt(IdentityPopupView,[e])}testSoundNotification(){Ht.playNotification(!0)}testSystemNotification(){qs.display("SnappyMail","Test notification")}selectLanguage(){Mt(LanguagesPopupView,[this.language,this.languages(),ie.userLanguage()])}}class UserSettingsContacts{constructor(){this.contactsAutosave=ko.observable(!!M("ContactsAutosave")),this.allowContactsSync=_i.allowSync,this.syncMode=_i.syncMode,this.syncUrl=_i.syncUrl,this.syncUser=_i.syncUser,this.syncPass=_i.syncPass,this.syncModeOptions=we((()=>(ce(),[{id:0,name:he("GLOBAL/NO")},{id:1,name:he("GLOBAL/YES")},{id:2,name:he("SETTINGS_CONTACTS/SYNC_READ")}]))),this.saveTrigger=we((()=>[_i.syncMode(),_i.syncUrl(),_i.syncUser(),_i.syncPass()].join("|"))).extend({debounce:500}),this.contactsAutosave.subscribe((e=>Ms.saveSettings(null,{ContactsAutosave:e}))),this.saveTrigger.subscribe((()=>Ms.request("SaveContactsSyncData",null,{Mode:_i.syncMode(),Url:_i.syncUrl(),User:_i.syncUser(),Password:_i.syncPass()})))}}class UserSettingsAccounts{constructor(){this.allowAdditionalAccount=L("AdditionalAccounts"),this.allowIdentities=L("Identities"),this.accounts=xs,this.loading=xs.loading,this.identities=Ui,this.mainEmail=M("mainEmail"),this.accountForDeletion=ko.observable(null).askDeleteHelper(),this.identityForDeletion=ko.observable(null).askDeleteHelper(),this.showUnread=He.showUnreadCount,He.showUnreadCount.subscribe((e=>Ms.saveSetting("ShowUnreadCount",e)))}addNewAccount(){Mt(AccountPopupView)}editAccount(e){e?.isAdditional()&&Mt(AccountPopupView,[e])}addNewIdentity(){Mt(IdentityPopupView)}editIdentity(e){Mt(IdentityPopupView,[e])}deleteAccount(e){e?.askDelete()&&(this.accountForDeletion(null),this.accounts.remove((t=>e===t)),Ms.request("AccountDelete",((e,t)=>{!e&&t.Reload?(rl.route.root(),setTimeout((()=>location.reload()),1)):rl.app.accountsAndIdentities()}),{emailToDelete:e.email}))}deleteIdentity(e){e?.askDelete()&&(this.identityForDeletion(null),Ui.remove((t=>e===t)),Ms.request("IdentityDelete",(()=>rl.app.accountsAndIdentities()),{idToDelete:e.id()}))}accountsAndIdentitiesAfterMove(){Ms.request("AccountsAndIdentitiesSortOrder",null,{Accounts:xs.getEmailAddresses().filter((e=>e!=M("mainEmail"))),Identities:Ui.map((e=>e?e.id():""))})}onBuild(e){e.addEventListener("click",(t=>{let s=t.target.closestWithin(".accounts-list .e-action",e);s&&ko.dataFor(s)&&this.editAccount(ko.dataFor(s)),s=t.target.closestWithin(".identities-list .e-action",e),s&&ko.dataFor(s)&&this.editIdentity(ko.dataFor(s))}))}}class UserSettingsFilters{constructor(){this.scripts=ko.observableArray(),this.loading=ko.observable(!0).extend({debounce:200}),Ee(this,{serverError:!1,serverErrorDesc:""}),rl.loadScript(M("StaticLibsJs").replace("/libs.","/sieve.")).then((()=>{const e=window.Sieve;e.folderList=es.folderList,e.serverError.subscribe((e=>this.serverError(e))),e.serverErrorDesc.subscribe((e=>this.serverErrorDesc(e))),e.loading.subscribe((e=>this.loading(e))),e.scripts.subscribe((e=>this.scripts(e))),e.updateList()})).catch((e=>{})),this.hasActive=we((()=>this.scripts().filter((e=>e.active())).length)),this.scriptForDeletion=ko.observable(null).askDeleteHelper()}addScript(){this.editScript()}editScript(e){window.Sieve.ScriptView.showModal(e?[e]:null)}deleteScript(e){window.Sieve.deleteScript(e)}disableScripts(){window.Sieve.setActiveScript("")}enableScript(e){window.Sieve.setActiveScript(e.name())}onBuild(e){e.addEventListener("click",(t=>{const s=t.target.closestWithin(".script-item .script-name",e),i=s&&ko.dataFor(s);i&&this.editScript(i)}))}onShow(){window.Sieve?.updateList()}}class OpenPgpGeneratePopupView extends AbstractViewPopup{constructor(){super("OpenPgpGenerate"),this.identities=Ui,Ee(this,{email:"",emailError:!1,name:"",password:"",keyType:"ECC",submitRequest:!1,submitError:"",backupPublicKey:!0,backupPrivateKey:!1,saveGnuPGPublic:!0,saveGnuPGPrivate:!1}),this.canGnuPG=L("GnuPG"),this.email.subscribe((()=>this.emailError(!1)))}submitForm(){const e={type:this.keyType().toLowerCase(),userIDs:[{name:this.name(),email:this.email()}],passphrase:this.password().trim()};this.emailError(!this.email().trim()),this.emailError()||(this.submitRequest(!0),this.submitError(""),openpgp.generateKey(e).then((e=>{if(e){const t=()=>{this.submitRequest(!1),this.close()};Yi.storeKeyPair(e),e.onServer=(this.backupPublicKey()?1:0)+(this.backupPrivateKey()?2:0),e.inGnuPG=(this.saveGnuPGPublic()?1:0)+(this.saveGnuPGPrivate()?2:0),e.onServer||e.inGnuPG?(this.backupPrivateKey()||this.saveGnuPGPrivate()||delete e.privateKey,Hi.storeKeyPair(e,t)):t()}})).catch((e=>{this.submitRequest(!1),this.showError(e)})))}hideError(){this.submitError("")}showError(e){e?.message&&this.submitError(e.message)}onShow(){this.name(""),this.password(""),this.email(""),this.emailError(!1),this.submitError("")}}class UserSettingsSecurity extends AbstractViewSettings{constructor(){super(),this.autoLogout=He.autoLogout,this.autoLogoutOptions=we((()=>(ce(),[{id:0,name:he("SETTINGS_SECURITY/AUTOLOGIN_NEVER_OPTION_NAME")},{id:5,name:de(300)},{id:10,name:de(600)},{id:30,name:de(1800)},{id:60,name:de(3600)},{id:120,name:de(7200)},{id:300,name:de(18e3)},{id:600,name:de(36e3)}]))),this.addSetting("AutoLogout"),this.gnupgPublicKeys=Hi.publicKeys,this.gnupgPrivateKeys=Hi.privateKeys,this.openpgpkeysPublic=Yi.publicKeys,this.openpgpkeysPrivate=Yi.privateKeys,this.canOpenPGP=L("OpenPGP"),this.canGnuPG=Hi.isSupported(),this.canMailvelope=!!window.mailvelope}addOpenPgpKey(){Mt(OpenPgpImportPopupView)}generateOpenPgpKey(){Mt(OpenPgpGeneratePopupView)}onBuild(){window.mailvelope&&mailvelope.createSettingsContainer("#mailvelope-settings")}}const Rr=ko.observable(null).askDeleteHelper();class UserSettingsFolders{constructor(){this.showKolab=es.allowKolab(),this.defaultOptionsAfterRender=b,this.kolabTypeOptions=ko.observableArray();let e=e=>he("SETTINGS_FOLDERS/TYPE_"+e);ge((()=>{this.kolabTypeOptions([{id:"",name:""},{id:"event",name:e("CALENDAR")},{id:"contact",name:e("CONTACTS")},{id:"task",name:e("TASKS")},{id:"note",name:e("NOTES")},{id:"file",name:e("FILES")},{id:"journal",name:e("JOURNAL")},{id:"configuration",name:e("CONFIGURATION")}])})),this.displaySpecSetting=es.displaySpecSetting,this.folderList=es.folderList,this.folderListOptimized=es.folderListOptimized,this.folderListError=es.folderListError,this.hideUnsubscribed=He.hideUnsubscribed,this.unhideKolabFolders=He.unhideKolabFolders,this.loading=es.foldersChanging,this.folderForDeletion=Rr,He.hideUnsubscribed.subscribe((e=>Ms.saveSetting("HideUnsubscribed",e))),He.unhideKolabFolders.subscribe((e=>Ms.saveSetting("UnhideKolabFolders",e)))}onShow(){es.folderListError("")}createFolder(){Mt(FolderCreatePopupView)}systemFolder(){Mt(FolderSystemPopupView)}deleteFolder(e){e&&e.canBeDeleted()&&e.askDelete()&&(0<e.totalEmails()?e.errorMsg(fe(c.CantDeleteNonEmptyFolder)):(Rr(null),e&&Ms.abort("Folders").post("FolderDelete",es.foldersDeleting,{folder:e.fullName}).then((()=>{if(e.selectable(!1),!e.subFolders.length){Zt(e.fullName);const t=Yt(e.parentName);(t?t.subFolders:es.folderList).remove(e)}}),(e=>{es.folderListError(fe(e.code,"",c.CantDeleteFolder)+".\n"+e.message)}))))}hideError(){this.folderListError("")}toggleFolderKolabType(e,t){let s=t.target.value;Ms.request("FolderSetMetadata",null,{folder:e.fullName,key:Le,value:s}),e.kolabType(s)}toggleFolderSubscription(e){let t=!e.isSubscribed();Ms.request("FolderSubscribe",null,{folder:e.fullName,subscribe:t?1:0}),e.isSubscribed(t)}toggleFolderCheckable(e){let t=!e.checkable();Ms.request("FolderCheckable",null,{folder:e.fullName,checkable:t?1:0}),e.checkable(t)}}const Or={name:Ue.userBackgroundName,hash:Ue.userBackgroundHash};Ee(Or,{uploaderButton:null,loading:!1,error:""});class UserSettingsThemes{constructor(){this.fontSansSerif=Ue.fontSansSerif,this.fontSerif=Ue.fontSerif,this.fontMono=Ue.fontMono,Ce(Ue,{fontSansSerif:e=>{Ms.saveSettings(null,{fontSansSerif:e})},fontSerif:e=>{Ms.saveSettings(null,{fontSerif:e})},fontMono:e=>{Ms.saveSettings(null,{fontMono:e})}}),this.theme=Ue.theme,this.themes=Ue.themes,this.themesObjects=ko.observableArray(),Or.enabled=L("UserBackground"),this.background=Or,this.themeTrigger=ko.observable(o).extend({debounce:100}),Ue.theme.subscribe((e=>{this.themesObjects.forEach((t=>t.selected(e===t.name))),qe(e,this.themeTrigger),Ms.saveSettings(null,{Theme:e})}))}setTheme(e){Ue.theme(e.name)}onBuild(){const e=Ue.theme();if(this.themesObjects(Ue.themes.map((t=>({name:t,nameDisplay:Be(t),selected:ko.observable(t===e),themePreviewSrc:ee(t)})))),Or.uploaderButton()&&Or.enabled){new Jua({action:X("UploadBackground"),limit:1,clickElement:Or.uploaderButton()}).on("onStart",(()=>{Or.loading(!0),Or.error("")})).on("onComplete",((e,t,s)=>{if(Or.loading(!1),Or.name(s?.Result?.name||""),Or.hash(s?.Result?.hash||""),!Or.name()||!Or.hash()){let e="";if(s.ErrorCode)switch(s.ErrorCode){case r.FileIsTooBig:e=he("SETTINGS_THEMES/ERROR_FILE_IS_TOO_BIG");break;case r.FileType:e=he("SETTINGS_THEMES/ERROR_FILE_TYPE_ERROR")}Or.error(e||s.ErrorMessage||he("SETTINGS_THEMES/ERROR_UNKNOWN"))}}))}}onShow(){Or.error("")}clearBackground(){Or.enabled&&Ms.request("ClearUserBackground",(()=>{Or.name(""),Or.hash("")}))}}class SettingsMenuUserView extends AbstractViewLeft{constructor(e){super(),this.menu=e.menu}link(e){return te(e)}backToInbox(){hasher.setHash(((e="INBOX")=>"#/mailbox/"+e)($t()))}}class SettingsPaneUserView extends AbstractViewRight{constructor(){super(),this.leftPanelDisabled=x,this.toggleLeftPanel=N}onShow(){Nt.message(null)}onBuild(e){e.addEventListener("click",(()=>Ue.isMobile()&&!event.target.closestWithin(".toggleLeft",e)&&x(!0)))}}class SettingsUserScreen extends AbstractSettingsScreen{constructor(){super([SettingsMenuUserView,SettingsPaneUserView,SystemDropDownUserView]);const e=[UserSettingsGeneral];xt.allowContacts()&&e.push(UserSettingsContacts),(L("AdditionalAccounts")||L("Identities"))&&e.push(UserSettingsAccounts),L("Sieve")&&e.push(UserSettingsFilters),e.push(UserSettingsSecurity),e.push(UserSettingsFolders),L("Themes")&&e.push(UserSettingsThemes),e.forEach(((e,t)=>xr(e,e.name.replace("User",""),e!==UserSettingsAccounts||L("AdditionalAccounts")?0:"SETTINGS_ACCOUNTS/LEGEND_IDENTITIES",0,0===t))),(!1?Dr:Nr).forEach((e=>xr(...e))),ge((()=>this.sSettingsTitle=he("TITLES/SETTINGS")),(()=>this.setSettingsTitle()))}onShow(){this.setSettingsTitle(),K(i)}setSettingsTitle(){const e=xs.email();rl.setTitle((e?e+" - ":"")+this.sSettingsTitle)}}class SelectComponent{constructor(e){this.value=e.value,this.label=e.label,this.trigger=e.trigger?.subscribe?e.trigger:null,this.placeholder=e.placeholder,this.options=e.options,this.optionsText=e.optionsText,this.optionsValue=e.optionsValue;let t=0<e.size?"span"+e.size:"";if(this.trigger){const e=ko.observable(""),s=t=>{switch(t){case n:e("success");break;case l:e("error");break;default:e("")}};s(this.trigger()),this.className=we((()=>(t+" settings-save-trigger-input "+e()).trim())),this.disposables=[this.trigger.subscribe(s,this),this.className]}else this.className=t;this.defaultOptionsAfterRender=b}dispose(){this.disposables?.forEach(Ae)}}class CheckboxComponent{constructor(e={}){this.name=e.name,this.value=ko.isObservable(e.value)?e.value:ko.observable(!!e.value),this.enable=ko.isObservable(e.enable)?e.enable:ko.observable(void 0===e.enable||!!e.enable),this.label=e.label}click(){this.enable()&&this.value(!this.value())}}class AbstractApp{constructor(e){this.Remote=e}logoutReload(e){e=e||(W()?$():G),location.href!==e?setTimeout((()=>location.href=e),100):rl.route.reload()}bootstart(){const e=(e,t)=>ko.components.register(e,{template:{element:t.name},viewModel:{createViewModel:(e,s)=>(e=e||{},ue(s.element),new t(e))}});e("Select",SelectComponent),e("Checkbox",CheckboxComponent),ge(),ie.populate(),Ve(),this.start()}}var _r;_r=new class AppUser extends AbstractApp{constructor(){super(Ms);const e=36e5;let t=Date.now();setInterval((()=>{const s=Date.now();s>t+e+1e3&&Ms.request("Version",(e=>100<e&&location.reload()),{version:F.app("version")}),t=s}),e),q(k,["keydown","keyup"],(e=>C.toggle("rl-ctrl-key-pressed",e.ctrlKey)).debounce(500)),U("escape,enter","",Xs),addEventListener("click",Xs),this.folderList=es.folderList,this.messageList=Gs}moveMessagesToFolderType(e,t,s,i){let r=null,a=0;switch(e){case Me.Junk:r=Yt(es.spamFolder()),a=e,i=i||Kt===es.spamFolder();break;case Me.Inbox:r=Yt($t());break;case Me.Trash:r=Yt(es.trashFolder()),a=e,i=i||Kt===es.trashFolder()||t===es.spamFolder()||t===es.trashFolder();break;case Me.Archive:r=Yt(es.archiveFolder()),a=e,i=i||Kt===es.archiveFolder()}r||i?i?Mt(AskPopupView,[he("POPUPS_ASK/DESC_WANT_DELETE_MESSAGES"),()=>{vi(t,s),Gs.removeMessagesFromList(t,s)}]):r&&(yi(t,r.fullName,s),Gs.removeMessagesFromList(t,s,r.fullName)):Mt(FolderSystemPopupView,[a])}accountsAndIdentities(){xs.loading(!0),Ui.loading(!0),Ms.request("AccountsAndIdentities",((e,t)=>{if(xs.loading(!1),Ui.loading(!1),!e){let e=t.Result.Accounts;xs(d(e)?e.map((e=>new AccountModel(e.email,e.name))):[]),xs.unshift(new AccountModel(M("mainEmail"),"",!1)),e=t.Result.Identities,Ui(d(e)?e.map((e=>IdentityModel.reviveFromJson(e))):[])}}))}folderInformation(e,t){gi(e,t)}logout(){Ms.request("Logout",(()=>rl.logoutReload(F.app("customLogoutLink"))))}bootstart(){super.bootstart(),addEventListener("beforeunload",(e=>{if(Lt()||!He.usePreviewPane()&&Nt.message())return e.preventDefault(),e.returnValue=he("POPUPS_ASK/EXIT_ARE_YOU_SURE")}),{capture:!0})}refresh(){Ve(),ie.language(M("language")),this.start()}start(){M("Auth")?(rl.setTitle(he("GLOBAL/LOADING")),Ht.notifications(!!M("SoundNotification")),qs.enabled(!!M("DesktopNotifications")),xs.email(M("Email")),He.init(),_i.init(),Mi((e=>{try{e?(Pt([MailBoxUserScreen,SettingsUserScreen]),ui(f(M("CheckMailInterval"))),_i.init(),this.accountsAndIdentities(),setTimeout((()=>{const e=es.currentFolderFullName();$t()===e||gi(e),es.hasCapability("LIST-STATUS")||fi(!0)}),1e3),setTimeout((()=>Ms.request("AppDelayStart")),35e3),q(k,["touchstart","mousemove","keydown"],He.delayLogout,{passive:!0}),He.delayLogout(),setTimeout((()=>{const e=A("rl-left"),t=()=>ri(e,4,Ue.isMobile()||x()?0:"Width");e&&(t(),x.subscribe(t))}),1),setInterval(k.querySelectorAll("time").forEach((e=>me(e))),6e4),Qi.init(),setTimeout((()=>si(M("mailToEmail"))),500),navigator.registerProtocolHandler?.("mailto",location.protocol+"//"+location.host+location.pathname+"?mailto&to=%s",M("title")||"SnappyMail")):this.logout()}catch(e){}}))):Pt([LoginUserScreen])}showMessageComposer(e=[]){Mt(ComposePopupView,e)}},rl.app=_r,rl.logoutReload=_r.logoutReload,rl.i18n=he,rl.Enums={StorageResultType:{Success:0,Error:1,Abort:2}},rl.route={root:()=>{rl.route.off(),hasher.setHash(j)},reload:()=>{rl.route.root(),setTimeout((()=>location.reload()),100)},off:()=>hasher.active=!1,on:()=>hasher.active=!0}}();
